<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>擬真語音互動測驗：Unlocking the Power of Flight: How Jet Engines Work (Firebase Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Confetti Library for Celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: #f9fafb; /* Light background */
            color: #111827; /* Dark text */
        }
        
        /* Smooth Highlighting for Karaoke Mode */
        .highlight-text {
            background-color: #fef08a; /* yellow-200 */
            color: #854d0e; /* yellow-800 */
            padding: 2px 4px;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(234, 179, 8, 0.5);
            transition: all 0.3s ease;
            font-weight: 700;
        }
        
        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
            background-color: #ffffff; 
        }
        .quiz-option:hover:not(.disabled) {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .quiz-option.correct {
            background-color: #dcfce7 !important; /* green-100 */
            border-color: #16a34a !important;
            color: #166534;
        }
        .quiz-option.wrong {
            background-color: #fee2e2 !important; /* red-100 */
            border-color: #dc2626 !important;
            color: #991b1b;
            opacity: 0.9;
        }
        .quiz-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .explanation-box {
            display: none; /* Hidden by default */
            margin-top: 15px;
            font-size: 1.3em; /* Increased for better readability */
            color: #374151;
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2563eb; /* Blue border */
            animation: slideDown 0.3s ease-out;
            line-height: 1.6;
            border: 1px solid #e5e7eb;
            border-left-width: 4px;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Interactive Vocabulary Styles */
        .vocab-word {
            border-bottom: 2px dotted #2563eb;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            color: #2563eb;
            font-weight: 500;
        }
        .vocab-word:hover {
            background-color: #dbeafe;
            color: #1e3a8a;
        }
        .vocab-word:active {
            transform: scale(0.95);
        }

        /* Tooltip Style - Enhanced for interactivity */
        .vocab-tooltip {
            visibility: hidden;
            width: max-content;
            min-width: 240px; 
            max-width: 320px;
            background-color: #ffffff; 
            color: #1f2937;
            text-align: left;
            border-radius: 8px;
            padding: 16px; 
            position: absolute;
            z-index: 100;
            bottom: 140%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            font-size: 1.1rem; 
            pointer-events: none; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            line-height: 1.5;
            border: 1px solid #e5e7eb;
        }
        
        .vocab-word:hover .vocab-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
            pointer-events: auto; 
        }

        .vocab-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #ffffff transparent transparent transparent;
            filter: drop-shadow(0 2px 1px rgba(0,0,0,0.05));
        }
        
        .pos-tag {
            font-size: 0.75em;
            text-transform: uppercase;
            background-color: #e0e7ff;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            font-weight: bold;
            color: #3730a3;
            display: inline-block;
            margin-bottom: 4px;
        }

        /* Translation Text Style */
        .translation-text {
            display: block;
            font-size: 0.95em;
            color: #4b5563;
            margin-top: 6px;
            margin-bottom: 16px;
            padding-left: 10px;
            border-left: 3px solid #9ca3af;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .translation-text.hidden {
            display: none;
        }
        
        /* Audio Wave Animation */
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 20px;
            gap: 2px;
        }
        .bar {
            width: 4px;
            background: #60a5fa;
            animation: bounce 0ms infinite ease-in-out alternate;
        }
        .playing .bar {
            animation-duration: 400ms;
        }
        .playing .bar:nth-child(1) { animation-delay: -0.2s; }
        .playing .bar:nth-child(2) { animation-delay: -0.4s; }
        .playing .bar:nth-child(3) { animation-delay: -0.6s; }
        .playing .bar:nth-child(4) { animation-delay: -0.8s; }
        @keyframes bounce {
            0% { height: 3px; opacity: 0.5; }
            100% { height: 20px; opacity: 1; }
        }
        
        .hidden-content {
            filter: blur(8px);
            user-select: none;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative;
            color: #111827;
            border: 1px solid #e5e7eb;
        }

        /* Login Modal Specific */
        #login-modal {
            display: flex; /* Initially visible */
            z-index: 2000;
        }
        #login-modal .modal-content {
            max-width: 500px;
            text-align: center;
            padding: 40px;
        }

        /* Status Dot Styles */
        .status-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-left: 0;
            transition: all 0.3s ease; 
        }
        /* Dynamic Border Colors for Container */
        .status-container.loading {
            border-color: #fbbf24;
            box-shadow: 0 0 5px rgba(251, 191, 36, 0.4);
        }
        .status-container.success {
            border-color: #34d399;
            box-shadow: 0 0 5px rgba(52, 211, 153, 0.4);
        }
        .status-container.error {
            border-color: #f87171;
            box-shadow: 0 0 5px rgba(248, 113, 113, 0.4);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.loading { background-color: #fbbf24; box-shadow: 0 0 8px #fbbf24; animation: pulse 1.5s infinite; }
        .status-dot.success { background-color: #34d399; box-shadow: 0 0 8px #34d399; }
        .status-dot.error { background-color: #f87171; box-shadow: 0 0 8px #f87171; }
        .status-text { font-size: 0.75rem; color: #e5e7eb; font-weight: 500; }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* Action Buttons */
        .action-btn {
            background-color: #ffffff;
            color: #2563eb; 
            border: 1px solid #2563eb;
            transition: all 0.2s ease-in-out;
            font-weight: bold;
        }
        .action-btn:hover {
            background-color: #2563eb;
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-btn:active {
            transform: translateY(0);
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
                color: black;
                background: white;
            }
            #print-area, #print-area * {
                visibility: visible;
                color: black;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }
            @page {
                size: A4 portrait;
                margin: 2cm;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-12 text-gray-900">

    <!-- Navbar / Audio Player Sticky Header (Keep dark for contrast) -->
    <div class="sticky top-0 z-50 bg-slate-900 text-white shadow-lg transition-all duration-300 no-print" id="audio-player-bar">
        <!-- Adjusted width for iPad/Widescreen -->
        <div class="w-[95%] max-w-[1800px] mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                
                <!-- Left: Title, User, Badges -->
                <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                    <!-- Icon -->
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white shadow-lg shrink-0">
                            <i class="fas fa-cogs text-lg"></i>
                        </div>
                        
                        <!-- Info Column -->
                        <div class="flex flex-col gap-1">
                            
                            <!-- Top Row: User Name & Status -->
                            <div class="flex items-center gap-3">
                                <!-- User Name -->
                                <div id="header-username" class="text-sm font-bold text-blue-200 flex items-center gap-2">
                                    <i class="fas fa-user-circle"></i> <span>Guest</span>
                                </div>
                                <!-- Firebase Status Indicator -->
                                <div class="status-container" id="cloud-status">
                                    <span class="status-dot loading"></span>
                                    <span class="status-text">連線中...</span>
                                </div>
                            </div>

                            <!-- Bottom Row: Badges -->
                            <div class="flex items-center gap-2 flex-wrap">
                                <!-- Level Badge -->
                                <div class="flex items-center gap-1 px-2 py-0.5 rounded border border-yellow-500/50 text-yellow-300 text-[10px] md:text-xs font-bold bg-yellow-900/30 whitespace-nowrap">
                                    <i class="fas fa-layer-group"></i>
                                    <span>Level: CEFR B2</span>
                                </div>
                                <!-- Word Count Badge -->
                                <div class="flex items-center gap-1 px-2 py-0.5 rounded border border-cyan-500/50 text-cyan-300 text-[10px] md:text-xs font-bold bg-cyan-900/30 whitespace-nowrap">
                                    <i class="fas fa-file-word"></i>
                                    <span>Words: ~750</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Play Button (Right aligned on mobile) -->
                    <button onclick="window.togglePlay()" class="md:hidden w-10 h-10 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-500 transition shrink-0 ml-auto">
                        <i class="fas fa-play" id="mobile-play-icon"></i>
                    </button>
                </div>

                <!-- Center: Controls -->
                <div class="flex items-center gap-4 hidden md:flex">
                    <!-- Rewind -->
                    <button onclick="window.restartAudio()" class="w-10 h-10 rounded-full border border-slate-600 text-slate-300 hover:bg-slate-700 flex items-center justify-center transition" title="Restart">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    
                    <!-- Main Play Button -->
                    <button onclick="window.togglePlay()" class="w-12 h-12 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition hover:bg-blue-500">
                        <i class="fas fa-play text-xl ml-1" id="main-play-icon"></i>
                    </button>

                    <!-- Visualizer -->
                    <div class="equalizer" id="visualizer">
                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                    </div>
                </div>

                <!-- Right: Settings -->
                <div class="flex items-center gap-3 text-sm w-full md:w-auto justify-center md:justify-end border-t border-slate-700 md:border-t-0 pt-2 md:pt-0 mt-2 md:mt-0">
                    
                    <!-- Translation Toggle -->
                    <button onclick="window.toggleTranslation()" id="toggle-trans-btn" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-green-400 px-3 py-1.5 rounded-lg font-bold transition border border-slate-600">
                        <i class="fas fa-language"></i> <span>翻譯</span>
                    </button>

                    <!-- Toggle Text -->
                    <button onclick="window.toggleText()" id="toggle-text-btn" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-amber-400 px-3 py-1.5 rounded-lg font-bold transition border border-slate-600">
                        <i class="fas fa-eye-slash"></i> <span>Hide Text</span>
                    </button>
                    
                    <!-- Logout -->
                    <button onclick="window.location.reload()" title="登出 / 切換使用者" class="w-10 h-10 rounded-lg border border-red-500/50 text-red-400 hover:bg-red-900/20 flex items-center justify-center transition ml-1">
                        <i class="fas fa-sign-out-alt text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Progress Bar -->
        <div class="w-full bg-slate-800 h-1.5 no-print">
            <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <!-- Main Content -->
    <!-- Adjusted width for iPad/Widescreen -->
    <div class="w-[95%] max-w-[1800px] mx-auto p-4 md:p-6 space-y-8 no-print">
        
        <!-- Image Card -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
             <!-- Image with fallback -->
             <div class="w-full h-64 md:h-96 bg-gray-100 relative overflow-hidden group">
                <img 
                    src="English-Reading-122-images/p0.jpg" 
                    alt="Unlocking the Power of Flight: How Jet Engines Work" 
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1542461927-410e31379f04?q=80&w=1200&auto=format&fit=crop';"
                >
                
                <!-- Gradient Overlay -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent pointer-events-none"></div>

                <div class="absolute bottom-6 left-6 right-6 text-white">
                    <div class="flex items-center gap-2 text-sm font-medium bg-black/60 w-fit px-4 py-2 rounded-full backdrop-blur-sm border border-white/20">
                        <i class="fas fa-search-location"></i> Listening Focus: Engineering, Physics & Aviation
                    </div>
                </div>
            </div>
        </div>

        <!-- Vocabulary Tools Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="window.openVocabModal()" class="bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:border-blue-500 hover:shadow-lg transition flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-900 text-lg">完整單字表 (Vocabulary)</h3>
                        <p class="text-sm text-gray-500">查看所有單字與例句</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400 group-hover:text-blue-500"></i>
            </button>

            <button onclick="window.openStudyModal()" class="bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:border-pink-500 hover:shadow-lg transition flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-pink-50 text-pink-600 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-900 text-lg">我的學習清單 (Favorites)</h3>
                        <p class="text-sm text-gray-500" id="study-list-count">目前收藏: 0 個單字</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400 group-hover:text-pink-500"></i>
            </button>
        </div>

        <!-- Text Content Area -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-200 relative">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 pb-4 border-b border-gray-200">Unlocking the Power of Flight: How Jet Engines Work</h2>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8 text-sm text-gray-700 rounded-r-lg">
                <i class="fas fa-mouse-pointer mr-1 text-blue-600"></i> <strong>Tip:</strong> 點擊單字聽發音，點擊 ❤️ 加入學習清單。
            </div>

            <!-- Hidden Message Overlay -->
            <div id="hidden-overlay" class="hidden absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center rounded-2xl backdrop-blur-sm transition-all">
                <div class="bg-white p-6 rounded-full mb-4 border border-gray-200 shadow-xl">
                    <i class="fas fa-ear-listen text-4xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Listen Carefully</h3>
                <p class="text-gray-500 mb-6 text-center max-w-sm">The text is hidden to challenge your listening skills. Try to answer the questions by listening only!</p>
                <button onclick="window.toggleText()" class="bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700 transition shadow-lg font-bold">
                    Show Text
                </button>
            </div>

            <!-- Article Container -->
            <!-- Font size increased to text-xl md:text-2xl -->
            <div id="article-display" class="prose max-w-none text-gray-700 text-xl md:text-2xl leading-loose tracking-wide space-y-8 font-serif md:font-sans">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- Quiz Area -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-200 relative">
            
            <!-- Quiz Header with Restart Button -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 border-b border-gray-200 pb-4">
                <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                    <span class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center mr-3 text-base">
                        <i class="fas fa-pen"></i>
                    </span>
                    Reading Comprehension Quiz (15 Questions)
                </h3>
                
                <!-- Restart Button -->
                <button onclick="window.resetQuiz()" class="action-btn px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                    <i class="fas fa-redo-alt"></i> 重新開始 (Restart)
                </button>
            </div>
            
            <form id="quizForm" class="space-y-10">
                <!-- Questions will be generated here -->
            </form>

            <div class="mt-10 pt-8 border-t border-gray-200 flex flex-col items-center gap-4">
                <button type="button" onclick="window.showFinalScore()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-3 px-12 rounded-full shadow-xl transition transform hover:-translate-y-1 active:scale-95">
                    Show Final Score
                </button>
                
                <div id="score-card" class="hidden mt-6 text-center w-full bg-slate-50 p-8 rounded-2xl border border-slate-200 animate-fade-in relative shadow-inner">
                    <p class="text-gray-500 text-sm uppercase font-bold tracking-wider">Your Result</p>
                    <div class="text-6xl font-extrabold text-blue-600 my-4" id="final-score">0</div>
                    <p id="feedback-msg" class="text-gray-700 font-medium mb-6 text-lg"></p>
                    
                    <button id="mistake-review-btn" onclick="window.openMistakeModal()" class="hidden w-full md:w-auto bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold shadow-md transition flex items-center justify-center gap-2 mx-auto">
                        <i class="fas fa-book-dead"></i> 查看錯題本 (Review Mistakes)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal (New) -->
    <div id="login-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col items-center justify-center gap-6 shadow-2xl border-0">
            <div class="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mb-2 shadow-sm">
                <i class="fas fa-user-astronaut text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-900">歡迎來到英語閱讀挑戰</h2>
            <p class="text-gray-500 text-base mb-2">請輸入名字以儲存您的學習進度</p>
            
            <div class="w-full space-y-4 max-w-xs">
                <input type="text" id="username-input" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-3 text-gray-900 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-center text-lg transition" placeholder="輸入您的名字 (Enter Name)">
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    開始閱讀 (Start)
                </button>
            </div>

            <div class="w-full border-t border-gray-200 pt-6 mt-4">
                <p class="text-xs text-gray-400 uppercase font-bold mb-4 tracking-wider">快速登入 (Quick Login)</p>
                <div id="quick-login-area" class="flex flex-wrap gap-2 justify-center">
                    <span class="text-sm text-gray-400">載入挑戰者名單中...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Vocabulary Modal -->
    <div id="vocab-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h3 class="text-2xl font-bold text-gray-900"><i class="fas fa-book-open text-blue-600 mr-2"></i> 完整單字表</h3>
                <button onclick="window.closeModal('vocab-modal')" class="text-gray-400 hover:text-gray-600 transition p-2 rounded-full hover:bg-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-white" id="vocab-table-container"></div>
            <div class="p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('vocab')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold shadow-sm transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印單字表 (A4)
                </button>
                <button onclick="window.closeModal('vocab-modal')" class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Study List Modal -->
    <div id="study-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h3 class="text-2xl font-bold text-gray-900"><i class="fas fa-heart text-pink-500 mr-2"></i> 我的學習清單</h3>
                <button onclick="window.closeModal('study-modal')" class="text-gray-400 hover:text-gray-600 transition p-2 rounded-full hover:bg-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-white" id="study-table-container"></div>
            <div class="p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('study')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold shadow-sm transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印學習清單 (A4)
                </button>
                <button onclick="window.closeModal('study-modal')" class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Mistake Review Modal -->
    <div id="mistake-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-red-50 rounded-t-2xl">
                <h3 class="text-2xl font-bold text-red-700"><i class="fas fa-times-circle text-red-500 mr-2"></i> 錯題本 (Mistakes Review)</h3>
                <button onclick="window.closeModal('mistake-modal')" class="text-gray-400 hover:text-gray-600 transition p-2 rounded-full hover:bg-red-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-white" id="mistake-table-container"></div>
            <div class="p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('mistakes')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold shadow-sm transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印錯題本 (A4)
                </button>
                <button onclick="window.closeModal('mistake-modal')" class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <!-- Firebase & App Logic Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, deleteField } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- Configuration ---
        const COLLECTION_NAME = 'English-Reading-122';
        const DOC_GLOBAL = 'global';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCan2_Rc26HsLkOPr0i5QrgdjAYyqcigJ0",
            authDomain: "english-reading-6b506.firebaseapp.com",
            projectId: "english-reading-6b506",
            storageBucket: "english-reading-6b506.firebasestorage.app",
            messagingSenderId: "494747176273",
            appId: "1:494747176273:web:585487fadb29b2e5e2d770",
            measurementId: "G-4JD6R9MRPQ"
        };

        let app, db, auth;
        let isFirebaseReady = false;
        let currentUser = null; // Store current user info {name: string}
        let unsubscribeUser = null; // Listener for specific user data

        // --- Firebase Initialization ---
        async function initFirebase() {
            try {
                updateConnectionStatus('loading', '讀取資料中...');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                
                isFirebaseReady = true;
                console.log("Firebase Connected");
                
                // Listen to Global Users List for Quick Login
                onSnapshot(doc(db, COLLECTION_NAME, DOC_GLOBAL), (docSnap) => {
                    const data = docSnap.exists() ? docSnap.data() : { users: [] };
                    renderQuickLogin(data.users || []);
                }, (error) => {
                    console.error("Global listener error:", error);
                    updateConnectionStatus('error', '雲端同步失敗');
                });

            } catch (e) {
                console.error("Firebase init error:", e);
                updateConnectionStatus('error', '連線錯誤');
            }
        }

        // --- User Logic ---
        window.startLogin = async (name) => {
            if (!name || !isFirebaseReady) return;
            const cleanName = name.trim();
            if (cleanName.length === 0) return;

            currentUser = { name: cleanName };
            document.getElementById('login-modal').style.display = 'none';
            
            // Update Header Name
            document.getElementById('header-username').innerHTML = `<i class="fas fa-user-circle"></i> <span>${cleanName}</span>`;

            // Register user in Global List (if new)
            try {
                const globalRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                await setDoc(globalRef, {
                    users: arrayUnion({ name: cleanName })
                }, { merge: true });

                subscribeToUserData(cleanName);
            } catch (e) {
                console.error("Login save error:", e);
            }
        };

        function subscribeToUserData(userName) {
            if (unsubscribeUser) unsubscribeUser();
            
            const userDocRef = doc(db, COLLECTION_NAME, `user_${userName}`);
            
            unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                updateConnectionStatus('success', '已同步');
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. Restore Favorites
                    if (data.favorites) {
                        favoriteWords = new Set(data.favorites);
                        document.getElementById('study-list-count').innerText = `目前收藏: ${favoriteWords.size} 個單字`;
                        // Re-render open modals if needed
                        if(document.getElementById('study-modal').style.display === 'flex') window.openStudyModal();
                        if(document.getElementById('vocab-modal').style.display === 'flex') window.openVocabModal();
                    }

                    // 2. Restore Progress
                    if (data.progressIndex !== undefined && data.progressIndex > 0) {
                        // Only update if playing is false to avoid jumping while listening
                        if (!isPlaying && data.progressIndex > currentSentenceIndex) {
                            currentSentenceIndex = data.progressIndex;
                            window.updateProgressBar();
                            window.highlightSentence(currentSentenceIndex);
                        }
                    }

                    // 3. Restore Quiz Answers & State
                    if (data.quizAnswers) {
                         const serverAnswers = data.quizAnswers;
                         
                         // Reset local quiz state before rebuilding
                         userScore = 0;
                         wrongAnswers = [];
                         userAnswers = serverAnswers;
                         
                         Object.keys(serverAnswers).forEach(qid => {
                             const ans = serverAnswers[qid];
                             const qObj = quizData.find(q => q.id === qid);
                             
                             if(qObj) {
                                 if(ans === qObj.ans) userScore += (100/15);
                                 else wrongAnswers.push({q: qObj, yourAns: ans});
                             }

                             const alreadyAnswered = document.querySelector(`#${qid}-options input:disabled`);
                             if (!alreadyAnswered) {
                                 window.checkAnswer(qid, ans, true); // true = isRestoring
                             }
                         });
                    }
                }
            }, (error) => {
                console.error("User listener error:", error);
                updateConnectionStatus('error', '同步失敗');
            });
        }

        // Exposed function to save data
        window.saveUserData = async () => {
            if (!currentUser || !isFirebaseReady) return;
            updateConnectionStatus('loading', '同步中...');
            
            try {
                const userDocRef = doc(db, COLLECTION_NAME, `user_${currentUser.name}`);
                await setDoc(userDocRef, {
                    favorites: Array.from(favoriteWords),
                    mistakes: wrongAnswers,
                    progressIndex: currentSentenceIndex,
                    quizAnswers: userAnswers, // Save the map of answers
                    lastUpdated: new Date()
                }, { merge: true });
            } catch (e) {
                console.error("Save error:", e);
                updateConnectionStatus('error', '存檔失敗');
            }
        };

        // Reset Quiz Data
        window.resetQuiz = async () => {
            if(!confirm("確定要重新開始測驗嗎？這將會清除您的作答紀錄與分數。(Are you sure you want to restart the quiz?)")) return;
            
            userScore = 0;
            wrongAnswers = [];
            userAnswers = {};
            
            document.querySelectorAll('.quiz-option').forEach(el => {
                el.classList.remove('correct', 'wrong', 'disabled');
            });
            document.querySelectorAll('.quiz-option input').forEach(el => {
                el.disabled = false;
                el.checked = false;
            });
            document.querySelectorAll('.quiz-option div').forEach(el => {
                const key = el.id.split('-').pop(); // get A, B, C...
                el.className = "w-10 h-10 rounded-full border-2 border-gray-400 flex items-center justify-center mr-4 font-bold text-gray-500 transition-colors bg-white";
                el.innerHTML = key;
            });
            document.querySelectorAll('.explanation-box').forEach(el => el.style.display = 'none');
            document.getElementById('final-score').innerText = "0";
            document.getElementById('score-card').classList.add('hidden');

            if (currentUser && isFirebaseReady) {
                 const userDocRef = doc(db, COLLECTION_NAME, `user_${currentUser.name}`);
                 await updateDoc(userDocRef, {
                     quizAnswers: deleteField(),
                     mistakes: deleteField()
                 });
            }
            
            window.scrollTo({ top: document.getElementById('quizForm').offsetTop - 100, behavior: 'smooth' });
        }

        function renderQuickLogin(users) {
            const container = document.getElementById('quick-login-area');
            container.innerHTML = '';
            
            if (!users || users.length === 0) {
                container.innerHTML = '<span class="text-sm text-gray-400 py-2">尚無挑戰者紀錄，歡迎加入！</span>';
                return;
            }

            const recentUsers = users.slice().reverse().slice(0, 5); 
            
            recentUsers.forEach(u => {
                const btn = document.createElement('button');
                btn.className = "bg-white hover:bg-blue-50 text-blue-600 border border-blue-200 px-4 py-2 rounded-full text-sm transition shadow-sm";
                btn.innerText = u.name;
                btn.onclick = () => {
                    document.getElementById('username-input').value = u.name;
                    window.startLogin(u.name);
                };
                container.appendChild(btn);
            });
        }

        function updateConnectionStatus(status, text) {
            const container = document.getElementById('cloud-status');
            const dot = container.querySelector('.status-dot');
            const label = container.querySelector('.status-text');
            
            dot.className = 'status-dot'; // reset
            dot.classList.add(status); // loading, success, error
            label.innerText = text;

            container.className = 'status-container'; // reset
            container.classList.add(status);
        }

        document.getElementById('login-btn').onclick = () => {
            const name = document.getElementById('username-input').value;
            window.startLogin(name);
        };
        
        initFirebase();


        // ---------------------------------------------------------
        // --- Existing App Logic (Attached to Window) ---
        // ---------------------------------------------------------
        
        let synth = window.speechSynthesis;
        let sentences = [];
        let currentSentenceIndex = 0;
        let isPlaying = false;
        let textHidden = false;
        let showTranslation = false;
        let selectedVoice = null;
        let userScore = 0;
        let favoriteWords = new Set();
        let wrongAnswers = []; 
        let userAnswers = {}; // Store { qID: "Answer" }
        let audioCtx;

        const vocabulary = {
            "propel": { pos: "v.", trans: "推動；驅策", example: "The wind helped propel the boat forward." },
            "principle": { pos: "n.", trans: "原理；原則", example: "The machine works on the principle of gravity." },
            "fuselage": { pos: "n.", trans: "機身", example: "The passengers sit inside the aircraft's fuselage." },
            "sustain": { pos: "v.", trans: "維持；支撐", example: "Food and water are needed to sustain life." },
            "compress": { pos: "v.", trans: "壓縮", example: "The machine will compress the trash into a small cube." },
            "intake": { pos: "n.", trans: "吸入；進氣口", example: "The jet's air intake must be kept clear of birds." },
            "combustion": { pos: "n.", trans: "燃燒", example: "Internal combustion engines power most cars." },
            "chamber": { pos: "n.", trans: "室；腔", example: "The bullet was loaded into the firing chamber." },
            "ignite": { pos: "v.", trans: "點燃", example: "You need a match to ignite the campfire." },
            "thrust": { pos: "n.", trans: "推力", example: "The rocket needs immense thrust to escape Earth." },
            "exhaust": { pos: "n.", trans: "廢氣；排氣", example: "Carbon monoxide is found in car exhaust." },
            "turbine": { pos: "n.", trans: "渦輪機", example: "The wind turbine generates electricity." },
            "velocity": { pos: "n.", trans: "速度", example: "Light travels at an incredible velocity." },
            "efficient": { pos: "adj.", trans: "有效率的", example: "LED bulbs are more efficient than old ones." },
            "evolution": { pos: "n.", trans: "演變；進化", example: "The evolution of computers has been rapid." },
            "bypass": { pos: "v./n.", trans: "繞過；旁通", example: "We took a road to bypass the city traffic." },
            "dramatically": { pos: "adv.", trans: "劇烈地；戲劇性地", example: "Prices have risen dramatically this year." },
            "generate": { pos: "v.", trans: "產生", example: "Solar panels generate power from the sun." },
            "continuous": { pos: "adj.", trans: "連續的", example: "The rain was continuous for three days." },
            "expand": { pos: "v.", trans: "膨脹；擴大", example: "Heat causes metals to expand." },
            "nozzle": { pos: "n.", trans: "噴嘴", example: "Water sprayed from the hose nozzle." },
            "execution": { pos: "n.", trans: "執行；實行", example: "The plan was good, but the execution was poor." },
            "fundamental": { pos: "adj.", trans: "基礎的；根本的", example: "Trust is fundamental to a relationship." },
            "reaction": { pos: "n.", trans: "反作用力；反應", example: "His quick reaction saved him from falling." },
            "opposite": { pos: "adj.", trans: "相反的", example: "North is opposite to South." },
            "blade": { pos: "n.", trans: "葉片；刀片", example: "The helicopter blade spun rapidly." },
            "shaft": { pos: "n.", trans: "軸；桿", example: "The propeller is attached to the drive shaft." },
            "progressively": { pos: "adv.", trans: "逐漸地", example: "The test got progressively harder." },
            "explosive": { pos: "adj.", trans: "爆炸性的", example: "Handle the explosive materials with care." },
            "mixture": { pos: "n.", trans: "混合物", example: "Concrete is a mixture of sand and cement." },
            "spray": { pos: "v.", trans: "噴灑", example: "She used a bottle to spray water on the plants." },
            "motion": { pos: "n.", trans: "運動；動作", example: "The rocking motion of the boat made me sick." },
            "accelerate": { pos: "v.", trans: "加速", example: "The car began to accelerate down the highway." },
            "drag": { pos: "n.", trans: "阻力", example: "Aerodynamic design reduces air drag." },
            "emission": { pos: "n.", trans: "排放（物）", example: "Factories must reduce harmful gas emissions." },
            "hybrid": { pos: "adj./n.", trans: "混合的", example: "A hybrid car uses both gas and electricity." },
            "sustainable": { pos: "adj.", trans: "永續的", example: "We need to find sustainable energy sources." },
            "miracle": { pos: "n.", trans: "奇蹟", example: "Her recovery from the illness was a miracle." },
            "sophisticated": { pos: "adj.", trans: "精密的；複雜的", example: "Modern engines are highly sophisticated." },
            "atmosphere": { pos: "n.", trans: "大氣層", example: "The rocket broke through the atmosphere." }
        };

        const articleData = [
            // Paragraph 1
            { en: "Every day, millions of people travel across the globe, soaring 35,000 feet above the ground at speeds that would have seemed impossible just a century ago.", zh: "每天，數百萬人穿越全球，在離地 35,000 英尺的高空翱翔，其速度在一個世紀前似乎是不可能的。" },
            { en: "The soundtrack to this modern miracle is the deep, steady roar of the jet engine.", zh: "這現代奇蹟的背景音是噴射引擎深沉、穩定的轟鳴聲。" },
            { en: "Whether attached to the wings of a massive passenger airliner or buried within the fuselage of a supersonic fighter jet, these machines are marvels of engineering.", zh: "無論是安裝在巨大客機的機翼上，還是埋在超音速戰鬥機的機身內，這些機器都是工程學的奇蹟。" },
            { en: "At their core, jet engines are remarkably simple in principle, yet incredibly complex in execution.", zh: "就核心而言，噴射引擎的原理非常簡單，但執行起來卻極其複雜。" },
            { en: "They rely on a fundamental law of physics discovered by Sir Isaac Newton over 300 years ago: for every action, there is an equal and opposite reaction.", zh: "它們依賴艾薩克·牛頓爵士在 300 多年前發現的一條物理學基本定律：每一個作用力都有一個大小相等、方向相反的反作用力。" },
            { en: "Just as releasing a blown-up balloon causes it to fly forward as air rushes backward, a jet engine propels an aircraft forward by shooting a high-speed stream of gas backward.", zh: "就像釋放一個充氣的氣球會導致它隨著空氣向後衝出而向前飛一樣，噴射引擎藉由向後噴射高速氣流來推動飛機前進。" },
            { en: "To understand this process, pilots and engineers often use a simple four-word phrase: Suck, Squeeze, Bang, and Blow.", zh: "為了理解這個過程，飛行員和工程師經常用一個簡單的四字口訣：吸氣、壓縮、爆炸、排氣。" },
            
            // Paragraph 2
            { en: "The journey begins at the front of the engine, often identified by the large spinning fan seen on commercial airplanes.", zh: "旅程始於引擎的前端，通常由商用飛機上可見的巨大旋轉風扇來識別。" },
            { en: "This is the \"Suck\" phase.", zh: "這是「吸氣」階段。" },
            { en: "The massive fan blades act like a giant vacuum cleaner, sucking in enormous quantities of air.", zh: "巨大的風扇葉片就像一個巨型吸塵器，吸入大量的空氣。" },
            { en: "However, not all of this air goes into the engine core.", zh: "然而，並非所有空氣都進入引擎核心。" },
            { en: "In modern engines, much of it flows around the outside, providing cooling and extra thrust; this is known as \"bypass air.\"", zh: "在現代引擎中，大部分空氣從外部流過，提供冷卻和額外的推力；這被稱為「旁通空氣」。" },
            { en: "The air that does enter the core moves into the compressor, which handles the \"Squeeze\" phase.", zh: "確實進入核心的空氣會進入壓縮機，負責「壓縮」階段。" },
            { en: "The compressor consists of a series of spinning blades attached to a shaft, which get progressively smaller.", zh: "壓縮機由一系列連接在軸上的旋轉葉片組成，這些葉片逐漸變小。" },
            { en: "As the air is forced through these narrowing tunnels, it is crushed into a very small space.", zh: "當空氣被迫通過這些變窄的通道時，它被擠壓到一個非常小的空間裡。" },
            { en: "This rapid compression causes the air pressure and temperature to rise dramatically, preparing it for the explosive energy that follows.", zh: "這種快速壓縮導致氣壓和溫度急劇上升，為隨後的爆炸能量做好準備。" },
            
            // Paragraph 3
            { en: "Once the air is highly compressed and extremely hot, it enters the combustion chamber, or the combustor.", zh: "一旦空氣被高度壓縮且極熱，它就會進入燃燒室。" },
            { en: "This leads to the \"Bang\" phase.", zh: "這導致了「爆炸」階段。" },
            { en: "Here, the engine sprays jet fuel (kerosene) into the pressurized air through tiny nozzles.", zh: "在這裡，引擎通過微小的噴嘴將噴射燃料（煤油）噴入加壓空氣中。" },
            { en: "The mixture is then ignited by an electric spark.", zh: "然後，混合物被電火花點燃。" },
            { en: "However, unlike a car engine which has repeated small explosions, the burning in a jet engine is continuous, similar to a blowtorch that never goes out.", zh: "然而，與汽車引擎重複的小爆炸不同，噴射引擎中的燃燒是連續的，類似於永不熄滅的噴燈。" },
            { en: "This controlled explosion generates incredibly high temperatures, reaching up to 2,000 degrees Celsius, and creates a high-energy stream of expanding gas.", zh: "這種受控的爆炸產生極高的溫度，高達攝氏 2,000 度，並產生一股高能量的膨脹氣流。" },
            { en: "The challenge for engineers is to contain this intense heat without melting the engine itself.", zh: "工程師面臨的挑戰是控制這種高熱而不讓引擎本身熔化。" },
            { en: "To solve this, they use advanced materials and cooling holes that allow a thin layer of air to protect the metal walls of the chamber.", zh: "為了解決這個問題，他們使用先進的材料和冷卻孔，允許一層薄薄的空氣保護燃燒室的金屬壁。" },
            
            // Paragraph 4
            { en: "The final step is the \"Blow\" phase.", zh: "最後一步是「排氣」階段。" },
            { en: "The hot, expanding gases rush out of the combustion chamber and pass through the turbine.", zh: "熱的膨脹氣體衝出燃燒室並通過渦輪機。" },
            { en: "The turbine is like a windmill; as the high-speed gas flows over its blades, it causes them to spin.", zh: "渦輪機就像風車；當高速氣體流過其葉片時，會導致它們旋轉。" },
            { en: "Since the turbine is connected by a shaft to the compressor and the fan at the front, this spinning motion is what keeps the entire engine running.", zh: "由於渦輪機通過軸連接到壓縮機和前端的風扇，這種旋轉運動使整個引擎保持運轉。" },
            { en: "After passing through the turbine, the gases shoot out the back of the engine through the exhaust nozzle at incredible velocity.", zh: "通過渦輪機後，氣體以驚人的速度從引擎後部的排氣噴嘴射出。" },
            { en: "According to Newton’s third law of motion, this high-speed exhaust pushing backward creates a powerful force pushing forward.", zh: "根據牛頓第三運動定律，這種向後推的高速廢氣產生了一股強大的向前推力。" },
            { en: "This force is called \"thrust.\"", zh: "這種力量被稱為「推力」。" },
            { en: "It is this continuous stream of thrust that overcomes the drag of the air and the weight of the plane, allowing the aircraft to accelerate down the runway and climb into the sky.", zh: "正是這種連續的推力流克服了空氣阻力和飛機的重量，使飛機能夠在跑道上加速並爬升到天空中。" },
            
            // Paragraph 5
            { en: "While the basic \"Suck, Squeeze, Bang, Blow\" principle remains the same, jet engines have evolved significantly since their invention in the 1930s.", zh: "雖然基本的「吸氣、壓縮、爆炸、排氣」原理保持不變，但噴射引擎自 1930 年代發明以來已經有了顯著的演變。" },
            { en: "Early engines, known as \"turbojets,\" passed all the air through the core, making them loud and fuel-thirsty.", zh: "早期的引擎被稱為「渦輪噴射引擎」，讓所有空氣通過核心，這使它們聲音大且耗油。" },
            { en: "Today, most commercial planes use \"turbofan\" engines.", zh: "今天，大多數商用飛機使用「渦輪風扇引擎」。" },
            { en: "These engines rely heavily on the large fan at the front to push air around the core rather than through it.", zh: "這些引擎主要依賴前端的大風扇將空氣推到核心周圍而不是通過它。" },
            { en: "This bypass air is slower and quieter, but it produces most of the thrust during takeoff and cruising, making the engines much more fuel-efficient and quieter for people on the ground.", zh: "這種旁通空氣速度較慢且較安靜，但在起飛和巡航期間產生大部分推力，使引擎燃油效率更高，且對地面上的人來說更安靜。" },
            { en: "As we look to the future, engineers are experimenting with hybrid-electric systems and sustainable aviation fuels to reduce carbon emissions.", zh: "展望未來，工程師正在試驗混合動力系統和永續航空燃料，以減少碳排放。" },
            { en: "The jet engine has shrunk the world, and its continued evolution promises to keep us flying faster, cleaner, and further than ever before.", zh: "噴射引擎縮小了世界，其持續的演變承諾讓我們飛得比以往任何時候都更快、更乾淨、更遠。" }
        ];

        const quizData = [
            { 
                id: 'q1', 
                q: "1. What fundamental scientific principle allows a jet engine to produce movement?", 
                options: {A: "The theory of general relativity.", B: "Newton’s third law of motion.", C: "The law of conservation of energy.", D: "Archimedes’ principle of buoyancy."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Paragraph 1 states engines rely on Newton’s law: \"for every action, there is an equal and opposite reaction.\"<br><br><strong>Chi:</strong> 第一段指出引擎依賴牛頓定律：「每一個作用力都有一個大小相等、方向相反的反作用力。」" 
            },
            { 
                id: 'q2', 
                q: "2. Which phrase serves as a simple way to remember the four stages of a jet engine?", 
                options: {A: "Spin, Heat, Push, and Glide.", B: "Suck, Squeeze, Bang, and Blow.", C: "Pull, Press, Ignite, and Release.", D: "Lift, Drag, Thrust, and Weight."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Paragraph 1 introduces the phrase: \"Suck, Squeeze, Bang, and Blow.\"<br><br><strong>Chi:</strong> 第一段介紹了這個口訣：「吸氣、壓縮、爆炸、排氣」。" 
            },
            { 
                id: 'q3', 
                q: "3. What is \"bypass air\" mentioned in Paragraph 2?", 
                options: {A: "Air that is trapped inside the combustion chamber.", B: "Air that is used to inflate the tires during landing.", C: "Air that flows around the engine core without entering it.", D: "Air that is compressed to create an explosion."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 2 explains bypass air \"flows around the outside\" of the core.<br><br><strong>Chi:</strong> 第二段解釋旁通空氣在核心「外部流動」。" 
            },
            { 
                id: 'q4', 
                q: "4. What happens to the air inside the compressor?", 
                options: {A: "It cools down and expands rapidly.", B: "It is mixed with water to clean the engine.", C: "It is crushed into a small space, raising pressure and temperature.", D: "It is released immediately through the exhaust."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 2 states air is \"crushed into a very small space,\" causing pressure and temperature to rise.<br><br><strong>Chi:</strong> 第二段指出空氣被「擠壓到一個非常小的空間」，導致壓力和溫度上升。" 
            },
            { 
                id: 'q5', 
                q: "5. How is the combustion in a jet engine different from a car engine?", 
                options: {A: "The burning in a jet engine is continuous, not repeated explosions.", B: "A jet engine uses wood instead of liquid fuel.", C: "A jet engine does not require any spark to start.", D: "A car engine burns much hotter than a jet engine."}, 
                ans: 'A', 
                expl: "<strong>Eng:</strong> Paragraph 3 compares it to a car, stating the burning is \"continuous, similar to a blowtorch.\"<br><br><strong>Chi:</strong> 第三段將其與汽車比較，指出燃燒是「連續的，類似於噴燈」。" 
            },
            { 
                id: 'q6', 
                q: "6. What is the function of the turbine in the \"Blow\" phase?", 
                options: {A: "To cool down the exhaust gases before they leave.", B: "To spin the shaft that powers the compressor and fan.", C: "To filter out pollutants from the fuel.", D: "To stop the engine when the plane lands."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Paragraph 4 explains the turbine spins and is \"connected by a shaft to the compressor and the fan,\" keeping the engine running.<br><br><strong>Chi:</strong> 第四段解釋渦輪機旋轉並「通過軸連接到壓縮機和風扇」，使引擎保持運轉。" 
            },
            { 
                id: 'q7', 
                q: "7. Why do engineers put cooling holes in the combustion chamber walls?", 
                options: {A: "To make the engine lighter and faster.", B: "To protect the metal from melting due to extreme heat.", C: "To allow passengers to hear the engine better.", D: "To let excess fuel drain out safely."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Paragraph 3 states they use cooling holes to \"allow a thin layer of air to protect the metal walls.\"<br><br><strong>Chi:</strong> 第三段指出他們使用冷卻孔來「允許一層薄薄的空氣保護金屬壁」。" 
            },
            { 
                id: 'q8', 
                q: "8. What creates the forward force known as \"thrust\"?", 
                options: {A: "The spinning of the front fan only.", B: "The friction of the air against the wings.", C: "The high-speed exhaust gas shooting backward.", D: "The pilot pushing the throttle lever forward."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 4 states \"this high-speed exhaust pushing backward creates a powerful force pushing forward.\"<br><br><strong>Chi:</strong> 第四段指出「這種向後推的高速廢氣產生了一股強大的向前推力」。" 
            },
            { 
                id: 'q9', 
                q: "9. How does a \"turbofan\" engine differ from an early \"turbojet\" engine?", 
                options: {A: "It pushes air around the core, making it quieter and more efficient.", B: "It uses electricity instead of jet fuel.", C: "It has no moving parts inside.", D: "It is designed only for military fighter jets."}, 
                ans: 'A', 
                expl: "<strong>Eng:</strong> Paragraph 5 explains turbofans push air \"around the core,\" making them \"more fuel-efficient and quieter.\"<br><br><strong>Chi:</strong> 第五段解釋渦輪風扇將空氣推到核心「周圍」，使其「燃油效率更高且更安靜」。" 
            },
            { 
                id: 'q10', 
                q: "10. What is one future development mentioned for aviation engines?", 
                options: {A: "Returning to propeller-based steam engines.", B: "Using nuclear reactors for commercial flights.", C: "Experimenting with hybrid-electric systems and sustainable fuels.", D: "Eliminating engines and using gliders only."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 5 mentions \"hybrid-electric systems and sustainable aviation fuels.\"<br><br><strong>Chi:</strong> 第五段提到「混合動力系統和永續航空燃料」。" 
            },
            { 
                id: 'q11', 
                q: "11. The word \"propel\" in Paragraph 1 is closest in meaning to:", 
                options: {A: "To hold back or stop", B: "To push or drive forward", C: "To lift straight up", D: "To spin around in circles"}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> \"Propel\" means to drive, push, or cause to move in a particular direction (usually forward).<br><br><strong>Chi:</strong> \"Propel\" 意指推動、驅動或導致向特定方向移動（通常是向前）。" 
            },
            { 
                id: 'q12', 
                q: "12. The word \"distinctive\" is NOT used in the text, but the word \"fundamental\" in Paragraph 1 means:", 
                options: {A: "Complicated and hard to understand", B: "Basic and essential", C: "New and modern", D: "Dangerous and risky"}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> \"Fundamental\" means forming a necessary base or core; of central importance.<br><br><strong>Chi:</strong> \"Fundamental\" 意指形成必要基礎或核心的；至關重要的。" 
            },
            { 
                id: 'q13', 
                q: "13. Why is the \"Suck\" phase compared to a vacuum cleaner?", 
                options: {A: "Because it cleans the air before burning it.", B: "Because it draws in massive amounts of air.", C: "Because it is powered by electricity from a plug.", D: "Because it is located on the floor of the plane."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Paragraph 2 says the blades act like a vacuum, \"sucking in enormous quantities of air.\"<br><br><strong>Chi:</strong> 第二段說葉片像吸塵器一樣，「吸入大量的空氣」。" 
            },
            { 
                id: 'q14', 
                q: "14. Which part of the engine is responsible for the \"Squeeze\" phase?", 
                options: {A: "The exhaust nozzle", B: "The combustion chamber", C: "The compressor", D: "The turbine"}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 2 explicitly states: \"the compressor, which handles the 'Squeeze' phase.\"<br><br><strong>Chi:</strong> 第二段明確指出：「壓縮機，負責『壓縮』階段」。" 
            },
            { 
                id: 'q15', 
                q: "15. What is the main purpose of this article?", 
                options: {A: "To teach pilots how to fly a plane.", B: "To explain the history of Sir Isaac Newton.", C: "To describe the mechanical process of how jet engines work.", D: "To compare different airline ticket prices."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> The article focuses on explaining the mechanics and principles of jet engines.<br><br><strong>Chi:</strong> 這篇文章專注於解釋噴射引擎的機械結構和原理。" 
            }
        ];

        window.initAudioContext = function() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        window.playCorrectSound = function() {
            window.initAudioContext();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        window.playFailSound = function() {
            window.initAudioContext();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime); 
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        function initVoice() {
            const loadVoices = () => {
                const voices = synth.getVoices();
                if (voices.length > 0) {
                    selectedVoice = voices.find(v => v.name === 'Google US English') || 
                                    voices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural') && v.lang.includes('en-US')) ||
                                    voices.find(v => (v.name.includes('Siri') || v.name.includes('Enhanced') || v.name.includes('Premium')) && v.lang.includes('en-US')) ||
                                    voices.find(v => v.name === 'Samantha') || 
                                    voices.find(v => v.lang === 'en-US');
                }
            };
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        function renderArticle() {
            const displayArea = document.getElementById('article-display');
            if (!displayArea) return;
            displayArea.innerHTML = '';
            
            let p;
            sentences = []; 
            
            articleData.forEach((item, index) => {
                // Image insertion logic
                if (index === 0) insertImage(displayArea, 'p1.jpg', 'The Roar of Modern Travel');
                else if (index === 7) insertImage(displayArea, 'p2.jpg', 'Suck and Squeeze (Intake and Compression)');
                else if (index === 16) insertImage(displayArea, 'p3.jpg', 'Bang (Combustion)');
                else if (index === 24) insertImage(displayArea, 'p4.jpg', 'Blow (Exhaust and Thrust)');
                else if (index === 32) insertImage(displayArea, 'p5.jpg', 'Efficiency and Evolution');
                
                if (index === 0 || index === 7 || index === 16 || index === 24 || index === 32) {
                    p = document.createElement('p');
                    p.className = "mb-10 text-gray-800 leading-relaxed"; 
                    displayArea.appendChild(p);
                }
                
                const spanEn = document.createElement('span');
                spanEn.innerHTML = processWords(item.en);
                spanEn.id = `sent-${index}`;
                spanEn.className = 'cursor-pointer hover:bg-yellow-100 rounded transition duration-200 leading-loose mr-1';
                spanEn.onclick = (e) => {
                    if (e.target.classList.contains('vocab-word') || e.target.parentElement.classList.contains('vocab-word') || e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
                    window.playFromSentence(index);
                };
                
                p.appendChild(spanEn);
                sentences.push({ text: item.en, id: `sent-${index}` });

                const divZh = document.createElement('div');
                divZh.className = 'translation-text hidden';
                divZh.innerText = item.zh;
                p.appendChild(divZh);
            });
        }

        function insertImage(container, filename, altText) {
             const img = document.createElement('img');
             img.src = `English-Reading-122-images/${filename}`; 
             img.alt = altText;
             img.width = 1300;
             img.height = 576;
             img.className = "w-full md:w-5/6 h-auto object-cover rounded-xl mb-8 mx-auto shadow-lg hover:shadow-2xl transition duration-500 border border-gray-100";
             img.onerror = function() { this.style.display = 'none'; };
             container.appendChild(img);
        }

        function processWords(text) {
            const words = text.split(' ');
            return words.map(word => {
                // Keep the original punctuation for display
                const originalWord = word;
                // Remove punctuation for lookup
                const cleanWord = word.replace(/[.,!?;:()"]/g, "").toLowerCase();
                
                // --- Smart Lookup Logic: Word Mapping for Variations ---
                const wordMapping = {
                    "soaring": "soar",
                    "speeds": "velocity", // Mapping speed to velocity if appropriate, or keep separate. Vocab has velocity. Speed is common. 
                    "engines": "engine", // Engine is not in vocab, but common.
                    "wings": "wing",
                    "machines": "machine",
                    "marvels": "marvel",
                    "relies": "rely", // rely is not in vocab
                    "principles": "principle",
                    "executions": "execution",
                    "rushes": "rush",
                    "propels": "propel",
                    "pilots": "pilot",
                    "engineers": "engineer",
                    "blades": "blade",
                    "quantities": "quantity",
                    "flows": "flow",
                    "consists": "consist",
                    "tunnels": "tunnel",
                    "crushed": "compress", // Contextual mapping
                    "compression": "compress",
                    "pressurized": "compress", // Contextual
                    "sprays": "spray",
                    "nozzles": "nozzle",
                    "explosions": "explosive", // Related
                    "generates": "generate",
                    "expanding": "expand",
                    "expanded": "expand",
                    "walls": "wall",
                    "gases": "gas",
                    "spins": "spin",
                    "connected": "connect",
                    "shoots": "shoot",
                    "overcomes": "overcome",
                    "evolved": "evolution",
                    "passed": "pass",
                    "making": "make",
                    "emissions": "emission",
                    "promises": "promise",
                    "intakes": "intake",
                    "combustors": "combustion",
                    "ignited": "ignite",
                    "turbines": "turbine",
                    "exhausts": "exhaust",
                    "velocities": "velocity",
                    "efficiencies": "efficient",
                    "evolutions": "evolution",
                    "bypassed": "bypass",
                    "hybrids": "hybrid",
                    "sustainables": "sustainable",
                    "miracles": "miracle",
                    "sophistications": "sophisticated",
                    "atmospheres": "atmosphere",
                    "propelling": "propel",
                    "principled": "principle",
                    "fuselages": "fuselage",
                    "sustaining": "sustain",
                    "compressing": "compress",
                    "chambers": "chamber",
                    "igniting": "ignite",
                    "thrusting": "thrust",
                    "exhausting": "exhaust",
                    "expanding": "expand",
                    "executing": "execution",
                    "fundamentals": "fundamental",
                    "reactions": "reaction",
                    "opposites": "opposite",
                    "shafts": "shaft",
                    "progressive": "progressively",
                    "mixtures": "mixture",
                    "spraying": "spray",
                    "motions": "motion",
                    "accelerating": "accelerate",
                    "accelerated": "accelerate",
                    "drags": "drag",
                    "emitted": "emission"
                };

                let targetKey = cleanWord;
                if (wordMapping[cleanWord]) {
                    targetKey = wordMapping[cleanWord];
                }

                // Check for singular/plural or simple verb forms if not mapped
                if (!vocabulary[targetKey]) {
                    if (targetKey.endsWith('s') && vocabulary[targetKey.slice(0, -1)]) {
                        targetKey = targetKey.slice(0, -1);
                    } else if (targetKey.endsWith('ed') && vocabulary[targetKey.slice(0, -2)]) {
                        targetKey = targetKey.slice(0, -2);
                    } else if (targetKey.endsWith('ing') && vocabulary[targetKey.slice(0, -3)]) {
                        targetKey = targetKey.slice(0, -3);
                    }
                }

                if (vocabulary[targetKey]) {
                    const data = vocabulary[targetKey];
                    const isFav = favoriteWords.has(targetKey);
                    const heartClass = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
                    
                    return `<span class="vocab-word" onclick="window.speakAndShowDef(event, '${targetKey}')">${originalWord}<span class="vocab-tooltip">
                        <div class="flex justify-between items-start mb-2">
                            <span class="pos-tag text-sm">${data.pos}</span>
                            <button onclick="window.toggleFavorite(event, '${targetKey}')" class="text-xl hover:scale-110 transition p-1 text-gray-500 hover:text-pink-500" title="加入學習清單">
                                <i class="${heartClass}" id="heart-${targetKey}"></i>
                            </button>
                        </div>
                        <div class="font-bold text-blue-800 text-2xl mb-2">${targetKey}</div>
                        <div class="mb-3 text-lg font-medium text-gray-800">${data.trans}</div>
                        <div class="text-lg text-gray-600 italic border-t border-gray-200 pt-3 leading-relaxed">"${data.example}"</div>
                    </span></span>`;
                }
                return originalWord;
            }).join(' ');
        }
        
        window.speakAndShowDef = function(e, word) {
            e.stopPropagation(); 
            synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(word);
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 0.9; 
            synth.speak(utterance);
        }

        window.speakWord = function(word) {
            synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(word);
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 0.9; 
            synth.speak(utterance);
        }

        window.toggleFavorite = function(e, word) {
            if(e) e.stopPropagation();
            if (favoriteWords.has(word)) {
                favoriteWords.delete(word);
                updateHeartIcon(word, false);
            } else {
                favoriteWords.add(word);
                updateHeartIcon(word, true);
                confetti({
                    particleCount: 30,
                    spread: 40,
                    origin: { x: e ? e.clientX / window.innerWidth : 0.5, y: e ? e.clientY / window.innerHeight : 0.5 },
                    colors: ['#ec4899', '#f43f5e']
                });
            }
            document.getElementById('study-list-count').innerText = `目前收藏: ${favoriteWords.size} 個單字`;
            if(document.getElementById('study-modal').style.display === 'flex') window.openStudyModal();
            if(document.getElementById('vocab-modal').style.display === 'flex') window.openVocabModal();

            window.saveUserData();
        }

        function updateHeartIcon(word, isFav) {
            const icons = document.querySelectorAll(`#heart-${word}`);
            icons.forEach(icon => {
                icon.className = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
            });
            const tableIcons = document.querySelectorAll(`#heart-table-${word}`);
            tableIcons.forEach(icon => {
                icon.className = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
            });
        }

        window.openVocabModal = function() {
            const container = document.getElementById('vocab-table-container');
            container.innerHTML = generateTableHTML(Object.keys(vocabulary), 'vocab');
            document.getElementById('vocab-modal').style.display = 'flex';
        }

        window.openStudyModal = function() {
            const container = document.getElementById('study-table-container');
            if (favoriteWords.size === 0) {
                container.innerHTML = `<div class="text-center py-12 text-gray-500"><i class="far fa-heart text-4xl mb-4 text-gray-300"></i><p class="text-lg">您的學習清單是空的。</p><p class="text-sm text-gray-400 mt-2">在閱讀時點擊單字上的愛心圖示即可加入。</p></div>`;
            } else {
                container.innerHTML = generateTableHTML(Array.from(favoriteWords), 'study');
            }
            document.getElementById('study-modal').style.display = 'flex';
        }

        window.openMistakeModal = function() {
            const container = document.getElementById('mistake-table-container');
            if (wrongAnswers.length === 0) {
                 container.innerHTML = `<div class="text-center py-12 text-gray-500"><i class="fas fa-check-circle text-4xl mb-4 text-green-500"></i><p class="text-lg font-bold">太棒了！</p><p class="text-sm text-gray-400 mt-2">您沒有答錯任何題目。</p></div>`;
            } else {
                 let html = `
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-red-50 border-b border-red-100 text-red-800">
                                <th class="p-4 font-bold w-4/12 rounded-tl-lg">題目 (Question)</th>
                                <th class="p-4 font-bold w-2/12">您的答案</th>
                                <th class="p-4 font-bold w-2/12">正確答案</th>
                                <th class="p-4 font-bold w-4/12 rounded-tr-lg">詳解 (Explanation)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                `;
                wrongAnswers.forEach(item => {
                    html += `
                        <tr class="hover:bg-red-50/50 transition">
                            <td class="p-4 font-medium text-gray-800">${item.q.q}</td>
                            <td class="p-4 text-red-600 font-bold"><i class="fas fa-times mr-1"></i> ${item.yourAns}</td>
                            <td class="p-4 text-green-600 font-bold"><i class="fas fa-check mr-1"></i> ${item.q.ans}</td>
                            <td class="p-4 text-gray-600 text-sm leading-relaxed">${item.q.expl}</td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            }
            document.getElementById('mistake-modal').style.display = 'flex';
        }

        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        }

        function generateTableHTML(wordList, type) {
            if (!wordList || wordList.length === 0) return '';
            wordList.sort();
            let html = `
                <table class="w-full text-left border-collapse text-gray-800">
                    <thead>
                        <tr class="bg-gray-100 border-b border-gray-200 text-gray-700">
                            <th class="p-4 font-bold w-1/12 text-lg rounded-tl-lg">收藏</th>
                            <th class="p-4 font-bold w-2/12 text-lg">單字 (Word)</th>
                            <th class="p-4 font-bold w-1/12 text-lg">詞性</th>
                            <th class="p-4 font-bold w-3/12 text-lg">中文意思 (Meaning)</th>
                            <th class="p-4 font-bold w-5/12 text-lg rounded-tr-lg">例句 (Example)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
            `;
            wordList.forEach(word => {
                const data = vocabulary[word];
                if(!data) return;
                const isFav = favoriteWords.has(word);
                const heartClass = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
                html += `
                    <tr class="hover:bg-blue-50/50 transition duration-150">
                        <td class="p-4 text-center"><button onclick="window.toggleFavorite(null, '${word}')" class="text-2xl focus:outline-none hover:scale-110 transition text-gray-400 hover:text-pink-500"><i class="${heartClass}" id="heart-table-${word}"></i></button></td>
                        
                        <td class="p-4 font-bold text-blue-700 text-xl md:text-2xl cursor-pointer hover:text-blue-900 transition group" onclick="window.speakWord('${word}')" title="點擊發音 (Click to listen)">
                            ${word} <i class="fas fa-volume-up text-base ml-2 opacity-50 group-hover:opacity-100 transition text-blue-400"></i>
                        </td>

                        <td class="p-4 text-base md:text-lg"><span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded text-sm md:text-base font-bold">${data.pos}</span></td>
                        <td class="p-4 text-gray-700 text-lg md:text-xl font-medium">${data.trans}</td>
                        <td class="p-4 text-gray-500 text-lg md:text-xl italic">"${data.example}"</td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        window.printList = function(type) {
            const printArea = document.getElementById('print-area');
            let content = '';
            
            if (type === 'mistakes') {
                content = `
                    <div style="font-family: 'Times New Roman', serif; color: black;">
                        <h1 style="text-align: center; font-size: 24px; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px;">
                            錯題本 (Review Mistakes)
                        </h1>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f3f4f6; -webkit-print-color-adjust: exact;">
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 35%;">Question</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 10%;">Your Answer</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 10%;">Correct</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 45%;">Explanation</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                if (wrongAnswers.length === 0) {
                     content += `<tr><td colspan="4" style="text-align: center; padding: 20px;">No mistakes found. Good job!</td></tr>`;
                } else {
                    wrongAnswers.forEach(item => {
                        content += `
                            <tr>
                                <td style="border: 1px solid black; padding: 8px;">${item.q.q}</td>
                                <td style="border: 1px solid black; padding: 8px; text-align: center; color: red;">${item.yourAns}</td>
                                <td style="border: 1px solid black; padding: 8px; text-align: center; font-weight: bold;">${item.q.ans}</td>
                                <td style="border: 1px solid black; padding: 8px;">${item.q.expl}</td>
                            </tr>
                        `;
                    });
                }
                content += `</tbody></table></div>`;
            } else {
                let title = type === 'vocab' ? "完整單字表 (Vocabulary List)" : "我的學習清單 (My Study List)";
                let wordList = type === 'vocab' ? Object.keys(vocabulary) : Array.from(favoriteWords);
                wordList.sort();

                content = `
                    <div style="font-family: 'Times New Roman', serif; color: black;">
                        <h1 style="text-align: center; font-size: 24px; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px;">
                            ${title}
                        </h1>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f3f4f6; -webkit-print-color-adjust: exact;">
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 15%;">Word</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 10%;">POS</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 25%;">Meaning</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 50%;">Example Sentence</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                if (wordList.length === 0) {
                     content += `<tr><td colspan="4" style="text-align: center; padding: 20px;">No words in list.</td></tr>`;
                } else {
                    wordList.forEach(word => {
                        const data = vocabulary[word];
                        content += `
                            <tr>
                                <td style="border: 1px solid black; padding: 8px; font-weight: bold;">${word}</td>
                                <td style="border: 1px solid black; padding: 8px; text-align: center;">${data.pos}</td>
                                <td style="border: 1px solid black; padding: 8px;">${data.trans}</td>
                                <td style="border: 1px solid black; padding: 8px; font-style: italic;">${data.example}</td>
                            </tr>
                        `;
                    });
                }
                content += `</tbody></table></div>`;
            }
            
            content += `<div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">Generated by Listening Quiz: Jet Engines</div>`;
            printArea.innerHTML = content;
            window.print();
        }

        window.toggleTranslation = function() {
            showTranslation = !showTranslation;
            const transElements = document.querySelectorAll('.translation-text');
            const btn = document.getElementById('toggle-trans-btn');
            
            transElements.forEach(el => {
                if(showTranslation) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });

            if(showTranslation) {
                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                btn.classList.remove('bg-slate-800', 'text-green-400', 'border-slate-600', 'hover:bg-slate-700');
                btn.innerHTML = '<i class="fas fa-check"></i> <span>隱藏翻譯</span>';
            } else {
                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
                btn.classList.add('bg-slate-800', 'text-green-400', 'border-slate-600', 'hover:bg-slate-700');
                btn.innerHTML = '<i class="fas fa-language"></i> <span>顯示翻譯</span>';
            }
        }

        window.togglePlay = function() {
            if (isPlaying) {
                window.pauseAudio();
            } else {
                window.playAudio();
            }
        }

        window.playAudio = function() {
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            if (currentSentenceIndex >= sentences.length) {
                currentSentenceIndex = 0;
            }
            window.speakSentence(currentSentenceIndex);
        }

        window.speakSentence = function(index) {
            if (!isPlaying || index >= sentences.length) {
                if (index >= sentences.length) {
                    isPlaying = false;
                    updatePlayBtn(false);
                    document.getElementById('visualizer').classList.remove('playing');
                    currentSentenceIndex = 0;
                    window.highlightSentence(-1);
                    currentSentenceIndex = 0;
                    window.saveUserData();
                }
                return;
            }

            currentSentenceIndex = index;
            window.highlightSentence(index);
            window.updateProgressBar();
            window.saveUserData();

            synth.cancel();

            const text = sentences[index].text;
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 1.0; 
            utterance.pitch = 1.0; 
            
            utterance.onend = function() {
                if (isPlaying) {
                    setTimeout(() => {
                        window.speakSentence(index + 1);
                    }, 400); 
                }
            };
            
            utterance.onerror = function(e) {
                console.error("Speech error", e);
                isPlaying = false;
                updatePlayBtn(false);
            };

            synth.speak(utterance);
        }

        window.pauseAudio = function() {
            isPlaying = false;
            synth.cancel();
            updatePlayBtn(false);
            document.getElementById('visualizer').classList.remove('playing');
        }

        window.restartAudio = function() {
            synth.cancel();
            currentSentenceIndex = 0;
            window.updateProgressBar();
            window.highlightSentence(-1);
            if (isPlaying) {
                setTimeout(() => window.speakSentence(0), 100);
            }
        }
        
        window.playFromSentence = function(index) {
            currentSentenceIndex = index;
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            window.speakSentence(index);
        }

        function updatePlayBtn(isPlay) {
            const icons = [document.getElementById('main-play-icon'), document.getElementById('mobile-play-icon')];
            icons.forEach(icon => {
                if (isPlay) {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                } else {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                }
            });
        }

        window.highlightSentence = function(index) {
            document.querySelectorAll('.highlight-text').forEach(el => el.classList.remove('highlight-text'));
            
            if (index >= 0 && index < sentences.length) {
                const el = document.getElementById(sentences[index].id);
                if (el) {
                    el.classList.add('highlight-text');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        window.updateProgressBar = function() {
             const progress = ((currentSentenceIndex + 1) / sentences.length) * 100;
             document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        window.toggleText = function() {
            textHidden = !textHidden;
            const overlay = document.getElementById('hidden-overlay');
            const btn = document.getElementById('toggle-text-btn');
            if (textHidden) {
                overlay.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-eye"></i> <span>Show Text</span>';
                btn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
                btn.classList.remove('bg-slate-800', 'text-amber-400', 'border-slate-600', 'hover:bg-slate-700');
            } else {
                overlay.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> <span>Hide Text</span>';
                btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300');
                btn.classList.add('bg-slate-800', 'text-amber-400', 'border-slate-600', 'hover:bg-slate-700');
            }
        }

        function renderQuiz() {
            const form = document.getElementById('quizForm');
            if (!form) return;
            form.innerHTML = '';
            
            quizData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white p-6 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md hover:border-blue-300';
                div.innerHTML = `
                    <p class="font-bold text-gray-800 mb-4 text-xl">${item.q}</p>
                    <div class="space-y-3" id="${item.id}-options">
                        ${Object.keys(item.options).map(key => `
                            <label class="quiz-option flex items-center p-4 rounded-lg cursor-pointer border border-gray-200 hover:bg-gray-50 transition" id="${item.id}-label-${key}">
                                <input type="radio" name="${item.id}" value="${key}" class="hidden" onclick="window.checkAnswer('${item.id}', '${key}')">
                                <div class="w-8 h-8 rounded-full border-2 border-gray-400 flex items-center justify-center mr-4 font-bold text-gray-500 transition-colors bg-white" id="${item.id}-icon-${key}">
                                    ${key}
                                </div>
                                <span class="text-gray-700 font-medium text-lg">${item.options[key]}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div id="${item.id}-expl" class="explanation-box mt-4 bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500 text-gray-700 hidden">
                        <p class="font-bold mb-1" id="${item.id}-status"></p>
                        <p>${item.expl}</p>
                    </div>
                `;
                form.appendChild(div);
            });
        }

        window.checkAnswer = function(questionId, selectedKey, isRestoring = false) {
            const questionObj = quizData.find(q => q.id === questionId);
            if (!questionObj) return;

            userAnswers[questionId] = selectedKey;

            const isCorrect = selectedKey === questionObj.ans;
            
            const selectedLabel = document.getElementById(`${questionId}-label-${selectedKey}`);
            const selectedIcon = document.getElementById(`${questionId}-icon-${selectedKey}`);
            
            if (isCorrect) {
                if(!isRestoring) window.playCorrectSound(); 
                selectedLabel.classList.add('correct');
                selectedIcon.classList.add('border-green-500', 'text-green-600', 'bg-green-100');
                selectedIcon.innerHTML = '<i class="fas fa-check"></i>';
                if(!isRestoring) userScore += (100 / 15); 
            } else {
                if(!isRestoring) window.playFailSound(); 
                selectedLabel.classList.add('wrong');
                selectedIcon.classList.add('border-red-500', 'text-red-600', 'bg-red-100');
                selectedIcon.innerHTML = '<i class="fas fa-times"></i>';
                
                const correctLabel = document.getElementById(`${questionId}-label-${questionObj.ans}`);
                const correctIcon = document.getElementById(`${questionId}-icon-${questionObj.ans}`);
                correctLabel.classList.add('correct');
                correctIcon.classList.add('border-green-500', 'text-green-600', 'bg-green-100');
                correctIcon.innerHTML = '<i class="fas fa-check"></i>';

                if(!isRestoring) wrongAnswers.push({ q: questionObj, yourAns: selectedKey });
            }

            const optionsDiv = document.getElementById(`${questionId}-options`);
            const inputs = optionsDiv.querySelectorAll('input');
            const labels = optionsDiv.querySelectorAll('label');
            
            inputs.forEach(input => input.disabled = true);
            labels.forEach(label => label.classList.add('disabled'));

            const explBox = document.getElementById(`${questionId}-expl`);
            const statusText = document.getElementById(`${questionId}-status`);
            
            explBox.style.display = 'block';
            if (isCorrect) {
                explBox.style.borderLeftColor = '#16a34a';
                explBox.style.backgroundColor = '#f0fdf4';
                statusText.innerHTML = '<i class="fas fa-check-circle text-green-600"></i> Correct!';
                statusText.className = "font-bold mb-1 text-green-700";
            } else {
                explBox.style.borderLeftColor = '#dc2626';
                explBox.style.backgroundColor = '#fef2f2';
                statusText.innerHTML = `<i class="fas fa-times-circle text-red-600"></i> Incorrect. The correct answer is ${questionObj.ans}.`;
                statusText.className = "font-bold mb-1 text-red-700";
            }

            if(!isRestoring) window.saveUserData();
        }

        window.showFinalScore = function() {
            const scoreDisplay = document.getElementById('final-score');
            const feedback = document.getElementById('feedback-msg');
            const resultCard = document.getElementById('score-card');
            const mistakeBtn = document.getElementById('mistake-review-btn');
            
            resultCard.classList.remove('hidden');
            let finalScore = Math.round(userScore);
            scoreDisplay.innerText = `${finalScore} / 100`;
            
            if (wrongAnswers.length > 0) {
                mistakeBtn.classList.remove('hidden');
                mistakeBtn.classList.add('flex');
            }

            if (finalScore >= 80) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b']
                });
                
                if (finalScore >= 95) {
                    feedback.innerText = "Maverick level! You are a true ace pilot!";
                } else {
                    feedback.innerText = "Great job! You're ready for TOPGUN.";
                }
            } else if (finalScore >= 60) {
                feedback.innerText = "Good pass. Keep training, wingman.";
            } else {
                feedback.innerText = "You crashed and burned. Try listening again.";
            }
            
            resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', () => {
                renderArticle();
                renderQuiz();
                initVoice();
            });
        } else {
            renderArticle();
            renderQuiz();
            initVoice();
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>擬真語音互動測驗：Whispers in the Dark: 5 Creepiest Urban Legends from Japan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Confetti Library for Celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* Darker background for horror theme */
            color: #e5e7eb;
        }
        
        /* Smooth Highlighting for Karaoke Mode */
        .highlight-text {
            background-color: #4c1d95; /* violet-900 */
            color: #c4b5fd; /* violet-300 */
            padding: 2px 4px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
            border: 1px solid transparent;
            background-color: #1f2937; /* Dark gray */
        }
        .quiz-option:hover:not(.disabled) {
            background-color: #374151;
            border-color: #6b7280;
        }
        .quiz-option.correct {
            background-color: #064e3b !important;
            border-color: #10b981 !important;
            color: #a7f3d0;
        }
        .quiz-option.wrong {
            background-color: #7f1d1d !important;
            border-color: #ef4444 !important;
            color: #fca5a5;
            opacity: 0.9;
        }
        .quiz-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .explanation-box {
            display: none; /* Hidden by default */
            margin-top: 15px;
            font-size: 1.1em;
            color: #d1d5db;
            background: #1f2937;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #8b5cf6; /* Violet border */
            animation: slideDown 0.3s ease-out;
            line-height: 1.6;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Interactive Vocabulary Styles */
        .vocab-word {
            border-bottom: 2px dotted #a78bfa;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            color: #a78bfa;
            font-weight: 500;
        }
        .vocab-word:hover {
            background-color: #4c1d95;
            color: #fff;
        }
        .vocab-word:active {
            transform: scale(0.95);
        }

        /* Tooltip Style - Enhanced for interactivity */
        .vocab-tooltip {
            visibility: hidden;
            width: max-content;
            min-width: 240px; 
            max-width: 320px;
            background-color: #0f172a; /* Darker blue/black */
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 16px; 
            position: absolute;
            z-index: 100;
            bottom: 140%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            font-size: 1.1rem; 
            pointer-events: none; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 0 15px rgba(139, 92, 246, 0.3); /* Glowing shadow */
            line-height: 1.5;
            border: 1px solid #4c1d95;
        }
        
        .vocab-word:hover .vocab-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
            pointer-events: auto; 
        }

        .vocab-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
        }
        
        .pos-tag {
            font-size: 0.75em;
            text-transform: uppercase;
            background-color: #5b21b6;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            font-weight: bold;
            color: #ddd6fe;
            display: inline-block;
            margin-bottom: 4px;
        }

        /* Translation Text Style */
        .translation-text {
            display: block;
            font-size: 0.95em;
            color: #9ca3af;
            margin-top: 6px;
            margin-bottom: 16px;
            padding-left: 10px;
            border-left: 3px solid #6b7280;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .translation-text.hidden {
            display: none;
        }
        
        /* Audio Wave Animation */
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 20px;
            gap: 2px;
        }
        .bar {
            width: 4px;
            background: #a78bfa;
            animation: bounce 0ms infinite ease-in-out alternate;
        }
        .playing .bar {
            animation-duration: 400ms;
        }
        .playing .bar:nth-child(1) { animation-delay: -0.2s; }
        .playing .bar:nth-child(2) { animation-delay: -0.4s; }
        .playing .bar:nth-child(3) { animation-delay: -0.6s; }
        .playing .bar:nth-child(4) { animation-delay: -0.8s; }
        @keyframes bounce {
            0% { height: 3px; opacity: 0.5; }
            100% { height: 20px; opacity: 1; }
        }
        
        .hidden-content {
            filter: blur(12px);
            user-select: none;
            pointer-events: none;
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #1f2937;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            position: relative;
            color: #f3f4f6;
            border: 1px solid #374151;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
                color: black;
                background: white;
            }
            #print-area, #print-area * {
                visibility: visible;
                color: black;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }
            @page {
                size: A4 portrait;
                margin: 2cm;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen pb-12 text-gray-100">

    <!-- Navbar / Audio Player Sticky Header -->
    <div class="sticky top-0 z-50 bg-gray-800 text-white shadow-xl border-b border-gray-700 transition-all duration-300 no-print" id="audio-player-bar">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                
                <!-- Left: Title & Status -->
                <div class="flex items-center gap-3 w-full md:w-auto justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-violet-900/50 flex items-center justify-center text-violet-300 border border-violet-700">
                            <i class="fas fa-ghost text-lg"></i>
                        </div>
                        <div class="flex flex-col">
                            <h1 class="text-sm font-bold text-gray-100 uppercase tracking-wide">Listening Quiz</h1>
                            
                            <!-- Level and Word Count Indicators (Neon Style) -->
                            <div class="flex items-center gap-3 mt-1.5 mb-1">
                                <!-- Difficulty: Neon Yellow Style -->
                                <span class="text-[11px] font-bold bg-gray-900 text-yellow-300 px-2 py-0.5 rounded border border-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.6)] flex items-center gap-1.5 transition hover:scale-105" title="Difficulty Level">
                                    <i class="fas fa-layer-group text-xs"></i> CEFR B1-B2 (Intermediate)
                                </span>
                                <!-- Word Count: Neon Cyan Style -->
                                <span class="text-[11px] font-bold bg-gray-900 text-cyan-300 px-2 py-0.5 rounded border border-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.6)] flex items-center gap-1.5 transition hover:scale-105" title="Word Count">
                                    <i class="fas fa-file-word text-xs"></i> ~700 words
                                </span>
                            </div>

                            <div class="text-xs text-gray-400 flex items-center gap-1" id="voice-indicator">
                                <i class="fas fa-robot"></i> Initializing Voice...
                            </div>
                        </div>
                    </div>
                    <!-- Mobile Play Button -->
                    <button onclick="togglePlay()" class="md:hidden w-10 h-10 bg-violet-600 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition">
                        <i class="fas fa-play" id="mobile-play-icon"></i>
                    </button>
                </div>

                <!-- Center: Controls -->
                <div class="flex items-center gap-4">
                    <!-- Rewind -->
                    <button onclick="restartAudio()" class="text-gray-400 hover:text-white transition" title="Restart">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    
                    <!-- Main Play Button (Desktop) -->
                    <button onclick="togglePlay()" class="hidden md:flex w-12 h-12 bg-violet-600 text-white rounded-full shadow-lg items-center justify-center hover:scale-105 transition hover:shadow-violet-500/50">
                        <i class="fas fa-play text-xl ml-1" id="main-play-icon"></i>
                    </button>

                    <!-- Visualizer -->
                    <div class="equalizer" id="visualizer">
                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                    </div>
                </div>

                <!-- Right: Settings -->
                <div class="flex items-center gap-2 text-sm w-full md:w-auto justify-center md:justify-end border-t md:border-gray-700 border-t-0 md:pt-0 mt-2 md:mt-0">
                    
                    <!-- Translation Toggle -->
                    <button onclick="toggleTranslation()" id="toggle-trans-btn" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-lg font-bold transition shadow border border-gray-600">
                        <i class="fas fa-language"></i> <span>翻譯</span>
                    </button>

                    <!-- Toggle Text -->
                    <button onclick="toggleText()" id="toggle-text-btn" class="flex items-center gap-2 bg-amber-600 hover:bg-amber-500 text-white px-3 py-1.5 rounded-lg font-bold transition shadow">
                        <i class="fas fa-eye-slash"></i> <span>Hide Text</span>
                    </button>
                </div>
            </div>
        </div>
        <!-- Progress Bar -->
        <div class="w-full bg-gray-900 h-1.5 no-print">
            <div id="progress-bar" class="h-full bg-violet-500 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto p-4 md:p-6 space-y-8 no-print">
        
        <!-- Image Card -->
        <div class="bg-gray-800 rounded-2xl shadow-lg overflow-hidden border border-gray-700">
             <!-- Image with fallback -->
             <div class="w-full h-64 md:h-80 bg-gray-900 relative overflow-hidden group">
                <img 
                    src="English-Reading-24-images/p1.jpg" 
                    alt="Whispers in the Dark: Japanese Urban Legends" 
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 opacity-80"
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=1200&auto=format&fit=crop';"
                >
                
                <!-- Dark Gradient Overlay for better text readability -->
                <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent pointer-events-none"></div>

                <div class="absolute bottom-4 left-4 right-4 text-white">
                    <div class="flex items-center gap-2 text-sm font-medium opacity-90 backdrop-blur-sm bg-black/60 w-fit px-3 py-1 rounded-full border border-gray-600">
                        <i class="fas fa-book-skull"></i> Listening Focus: Folklore, Horror & Culture
                    </div>
                </div>
            </div>
        </div>

        <!-- Vocabulary Tools Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="openVocabModal()" class="bg-gray-800 p-4 rounded-xl shadow-md border border-gray-700 hover:border-violet-500 transition flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-violet-900/30 text-violet-400 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-200">完整單字表 (Vocabulary)</h3>
                        <p class="text-sm text-gray-400">查看所有單字與例句</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-600 group-hover:text-violet-400"></i>
            </button>

            <button onclick="openStudyModal()" class="bg-gray-800 p-4 rounded-xl shadow-md border border-gray-700 hover:border-pink-500 transition flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-pink-900/30 text-pink-400 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-200">我的學習清單 (Favorites)</h3>
                        <p class="text-sm text-gray-400" id="study-list-count">目前收藏: 0 個單字</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-600 group-hover:text-pink-400"></i>
            </button>
        </div>

        <!-- Text Content Area -->
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 border border-gray-700 relative">
            <h2 class="text-2xl font-bold text-gray-100 mb-6 pb-4 border-b border-gray-700">Whispers in the Dark: 5 Creepiest Urban Legends from Japan</h2>
            
            <div class="bg-gray-900/50 border-l-4 border-violet-500 p-4 mb-6 text-sm text-gray-300 rounded-r-lg">
                <i class="fas fa-mouse-pointer mr-1 text-violet-400"></i> <strong>Tip:</strong> 點擊單字聽發音，點擊 ❤️ 加入學習清單。
            </div>

            <!-- Hidden Message Overlay -->
            <div id="hidden-overlay" class="hidden absolute inset-0 bg-gray-900/95 z-10 flex flex-col items-center justify-center rounded-2xl backdrop-blur-sm transition-all">
                <div class="bg-gray-800 p-6 rounded-full mb-4 border border-gray-700 shadow-lg shadow-violet-900/20">
                    <i class="fas fa-ear-listen text-4xl text-violet-500"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-200 mb-2">Listen Carefully</h3>
                <p class="text-gray-400 mb-6 text-center max-w-sm">The text is hidden to challenge your listening skills. Try to answer the questions by listening only!</p>
                <button onclick="toggleText()" class="bg-violet-600 text-white px-6 py-2 rounded-full hover:bg-violet-700 transition shadow-lg border border-violet-500">
                    Show Text
                </button>
            </div>

            <!-- Article Container -->
            <!-- Modified font size: text-lg (mobile) and md:text-xl (desktop) for slightly smaller text -->
            <div id="article-display" class="prose max-w-none text-gray-300 text-lg md:text-xl leading-loose tracking-wide space-y-6">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- Quiz Area -->
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 border border-gray-700">
            <h3 class="text-xl font-bold text-gray-100 mb-6 flex items-center">
                <span class="bg-violet-900 text-violet-300 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm border border-violet-700">
                    <i class="fas fa-pen"></i>
                </span>
                Reading Comprehension Quiz (15 Questions)
            </h3>
            
            <form id="quizForm" class="space-y-8">
                <!-- Questions will be generated here -->
            </form>

            <div class="mt-8 pt-6 border-t border-gray-700 flex flex-col items-center gap-4">
                <button type="button" onclick="showFinalScore()" class="w-full md:w-auto bg-violet-600 hover:bg-violet-700 text-white text-lg font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:-translate-y-1 active:scale-95 border border-violet-500">
                    Show Final Score
                </button>
                
                <div id="score-card" class="hidden mt-6 text-center w-full bg-gray-900 p-6 rounded-xl border border-gray-700 animate-fade-in relative">
                    <p class="text-gray-400 text-sm uppercase font-bold tracking-wider">Your Result</p>
                    <div class="text-5xl font-extrabold text-violet-400 my-2" id="final-score">0</div>
                    <p id="feedback-msg" class="text-gray-300 font-medium mb-4"></p>
                    
                    <button id="mistake-review-btn" onclick="openMistakeModal()" class="hidden w-full md:w-auto bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold shadow transition flex items-center justify-center gap-2 mx-auto border border-red-500">
                        <i class="fas fa-book-dead"></i> 查看錯題本 (Review Mistakes)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vocabulary Modal -->
    <div id="vocab-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-4 md:p-6 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-100"><i class="fas fa-book-open text-violet-400 mr-2"></i> 完整單字表</h3>
                <button onclick="closeModal('vocab-modal')" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-grow" id="vocab-table-container"></div>
            <div class="p-4 border-t border-gray-700 bg-gray-800 rounded-b-2xl flex justify-end gap-3">
                <button onclick="printList('vocab')" class="bg-violet-600 hover:bg-violet-700 text-white px-5 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印單字表 (A4)
                </button>
                <button onclick="closeModal('vocab-modal')" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Study List Modal -->
    <div id="study-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-4 md:p-6 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-100"><i class="fas fa-heart text-pink-500 mr-2"></i> 我的學習清單</h3>
                <button onclick="closeModal('study-modal')" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-grow" id="study-table-container"></div>
            <div class="p-4 border-t border-gray-700 bg-gray-800 rounded-b-2xl flex justify-end gap-3">
                <button onclick="printList('study')" class="bg-violet-600 hover:bg-violet-700 text-white px-5 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印學習清單 (A4)
                </button>
                <button onclick="closeModal('study-modal')" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Mistake Review Modal -->
    <div id="mistake-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-4 md:p-6 border-b border-gray-700 flex justify-between items-center bg-red-900/30 rounded-t-2xl">
                <h3 class="text-xl font-bold text-red-400"><i class="fas fa-times-circle text-red-500 mr-2"></i> 錯題本 (Mistakes Review)</h3>
                <button onclick="closeModal('mistake-modal')" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-grow" id="mistake-table-container"></div>
            <div class="p-4 border-t border-gray-700 bg-gray-800 rounded-b-2xl flex justify-end gap-3">
                <button onclick="printList('mistakes')" class="bg-violet-600 hover:bg-violet-700 text-white px-5 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印錯題本 (A4)
                </button>
                <button onclick="closeModal('mistake-modal')" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <script>
        // --- Data & State ---
        
        // Vocabulary Dictionary
        const vocabulary = {
            "folklore": { pos: "n.", trans: "民間傳說", example: "Japanese folklore is full of spirits and monsters." },
            "unsettling": { pos: "adj.", trans: "令人不安的", example: "The movie had an unsettling ending that kept me awake." },
            "surgical": { pos: "adj.", trans: "外科的", example: "Doctors wear surgical masks during operations." },
            "trench coat": { pos: "n.", trans: "風衣", example: "He wore a beige trench coat in the rain." },
            "gruesome": { pos: "adj.", trans: "可怕的；血腥的", example: "The details of the crime were too gruesome to report." },
            "patrols": { pos: "n.", trans: "巡邏", example: "Police increased patrols at night to keep the area safe." },
            "vengeful": { pos: "adj.", trans: "復仇心重的", example: "The vengeful spirit haunted the old house." },
            "torso": { pos: "n.", trans: "軀幹", example: "The statue was missing its head and legs, only the torso remained." },
            "scythe": { pos: "n.", trans: "大鐮刀", example: "The Grim Reaper is often depicted carrying a scythe." },
            "stall": { pos: "n.", trans: "(廁所)隔間", example: "The last bathroom stall was locked from the inside." },
            "mysterious": { pos: "adj.", trans: "神秘的", example: "A mysterious stranger arrived in the small town." },
            "strangled": { pos: "v.", trans: "勒死", example: "The victim was strangled with a rope." },
            "mischievous": { pos: "adj.", trans: "惡作劇的；淘氣的", example: "The mischievous puppy stole my shoe." },
            "summon": { pos: "v.", trans: "召喚", example: "They tried to summon a ghost using a Ouija board." },
            "faint": { pos: "adj.", trans: "微弱的", example: "I heard a faint noise in the distance." },
            "tragedy": { pos: "n.", trans: "悲劇", example: "The sudden accident was a great tragedy for the family." },
            "consequences": { pos: "n.", trans: "後果", example: "You must be prepared to face the consequences of your actions." },
            "psychological": { pos: "adj.", trans: "心理的", example: "The trauma caused long-term psychological damage." },
            "supernatural": { pos: "adj.", trans: "超自然的", example: "Vampires and ghosts are supernatural creatures." },
            "shadows": { pos: "n.", trans: "陰影", example: "Something was moving in the shadows of the alley." }
        };

        // Article Data (5 Paragraphs)
        const articleData = [
            // Paragraph 1: Slit-Mouthed Woman (Indices 0-10 approx)
            { en: "Japan is a country famous for its rich history and polite society, but beneath the surface lies a world of terrifying folklore.", zh: "日本是一個以豐富歷史和禮貌社會聞名的國家，但在表面之下，隱藏著一個可怕的民間傳說世界。" },
            { en: "One of the most famous and unsettling figures is Kuchisake-onna, or the \"Slit-Mouthed Woman.\"", zh: "最著名且令人不安的人物之一是「裂嘴女」(Kuchisake-onna)。" },
            { en: "According to the legend, she appears as a beautiful woman wearing a surgical mask and a trench coat.", zh: "根據傳說，她以一名戴著外科口罩和風衣的美麗女子形象出現。" },
            { en: "She often approaches people walking alone at night and asks a simple question: \"Am I beautiful?\"", zh: "她經常接近在夜間獨自行走的人，並問一個簡單的問題：「我漂亮嗎？」" },
            { en: "If you say \"no,\" she kills you immediately with a pair of large scissors.", zh: "如果你說「不」，她會用一把大剪刀立刻殺死你。" },
            { en: "If you say \"yes,\" she removes her mask to reveal a mouth slit from ear to ear, screaming, \"How about now?\"", zh: "如果你說「是」，她會摘下口罩，露出從耳朵裂到耳朵的嘴巴，尖叫著：「現在呢？」" },
            { en: "A terrified \"no\" results in death, while a \"yes\" leads to a gruesome fate where she cuts your mouth to look like hers.", zh: "恐懼地回答「不」會導致死亡，而回答「是」則會導致悲慘的命運——她會把你的嘴巴剪得跟她一樣。" },
            { en: "This legend became so widespread in the 1970s that children were afraid to walk home from school alone, and police even increased patrols in some areas.", zh: "這個傳說在 1970 年代流傳甚廣，以至於孩子們不敢獨自放學回家，警方甚至在某些地區增加了巡邏。" },

            // Paragraph 2: Teke Teke (Indices 8-15 approx)
            { en: "While Kuchisake-onna terrifies pedestrians, another spirit haunts the areas near train stations.", zh: "當裂嘴女讓行人感到恐懼時，另一個靈魂則在火車站附近出沒。" },
            { en: "Her name is Teke Teke, named after the chilling sound she makes when she moves.", zh: "她的名字叫 Teke Teke，是以她移動時發出的令人毛骨悚然的聲音命名的。" },
            { en: "The legend tells the tragic story of a young schoolgirl who fell onto a railway line and was cut in half by an oncoming train.", zh: "這個傳說講述了一個年輕女學生跌落鐵軌並被火車輾成兩半的悲劇故事。" },
            { en: "Now, she is a vengeful spirit (Onryō) who crawls around on her hands and elbows, dragging her upper torso along the ground.", zh: "現在，她是一個復仇的怨靈 (Onryō)，用雙手和手肘在地上爬行，拖著她的上半身。" },
            { en: "Despite having no legs, she moves at an incredibly fast speed, making a \"teke-teke-teke\" sound as her elbows hit the pavement.", zh: "儘管沒有腿，她的移動速度卻快得驚人，當手肘撞擊路面時會發出「teke-teke-teke」的聲音。" },
            { en: "It is said that if you hear this sound at night, you must not look back.", zh: "據說如果你在晚上聽到這個聲音，絕對不能回頭。" },
            { en: "If she catches you, she will slice you in half at the waist with a scythe, making you just like her.", zh: "如果她抓住了你，她會用鐮刀將你從腰部切成兩半，讓你變得跟她一樣。" },
            { en: "This story serves as a dark warning to be careful around trains and late-night streets.", zh: "這個故事是對人們在火車和深夜街道旁要小心的黑暗警告。" },

            // Paragraph 3: Aka Manto (Indices 16-23 approx)
            { en: "Schools are common settings for Japanese ghost stories, and the restroom is often the scariest place of all.", zh: "學校是日本鬼故事常見的背景，而廁所往往是最可怕的地方。" },
            { en: "Aka Manto, or \"Red Cape,\" is a male spirit who haunts the last stall of public or school bathrooms.", zh: "「赤マント」(Aka Manto)，即「紅披風」，是一個出沒在公共廁所或學校廁所最後一間隔間的男性靈魂。" },
            { en: "Legend says that once you are seated, a mysterious voice will ask you a strange question: \"Do you want red paper or blue paper?\"", zh: "傳說一旦你坐下，一個神秘的聲音會問你一個奇怪的問題：「你要紅紙還是藍紙？」" },
            { en: "This is a trick question with no happy ending.", zh: "這是一個沒有快樂結局的陷阱題。" },
            { en: "If you choose red paper, you will be sliced apart until your clothes are stained red with blood.", zh: "如果你選擇紅紙，你會被切碎，直到你的衣服被鮮血染紅。" },
            { en: "If you choose blue paper, you will be strangled until your face turns blue.", zh: "如果你選擇藍紙，你會被勒死，直到你的臉色發青。" },
            { en: "Some versions suggest that choosing \"yellow paper\" will result in your head being forced into the toilet.", zh: "有些版本說選擇「黃紙」會導致你的頭被強行塞進馬桶裡。" },
            { en: "The only way to survive is to ignore the voice completely or run away immediately, proving that sometimes, silence is the best answer.", zh: "唯一生存的方法是完全無視那個聲音或立即逃跑，這證明了有時候，沉默是最好的回答。" },

            // Paragraph 4: Hanako-san (Indices 24-30 approx)
            { en: "Another bathroom legend, perhaps even more famous than Aka Manto, is Toire no Hanako-san (Hanako of the Toilet).", zh: "另一個廁所傳說，也許比「紅披風」更有名，那就是「廁所裡的花子」(Toire no Hanako-san)。" },
            { en: "Unlike the violent spirits, Hanako is often described as a mischievous young girl with bobbed hair and a red skirt.", zh: "與那些暴力的靈魂不同，花子通常被描述為一個留著鮑伯頭、穿著紅裙子的惡作劇小女孩。" },
            { en: "She is said to haunt the third stall of the girls' bathroom on the third floor.", zh: "據說她出沒在三樓女廁的第三間隔間。" },
            { en: "To summon her, a brave (or foolish) student must knock on the door three times and ask, \"Hanako-san, are you there?\"", zh: "要召喚她，勇敢（或愚蠢）的學生必須敲門三次並問：「花子小姐，妳在嗎？」" },
            { en: "If she is present, a faint voice may reply, \"Yes, I am here.\"", zh: "如果她在，一個微弱的聲音可能會回答：「是的，我在這裡。」" },
            { en: "While some versions of the story say a ghostly hand will reach out or the door will open to reveal a monster, others suggest she is simply a lonely spirit.", zh: "雖然有些版本說會有一隻鬼手伸出來，或者門會打開露出怪物，但其他版本則認為她只是一個孤獨的靈魂。" },
            { en: "Hanako is often compared to the Western legend of \"Bloody Mary,\" serving as a rite of passage for students trying to prove their courage.", zh: "花子常被拿來與西方的「血腥瑪麗」傳說相提並論，作為學生證明膽量的儀式。" },

            // Paragraph 5: Tomino's Hell (Indices 31-38 approx)
            { en: "Finally, there is a legend that proves words can be dangerous.", zh: "最後，有一個傳說證明了文字可能是危險的。" },
            { en: "Tomino's Hell is a poem written by Yomota Inuhiko in a 1919 book.", zh: "《多美子的地獄》(Tomino's Hell) 是由四方田犬彥寫於 1919 年一本書中的詩。" },
            { en: "The urban legend claims that you must never read this poem out loud.", zh: "都市傳說聲稱你絕對不能大聲朗讀這首詩。" },
            { en: "Reading it silently in your mind is safe, but speaking the words is said to invite tragedy.", zh: "在心中默讀是安全的，但說出這些字句據說會招致悲劇。" },
            { en: "The consequences range from falling ill or getting injured to sudden death.", zh: "後果從生病、受傷到突然死亡不等。" },
            { en: "The poem itself describes a descent into a dark and fiery hell, filled with disturbing imagery.", zh: "這首詩本身描述了墮入充滿不安意象的黑暗火焰地獄的過程。" },
            { en: "While many people have read it aloud on the internet to test the curse without dying, the psychological fear remains potent.", zh: "雖然許多人在網路上大聲朗讀它來測試詛咒且並未身亡，但心理上的恐懼依然強烈。" },
            { en: "These five legends—from slit-mouthed women to cursed poems—reveal a fascinating aspect of Japanese culture: the belief that the supernatural is always watching, waiting in the shadows of everyday life.", zh: "這五個傳說——從裂嘴女到被詛咒的詩——揭示了日本文化中迷人的一面：相信超自然力量總是在注視著，在日常生活的陰影中等待著。" }
        ];

        // Quiz Data (15 Questions)
        const quizData = [
            { id: 'q1', q: "1. What is the main theme of this article?", options: {A: "The history of Japanese train stations.", B: "Five famous scary stories from Japanese folklore.", C: "How to write a horror poem.", D: "A travel guide to Japan's haunted places."}, ans: 'B', expl: "The article introduces and details five specific urban legends from Japan." },
            { id: 'q2', q: "2. In Paragraph 1, what item does Kuchisake-onna use as a weapon?", options: {A: "A kitchen knife", B: "A samurai sword", C: "A pair of large scissors", D: "A heavy hammer"}, ans: 'C', expl: "The text states she kills or attacks with \"a pair of large scissors.\"" },
            { id: 'q3', q: "3. Why did police increase patrols in the 1970s according to Paragraph 1?", options: {A: "Due to a rise in robberies.", B: "Because children were afraid of the Kuchisake-onna legend.", C: "Because of a real serial killer.", D: "To stop students from skipping school."}, ans: 'B', expl: "The text mentions the legend became so widespread that children were afraid, leading to increased patrols." },
            { id: 'q4', q: "4. How did Teke Teke get her name?", options: {A: "It was her name when she was alive.", B: "It comes from the sound she makes when moving.", C: "It means \"half-body\" in Japanese.", D: "It is the name of the train station."}, ans: 'B', expl: "Paragraph 2 says she is \"named after the chilling sound she makes when she moves.\"" },
            { id: 'q5', q: "5. What is the defining physical characteristic of Teke Teke?", options: {A: "She has no face.", B: "She wears a red cape.", C: "She is missing her lower body (legs).", D: "She has three arms."}, ans: 'C', expl: "The text describes her as having been \"cut in half\" and dragging her \"upper torso.\"" },
            { id: 'q6', q: "6. In the legend of Aka Manto (Paragraph 3), what happens if you choose \"blue paper\"?", options: {A: "You are drowned in water.", B: "You are strangled until your face turns blue.", C: "You are set free.", D: "You are given a blue cape."}, ans: 'B', expl: "The text explicitly states: \"If you choose blue paper, you will be strangled until your face turns blue.\"" },
            { id: 'q7', q: "7. What is the only way to survive Aka Manto?", options: {A: "Choose yellow paper.", B: "Fight the spirit.", C: "Ignore the voice or run away.", D: "Carry a lucky charm."}, ans: 'C', expl: "Paragraph 3 says: \"The only way to survive is to ignore the voice completely or run away immediately.\"" },
            { id: 'q8', q: "8. Where does Toire no Hanako-san usually haunt?", options: {A: "The library.", B: "The boys' locker room.", C: "The third stall of the girls' bathroom on the third floor.", D: "The rooftop of the school."}, ans: 'C', expl: "Paragraph 4 specifies: \"haunt the third stall of the girls' bathroom on the third floor.\"" },
            { id: 'q9', q: "9. How is Hanako-san different from Aka Manto?", options: {A: "She is always violent.", B: "She is often described as mischievous rather than purely violent.", C: "She appears in the library.", D: "She is an old woman."}, ans: 'B', expl: "The text contrasts her with \"violent spirits,\" describing her as a \"mischievous young girl\" or even a \"lonely spirit.\"" },
            { id: 'q10', q: "10. Hanako-san is compared to which Western urban legend?", options: {A: "The Boogeyman", B: "Slender Man", C: "Bloody Mary", D: "Dracula"}, ans: 'C', expl: "Paragraph 4 mentions she is \"often compared to the Western legend of 'Bloody Mary'.\"" },
            { id: 'q11', q: "11. What is the specific warning regarding the poem Tomino's Hell?", options: {A: "Never read it silently.", B: "Never read it out loud.", C: "Never write it down.", D: "Never listen to it."}, ans: 'B', expl: "Paragraph 5 states: \"you must never read this poem out loud.\"" },
            { id: 'q12', q: "12. The word \"mischievous\" in Paragraph 4 is closest in meaning to:", options: {A: "Very dangerous and evil", B: "Playful and causing minor trouble", C: "Silent and invisible", D: "Sad and depressed"}, ans: 'B', expl: "In this context, \"mischievous\" refers to a spirit that plays tricks or is slightly naughty, but not necessarily deadly." },
            { id: 'q13', q: "13. What does the author imply about these legends in the conclusion?", options: {A: "They are scientifically true.", B: "They are silly and should be ignored.", C: "They reveal a cultural belief that the supernatural is always watching.", D: "They are only for children."}, ans: 'C', expl: "The last sentence mentions they reveal \"the belief that the supernatural is always watching, waiting in the shadows.\"" },
            { id: 'q14', q: "14. Which legend serves as a warning about safety near trains?", options: {A: "Kuchisake-onna", B: "Teke Teke", C: "Aka Manto", D: "Tomino's Hell"}, ans: 'B', expl: "Teke Teke involves a girl falling onto railway lines, serving as a \"dark warning to be careful around trains.\"" },
            { id: 'q15', q: "15. Which of the following is true about Kuchisake-onna’s victims?", options: {A: "They can survive if they answer \"yes\" twice.", B: "They are safe if they wear a mask.", C: "Answering \"yes\" results in a cut mouth; \"no\" results in death.", D: "She only attacks adults."}, ans: 'C', expl: "Paragraph 1 explains: \"A terrified 'no' results in death, while a 'yes' leads to... she cuts your mouth.\"" }
        ];

        let synth = window.speechSynthesis;
        let sentences = [];
        let currentSentenceIndex = 0;
        let isPlaying = false;
        let textHidden = false;
        let showTranslation = false;
        let selectedVoice = null;
        let userScore = 0;
        let favoriteWords = new Set();
        let wrongAnswers = []; 
        
        let audioCtx;

        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        function playCorrectSound() {
            initAudioContext();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function playFailSound() {
            initAudioContext();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime); 
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        window.onload = function() {
            renderArticle();
            renderQuiz();
            initVoice();
        };

        function initVoice() {
            const voiceStatus = document.getElementById('voice-indicator');
            const loadVoices = () => {
                const voices = synth.getVoices();
                if (voices.length > 0) {
                    selectedVoice = voices.find(v => v.name === 'Google US English') || 
                                    voices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural') && v.lang.includes('en-US')) ||
                                    voices.find(v => (v.name.includes('Siri') || v.name.includes('Enhanced') || v.name.includes('Premium')) && v.lang.includes('en-US')) ||
                                    voices.find(v => v.name === 'Samantha') || 
                                    voices.find(v => v.lang === 'en-US');
                    
                    if (selectedVoice) {
                        let displayName = selectedVoice.name.replace('Microsoft', '').replace('Google', '').replace('English', '').replace(' United States', '').replace('(Natural) - Online', 'Natural').trim();
                        voiceStatus.innerHTML = `<i class="fas fa-check-circle text-green-300"></i> Voice: ${displayName.substring(0, 20)}`;
                    } else {
                        voiceStatus.innerHTML = `<i class="fas fa-exclamation-circle text-yellow-300"></i> Standard Voice`;
                    }
                }
            };
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        function renderArticle() {
            const displayArea = document.getElementById('article-display');
            displayArea.innerHTML = '';
            
            let p;
            sentences = []; 
            
            // Render logic with correct indices for paragraph breaks
            // P1 ends at index 7, P2 starts at 8, ends at 15
            // P3 starts at 16, ends at 23
            // P4 starts at 24, ends at 30
            // P5 starts at 31, ends at 38
            
            articleData.forEach((item, index) => {
                if (index === 0) { // Paragraph 1
                    const img = document.createElement('img');
                    img.src = `English-Reading-24-images/p1.jpg`; 
                    img.alt = `Illustration for The Smile of the Slit-Mouthed Woman`;
                    img.width = 1024;
                    img.height = 576;
                    img.className = "w-full md:w-5/6 h-auto object-cover rounded-xl mb-8 mx-auto shadow-md hover:opacity-95 transition border border-gray-700";
                    img.onerror = function() { this.style.display = 'none'; };
                    displayArea.appendChild(img);
                    
                    p = document.createElement('p');
                    p.className = "mb-10"; 
                    displayArea.appendChild(p);
                } else if (index === 8) { // Paragraph 2
                    const img = document.createElement('img');
                    img.src = `English-Reading-24-images/p2.jpg`; 
                    img.alt = `Illustration for The Sound of Teke Teke`;
                    img.width = 1024;
                    img.height = 576;
                    img.className = "w-full md:w-5/6 h-auto object-cover rounded-xl mb-8 mx-auto shadow-md hover:opacity-95 transition border border-gray-700";
                    img.onerror = function() { this.style.display = 'none'; };
                    displayArea.appendChild(img);
                    
                    p = document.createElement('p');
                    p.className = "mb-10"; 
                    displayArea.appendChild(p);
                } else if (index === 16) { // Paragraph 3
                    const img = document.createElement('img');
                    img.src = `English-Reading-24-images/p3.jpg`; 
                    img.alt = `Illustration for The Terror in the Bathroom`;
                    img.width = 1024;
                    img.height = 576;
                    img.className = "w-full md:w-5/6 h-auto object-cover rounded-xl mb-8 mx-auto shadow-md hover:opacity-95 transition border border-gray-700";
                    img.onerror = function() { this.style.display = 'none'; };
                    displayArea.appendChild(img);
                    
                    p = document.createElement('p');
                    p.className = "mb-10"; 
                    displayArea.appendChild(p);
                } else if (index === 24) { // Paragraph 4
                    const img = document.createElement('img');
                    img.src = `English-Reading-24-images/p4.jpg`; 
                    img.alt = `Illustration for The Ghost in the Third Stall`;
                    img.width = 1024;
                    img.height = 576;
                    img.className = "w-full md:w-5/6 h-auto object-cover rounded-xl mb-8 mx-auto shadow-md hover:opacity-95 transition border border-gray-700";
                    img.onerror = function() { this.style.display = 'none'; };
                    displayArea.appendChild(img);
                    
                    p = document.createElement('p');
                    p.className = "mb-10"; 
                    displayArea.appendChild(p);
                } else if (index === 31) { // Paragraph 5
                    const img = document.createElement('img');
                    img.src = `English-Reading-24-images/p5.jpg`; 
                    img.alt = `Illustration for The Curse of the Poem`;
                    img.width = 1024;
                    img.height = 576;
                    img.className = "w-full md:w-5/6 h-auto object-cover rounded-xl mb-8 mx-auto shadow-md hover:opacity-95 transition border border-gray-700";
                    img.onerror = function() { this.style.display = 'none'; };
                    displayArea.appendChild(img);
                    
                    p = document.createElement('p');
                    p.className = "mb-10"; 
                    displayArea.appendChild(p);
                }
                
                const spanEn = document.createElement('span');
                spanEn.innerHTML = processWords(item.en);
                spanEn.id = `sent-${index}`;
                spanEn.className = 'cursor-pointer hover:bg-gray-700 rounded transition leading-loose mr-1';
                spanEn.onclick = (e) => {
                    if (e.target.classList.contains('vocab-word') || e.target.parentElement.classList.contains('vocab-word') || e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
                    playFromSentence(index);
                };
                
                p.appendChild(spanEn);
                sentences.push({ text: item.en, id: `sent-${index}` });

                const divZh = document.createElement('div');
                divZh.className = 'translation-text hidden';
                divZh.innerText = item.zh;
                p.appendChild(divZh);
            });
        }

        function processWords(text) {
            const words = text.split(' ');
            return words.map(word => {
                const cleanWord = word.replace(/[.,!?;:()"]/g, "").toLowerCase();
                const originalWord = word;
                if (vocabulary[cleanWord]) {
                    const data = vocabulary[cleanWord];
                    const isFav = favoriteWords.has(cleanWord);
                    const heartClass = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
                    
                    return `<span class="vocab-word" onclick="speakAndShowDef(event, '${cleanWord}')">${originalWord}<span class="vocab-tooltip">
                        <div class="flex justify-between items-start mb-2">
                            <span class="pos-tag text-sm">${data.pos}</span>
                            <button onclick="toggleFavorite(event, '${cleanWord}')" class="text-xl hover:scale-110 transition p-1" title="加入學習清單">
                                <i class="${heartClass}" id="heart-${cleanWord}"></i>
                            </button>
                        </div>
                        <div class="font-bold text-violet-300 text-2xl mb-2">${cleanWord}</div>
                        <div class="mb-3 text-lg font-medium">${data.trans}</div>
                        <div class="text-lg text-gray-400 italic border-t border-gray-600 pt-3 leading-relaxed">"${data.example}"</div>
                    </span></span>`;
                }
                return originalWord;
            }).join(' ');
        }
        
        function speakAndShowDef(e, word) {
            e.stopPropagation(); 
            synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(word);
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 0.9; 
            synth.speak(utterance);
        }

        function toggleFavorite(e, word) {
            if(e) e.stopPropagation();
            if (favoriteWords.has(word)) {
                favoriteWords.delete(word);
                updateHeartIcon(word, false);
            } else {
                favoriteWords.add(word);
                updateHeartIcon(word, true);
                confetti({
                    particleCount: 30,
                    spread: 40,
                    origin: { x: e ? e.clientX / window.innerWidth : 0.5, y: e ? e.clientY / window.innerHeight : 0.5 },
                    colors: ['#f472b6']
                });
            }
            document.getElementById('study-list-count').innerText = `目前收藏: ${favoriteWords.size} 個單字`;
            if(document.getElementById('study-modal').style.display === 'flex') openStudyModal();
            if(document.getElementById('vocab-modal').style.display === 'flex') openVocabModal();
        }

        function updateHeartIcon(word, isFav) {
            const icons = document.querySelectorAll(`#heart-${word}`);
            icons.forEach(icon => {
                icon.className = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
            });
        }

        function openVocabModal() {
            const container = document.getElementById('vocab-table-container');
            container.innerHTML = generateTableHTML(Object.keys(vocabulary), 'vocab');
            document.getElementById('vocab-modal').style.display = 'flex';
        }

        function openStudyModal() {
            const container = document.getElementById('study-table-container');
            if (favoriteWords.size === 0) {
                container.innerHTML = `<div class="text-center py-12 text-gray-500"><i class="far fa-heart text-4xl mb-4 text-gray-600"></i><p>您的學習清單是空的。</p><p class="text-sm">在閱讀時點擊單字上的愛心圖示即可加入。</p></div>`;
            } else {
                container.innerHTML = generateTableHTML(Array.from(favoriteWords), 'study');
            }
            document.getElementById('study-modal').style.display = 'flex';
        }

        function openMistakeModal() {
            const container = document.getElementById('mistake-table-container');
            if (wrongAnswers.length === 0) {
                 container.innerHTML = `<div class="text-center py-12 text-gray-500"><i class="fas fa-check-circle text-4xl mb-4 text-green-700"></i><p>太棒了！您沒有答錯任何題目。</p></div>`;
            } else {
                 let html = `
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-red-900/40 border-b border-red-800">
                                <th class="p-3 font-bold text-gray-300 w-4/12">題目 (Question)</th>
                                <th class="p-3 font-bold text-gray-300 w-2/12">您的答案</th>
                                <th class="p-3 font-bold text-gray-300 w-2/12">正確答案</th>
                                <th class="p-3 font-bold text-gray-300 w-4/12">詳解 (Explanation)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                `;
                wrongAnswers.forEach(item => {
                    html += `
                        <tr class="hover:bg-gray-700/50">
                            <td class="p-3 font-medium text-gray-300">${item.q.q}</td>
                            <td class="p-3 text-red-400 font-bold"><i class="fas fa-times mr-1"></i> ${item.yourAns}</td>
                            <td class="p-3 text-green-400 font-bold"><i class="fas fa-check mr-1"></i> ${item.q.ans}</td>
                            <td class="p-3 text-gray-400 text-sm">${item.q.expl}</td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            }
            document.getElementById('mistake-modal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function generateTableHTML(wordList, type) {
            if (!wordList || wordList.length === 0) return '';
            wordList.sort();
            let html = `
                <table class="w-full text-left border-collapse text-gray-200">
                    <thead>
                        <tr class="bg-gray-700 border-b border-gray-600">
                            <th class="p-3 font-bold w-1/12">收藏</th>
                            <th class="p-3 font-bold w-2/12">單字 (Word)</th>
                            <th class="p-3 font-bold w-1/12">詞性</th>
                            <th class="p-3 font-bold w-3/12">中文意思 (Meaning)</th>
                            <th class="p-3 font-bold w-5/12">例句 (Example)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
            `;
            wordList.forEach(word => {
                const data = vocabulary[word];
                if(!data) return;
                const isFav = favoriteWords.has(word);
                const heartClass = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-500";
                html += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="p-3 text-center"><button onclick="toggleFavorite(null, '${word}')" class="text-lg focus:outline-none"><i class="${heartClass}" id="heart-table-${word}"></i></button></td>
                        <td class="p-3 font-bold text-violet-400">${word}</td>
                        <td class="p-3 text-sm"><span class="bg-violet-900 text-violet-200 px-2 py-0.5 rounded text-xs font-bold">${data.pos}</span></td>
                        <td class="p-3 text-gray-300">${data.trans}</td>
                        <td class="p-3 text-gray-400 text-sm italic">"${data.example}"</td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        function printList(type) {
            const printArea = document.getElementById('print-area');
            let content = '';
            
            if (type === 'mistakes') {
                content = `
                    <div style="font-family: 'Times New Roman', serif; color: black;">
                        <h1 style="text-align: center; font-size: 24px; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px;">
                            錯題本 (Review Mistakes)
                        </h1>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f3f4f6; -webkit-print-color-adjust: exact;">
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 35%;">Question</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 10%;">Your Answer</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 10%;">Correct</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 45%;">Explanation</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                if (wrongAnswers.length === 0) {
                     content += `<tr><td colspan="4" style="text-align: center; padding: 20px;">No mistakes found. Good job!</td></tr>`;
                } else {
                    wrongAnswers.forEach(item => {
                        content += `
                            <tr>
                                <td style="border: 1px solid black; padding: 8px;">${item.q.q}</td>
                                <td style="border: 1px solid black; padding: 8px; text-align: center; color: red;">${item.yourAns}</td>
                                <td style="border: 1px solid black; padding: 8px; text-align: center; font-weight: bold;">${item.q.ans}</td>
                                <td style="border: 1px solid black; padding: 8px;">${item.q.expl}</td>
                            </tr>
                        `;
                    });
                }
                content += `</tbody></table></div>`;
            } else {
                let title = type === 'vocab' ? "完整單字表 (Vocabulary List)" : "我的學習清單 (My Study List)";
                let wordList = type === 'vocab' ? Object.keys(vocabulary) : Array.from(favoriteWords);
                wordList.sort();

                content = `
                    <div style="font-family: 'Times New Roman', serif; color: black;">
                        <h1 style="text-align: center; font-size: 24px; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px;">
                            ${title}
                        </h1>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f3f4f6; -webkit-print-color-adjust: exact;">
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 15%;">Word</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 10%;">POS</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 25%;">Meaning</th>
                                    <th style="border: 1px solid black; padding: 8px; text-align: left; width: 50%;">Example Sentence</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                if (wordList.length === 0) {
                     content += `<tr><td colspan="4" style="text-align: center; padding: 20px;">No words in list.</td></tr>`;
                } else {
                    wordList.forEach(word => {
                        const data = vocabulary[word];
                        content += `
                            <tr>
                                <td style="border: 1px solid black; padding: 8px; font-weight: bold;">${word}</td>
                                <td style="border: 1px solid black; padding: 8px; text-align: center;">${data.pos}</td>
                                <td style="border: 1px solid black; padding: 8px;">${data.trans}</td>
                                <td style="border: 1px solid black; padding: 8px; font-style: italic;">${data.example}</td>
                            </tr>
                        `;
                    });
                }
                content += `</tbody></table></div>`;
            }
            
            content += `<div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">Generated by Listening Quiz: Whispers in the Dark</div>`;
            printArea.innerHTML = content;
            window.print();
        }

        function toggleTranslation() {
            showTranslation = !showTranslation;
            const transElements = document.querySelectorAll('.translation-text');
            const btn = document.getElementById('toggle-trans-btn');
            
            transElements.forEach(el => {
                if(showTranslation) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });

            if(showTranslation) {
                btn.classList.add('bg-violet-600', 'border-violet-500');
                btn.innerHTML = '<i class="fas fa-check"></i> <span>隱藏翻譯</span>';
            } else {
                btn.classList.remove('bg-violet-600', 'border-violet-500');
                btn.innerHTML = '<i class="fas fa-language"></i> <span>顯示翻譯</span>';
            }
        }

        function togglePlay() {
            if (isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        }

        function playAudio() {
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            if (currentSentenceIndex >= sentences.length) {
                currentSentenceIndex = 0;
            }
            speakSentence(currentSentenceIndex);
        }

        function speakSentence(index) {
            if (!isPlaying || index >= sentences.length) {
                if (index >= sentences.length) {
                    isPlaying = false;
                    updatePlayBtn(false);
                    document.getElementById('visualizer').classList.remove('playing');
                    currentSentenceIndex = 0;
                    highlightSentence(-1);
                }
                return;
            }

            currentSentenceIndex = index;
            highlightSentence(index);
            updateProgressBar();

            synth.cancel();

            const text = sentences[index].text;
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 1.0; 
            utterance.pitch = 1.0; 
            
            utterance.onend = function() {
                if (isPlaying) {
                    setTimeout(() => {
                        speakSentence(index + 1);
                    }, 400); 
                }
            };
            
            utterance.onerror = function(e) {
                console.error("Speech error", e);
                isPlaying = false;
                updatePlayBtn(false);
            };

            synth.speak(utterance);
        }

        function pauseAudio() {
            isPlaying = false;
            synth.cancel();
            updatePlayBtn(false);
            document.getElementById('visualizer').classList.remove('playing');
        }

        function restartAudio() {
            synth.cancel();
            currentSentenceIndex = 0;
            updateProgressBar();
            highlightSentence(-1);
            if (isPlaying) {
                setTimeout(() => speakSentence(0), 100);
            }
        }
        
        function playFromSentence(index) {
            currentSentenceIndex = index;
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            speakSentence(index);
        }

        function updatePlayBtn(isPlay) {
            const icons = [document.getElementById('main-play-icon'), document.getElementById('mobile-play-icon')];
            icons.forEach(icon => {
                if (isPlay) {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                } else {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                }
            });
        }

        function highlightSentence(index) {
            document.querySelectorAll('.highlight-text').forEach(el => el.classList.remove('highlight-text'));
            
            if (index >= 0 && index < sentences.length) {
                const el = document.getElementById(sentences[index].id);
                if (el) {
                    el.classList.add('highlight-text');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        function updateProgressBar() {
             const progress = ((currentSentenceIndex + 1) / sentences.length) * 100;
             document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function toggleText() {
            textHidden = !textHidden;
            const overlay = document.getElementById('hidden-overlay');
            const btn = document.getElementById('toggle-text-btn');
            if (textHidden) {
                overlay.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-eye"></i> <span>Show Text</span>';
                btn.classList.replace('bg-amber-600', 'bg-violet-600');
                btn.classList.replace('hover:bg-amber-500', 'hover:bg-violet-700');
            } else {
                overlay.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> <span>Hide Text</span>';
                btn.classList.replace('bg-violet-600', 'bg-amber-600');
                btn.classList.replace('hover:bg-violet-700', 'hover:bg-amber-500');
            }
        }

        function renderQuiz() {
            const form = document.getElementById('quizForm');
            form.innerHTML = '';
            
            quizData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-900 p-5 rounded-xl border border-gray-700 shadow-sm transition hover:border-gray-600';
                div.innerHTML = `
                    <p class="font-bold text-gray-200 mb-4 text-xl">${item.q}</p>
                    <div class="space-y-3" id="${item.id}-options">
                        ${Object.keys(item.options).map(key => `
                            <label class="quiz-option flex items-center p-3 rounded-lg cursor-pointer border border-gray-700" id="${item.id}-label-${key}">
                                <input type="radio" name="${item.id}" value="${key}" class="hidden" onclick="checkAnswer('${item.id}', '${key}')">
                                <div class="w-8 h-8 rounded-full border-2 border-gray-600 flex items-center justify-center mr-3 font-bold text-gray-400 transition-colors" id="${item.id}-icon-${key}">
                                    ${key}
                                </div>
                                <span class="text-gray-300 font-medium text-lg">${item.options[key]}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div id="${item.id}-expl" class="explanation-box">
                        <p class="font-bold mb-1" id="${item.id}-status"></p>
                        <p>${item.expl}</p>
                    </div>
                `;
                form.appendChild(div);
            });
        }

        function checkAnswer(questionId, selectedKey) {
            const questionObj = quizData.find(q => q.id === questionId);
            if (!questionObj) return;

            const isCorrect = selectedKey === questionObj.ans;
            
            const selectedLabel = document.getElementById(`${questionId}-label-${selectedKey}`);
            const selectedIcon = document.getElementById(`${questionId}-icon-${selectedKey}`);
            
            if (isCorrect) {
                playCorrectSound(); 
                selectedLabel.classList.add('correct');
                selectedIcon.classList.add('border-green-500', 'text-green-300', 'bg-green-900');
                selectedIcon.innerHTML = '<i class="fas fa-check"></i>';
                userScore += (100 / 15); 
            } else {
                playFailSound(); 
                selectedLabel.classList.add('wrong');
                selectedIcon.classList.add('border-red-500', 'text-red-300', 'bg-red-900');
                selectedIcon.innerHTML = '<i class="fas fa-times"></i>';
                
                const correctLabel = document.getElementById(`${questionId}-label-${questionObj.ans}`);
                const correctIcon = document.getElementById(`${questionId}-icon-${questionObj.ans}`);
                correctLabel.classList.add('correct');
                correctIcon.classList.add('border-green-500', 'text-green-300', 'bg-green-900');
                correctIcon.innerHTML = '<i class="fas fa-check"></i>';

                wrongAnswers.push({ q: questionObj, yourAns: selectedKey });
            }

            const optionsDiv = document.getElementById(`${questionId}-options`);
            const inputs = optionsDiv.querySelectorAll('input');
            const labels = optionsDiv.querySelectorAll('label');
            
            inputs.forEach(input => input.disabled = true);
            labels.forEach(label => label.classList.add('disabled'));

            const explBox = document.getElementById(`${questionId}-expl`);
            const statusText = document.getElementById(`${questionId}-status`);
            
            explBox.style.display = 'block';
            if (isCorrect) {
                explBox.style.borderLeftColor = '#10b981';
                statusText.innerHTML = '<i class="fas fa-check-circle text-green-400"></i> Correct!';
                statusText.className = "font-bold mb-1 text-green-400";
            } else {
                explBox.style.borderLeftColor = '#ef4444';
                statusText.innerHTML = `<i class="fas fa-times-circle text-red-400"></i> Incorrect. The correct answer is ${questionObj.ans}.`;
                statusText.className = "font-bold mb-1 text-red-400";
            }
        }

        function showFinalScore() {
            const scoreDisplay = document.getElementById('final-score');
            const feedback = document.getElementById('feedback-msg');
            const resultCard = document.getElementById('score-card');
            const mistakeBtn = document.getElementById('mistake-review-btn');
            
            resultCard.classList.remove('hidden');
            let finalScore = Math.round(userScore);
            scoreDisplay.innerText = `${finalScore} / 100`;
            
            if (wrongAnswers.length > 0) {
                mistakeBtn.classList.remove('hidden');
                mistakeBtn.classList.add('flex');
            }

            if (finalScore >= 80) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#8b5cf6', '#ec4899', '#10b981', '#f59e0b']
                });
                
                if (finalScore >= 95) {
                    feedback.innerText = "Perfect! You survived the legends!";
                } else {
                    feedback.innerText = "Great job! You know your horror stories.";
                }
            } else if (finalScore >= 60) {
                feedback.innerText = "Good pass. Be careful in the dark...";
            } else {
                feedback.innerText = "Don't look behind you! Try listening again.";
            }
            
            resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>擬真語音互動測驗：Is Atlantis Real? Searching for the Lost City (Firebase Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Confetti Library for Celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: #f9fafb; /* Light background */
            color: #111827; /* Dark text */
        }
        
        /* Smooth Highlighting for Karaoke Mode */
        .highlight-text {
            background-color: #fef08a; /* yellow-200 */
            color: #854d0e; /* yellow-800 */
            padding: 2px 4px;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(234, 179, 8, 0.5);
            transition: all 0.3s ease;
            font-weight: 700;
        }
        
        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
            background-color: #ffffff; 
        }
        .quiz-option:hover:not(.disabled) {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .quiz-option.correct {
            background-color: #dcfce7 !important; /* green-100 */
            border-color: #16a34a !important;
            color: #166534;
        }
        .quiz-option.wrong {
            background-color: #fee2e2 !important; /* red-100 */
            border-color: #dc2626 !important;
            color: #991b1b;
            opacity: 0.9;
        }
        .quiz-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .explanation-box {
            display: none; /* Hidden by default */
            margin-top: 15px;
            font-size: 1.75em; /* Updated */
            color: #374151;
            background: #f9fafb;
            padding: 24px; /* Updated */
            border-radius: 12px; /* Updated */
            border-left: 6px solid #6366f1 !important; /* Updated */
            animation: slideDown 0.3s ease-out;
            line-height: 1.6;
            border: 1px solid #e5e7eb;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Interactive Vocabulary Styles */
        .vocab-word {
            border-bottom: 2px dotted #2563eb;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            color: #2563eb;
            font-weight: 500;
        }
        .vocab-word:hover {
            background-color: #dbeafe;
            color: #1e3a8a;
        }
        .vocab-word:active {
            transform: scale(0.95);
        }

        /* Tooltip Style - Enhanced for interactivity */
        .vocab-tooltip {
            visibility: hidden;
            width: max-content;
            min-width: 240px; 
            max-width: 320px;
            background-color: #ffffff; 
            color: #1f2937;
            text-align: left;
            border-radius: 8px;
            padding: 16px; 
            position: absolute;
            z-index: 100;
            bottom: 140%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            font-size: 1.1rem; 
            pointer-events: none; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            line-height: 1.5;
            border: 1px solid #e5e7eb;
        }
        
        .vocab-word:hover .vocab-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
            pointer-events: auto; 
        }

        .vocab-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #ffffff transparent transparent transparent;
            filter: drop-shadow(0 2px 1px rgba(0,0,0,0.05));
        }
        
        .pos-tag {
            font-size: 0.75em;
            text-transform: uppercase;
            background-color: #e0e7ff;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            font-weight: bold;
            color: #3730a3;
            display: inline-block;
            margin-bottom: 4px;
        }

        /* Translation Text Style */
        .translation-text {
            display: block; /* Makes it start on a new line */
            font-size: 0.95em;
            color: #4b5563;
            margin-top: 8px;
            margin-bottom: 20px;
            padding-left: 14px;
            border-left: 4px solid #cbd5e1; /* Gray bar like the screenshot */
            font-family: 'Noto Sans TC', sans-serif;
            line-height: 1.6;
        }
        .translation-text.hidden {
            display: none;
        }
        
        /* Audio Wave Animation */
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 20px;
            gap: 2px;
        }
        .bar {
            width: 4px;
            background: #60a5fa;
            animation: bounce 0ms infinite ease-in-out alternate;
        }
        .playing .bar {
            animation-duration: 400ms;
        }
        .playing .bar:nth-child(1) { animation-delay: -0.2s; }
        .playing .bar:nth-child(2) { animation-delay: -0.4s; }
        .playing .bar:nth-child(3) { animation-delay: -0.6s; }
        .playing .bar:nth-child(4) { animation-delay: -0.8s; }
        @keyframes bounce {
            0% { height: 3px; opacity: 0.5; }
            100% { height: 20px; opacity: 1; }
        }
        
        .hidden-content {
            filter: blur(8px);
            user-select: none;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #ffffff;
            border-radius: 16px;
            width: 98%; /* Updated */
            max-width: 1600px; /* Updated */
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative;
            color: #111827;
            border: 1px solid #e5e7eb;
        }

        /* Login Modal Specific */
        #login-modal {
            display: flex; /* Initially visible */
            z-index: 2000;
        }
        #login-modal .modal-content {
            width: 90%;
            max-width: 500px;
            text-align: center;
            padding: 40px;
        }

        /* Status Dot Styles */
        .status-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-left: 0;
            transition: all 0.3s ease; 
        }
        /* Dynamic Border Colors for Container */
        .status-container.loading {
            border-color: #fbbf24;
            box-shadow: 0 0 5px rgba(251, 191, 36, 0.4);
        }
        .status-container.success {
            border-color: #34d399;
            box-shadow: 0 0 5px rgba(52, 211, 153, 0.4);
        }
        .status-container.error {
            border-color: #f87171;
            box-shadow: 0 0 5px rgba(248, 113, 113, 0.4);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.loading { background-color: #fbbf24; box-shadow: 0 0 8px #fbbf24; animation: pulse 1.5s infinite; }
        .status-dot.success { background-color: #34d399; box-shadow: 0 0 8px #34d399; }
        .status-dot.error { background-color: #f87171; box-shadow: 0 0 8px #f87171; }
        .status-text { font-size: 0.75rem; color: #e5e7eb; font-weight: 500; }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* Action Buttons */
        .action-btn {
            background-color: #ffffff;
            color: #2563eb; 
            border: 1px solid #2563eb;
            transition: all 0.2s ease-in-out;
            font-weight: bold;
        }
        .action-btn:hover {
            background-color: #2563eb;
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-btn:active {
            transform: translateY(0);
        }

        /* Print Styles - Optimized */
        @media print {
            body * {
                visibility: hidden;
                color: black;
                background: white;
            }
            #print-area, #print-area * {
                visibility: visible;
                color: black;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 0; /* Updated */
            }
            @page {
                size: A4 landscape; /* Updated */
                margin: 1cm;
            }
            .no-print {
                display: none !important;
            }
            #print-area table {
                font-size: 15px !important; /* Updated */
            }
            #print-area th, #print-area td {
                padding: 8px !important; /* Updated */
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-12 text-gray-900">

    <!-- Navbar / Audio Player Sticky Header -->
    <div class="sticky top-0 z-50 bg-slate-900 text-white shadow-lg transition-all duration-300 no-print" id="audio-player-bar">
        <div class="w-[95%] max-w-[1800px] mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                
                <!-- Left: Title, User, Badges -->
                <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white shadow-lg shrink-0">
                            <i class="fas fa-landmark text-lg"></i>
                        </div>
                        
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-3">
                                <div id="header-username" class="text-sm font-bold text-blue-200 flex items-center gap-2">
                                    <i class="fas fa-user-circle"></i> <span>Guest</span>
                                </div>
                                <div class="status-container" id="cloud-status">
                                    <span class="status-dot loading"></span>
                                    <span class="status-text">連線中...</span>
                                </div>
                            </div>

                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="flex items-center gap-1 px-2 py-0.5 rounded border border-yellow-500/50 text-yellow-300 text-[10px] md:text-xs font-bold bg-yellow-900/30 whitespace-nowrap">
                                    <i class="fas fa-layer-group"></i>
                                    <span>Level: CEFR B1</span>
                                </div>
                                <div class="flex items-center gap-1 px-2 py-0.5 rounded border border-cyan-500/50 text-cyan-300 text-[10px] md:text-xs font-bold bg-cyan-900/30 whitespace-nowrap">
                                    <i class="fas fa-file-word"></i>
                                    <span>Words: ~600</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="window.togglePlay()" class="md:hidden w-10 h-10 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-500 transition shrink-0 ml-auto">
                        <i class="fas fa-play" id="mobile-play-icon"></i>
                    </button>
                </div>

                <!-- Center: Controls -->
                <div class="flex items-center gap-4 hidden md:flex">
                    <button onclick="window.restartAudio()" class="w-10 h-10 rounded-full border border-slate-600 text-slate-300 hover:bg-slate-700 flex items-center justify-center transition" title="Restart">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    
                    <button onclick="window.togglePlay()" class="w-12 h-12 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition hover:bg-blue-500">
                        <i class="fas fa-play text-xl ml-1" id="main-play-icon"></i>
                    </button>

                    <div class="equalizer" id="visualizer">
                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                    </div>
                </div>

                <!-- Right: Settings -->
                <div class="flex items-center gap-3 text-sm w-full md:w-auto justify-center md:justify-end border-t border-slate-700 md:border-t-0 pt-2 md:pt-0 mt-2 md:mt-0">
                    <button onclick="window.toggleTranslation()" id="toggle-trans-btn" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-green-400 px-3 py-1.5 rounded-lg font-bold transition border border-slate-600">
                        <i class="fas fa-language"></i> <span>翻譯</span>
                    </button>

                    <button onclick="window.toggleText()" id="toggle-text-btn" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-amber-400 px-3 py-1.5 rounded-lg font-bold transition border border-slate-600">
                        <i class="fas fa-eye-slash"></i> <span>Hide Text</span>
                    </button>
                    
                    <button onclick="window.location.reload()" title="登出 / 切換使用者" class="w-10 h-10 rounded-lg border border-red-500/50 text-red-400 hover:bg-red-900/20 flex items-center justify-center transition ml-1">
                        <i class="fas fa-sign-out-alt text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Progress Bar -->
        <div class="w-full bg-slate-800 h-1.5 no-print">
            <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="w-[95%] max-w-[1800px] mx-auto p-4 md:p-6 space-y-8 no-print">
        
        <!-- Image Card -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
             <div class="w-full h-64 md:h-96 bg-gray-100 relative overflow-hidden group">
                <img 
                    src="English-Reading-120-images/p0.jpg" 
                    alt="Is Atlantis Real? Searching for the Lost City" 
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1682687981974-c5ef2111640c?q=80&w=1200&auto=format&fit=crop';"
                >
                
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent pointer-events-none"></div>

                <div class="absolute bottom-6 left-6 right-6 text-white">
                    <div class="flex items-center gap-2 text-sm font-medium bg-black/60 w-fit px-4 py-2 rounded-full backdrop-blur-sm border border-white/20">
                        <i class="fas fa-search-location"></i> Listening Focus: History, Mythology & Archaeology
                    </div>
                </div>
            </div>
        </div>

        <!-- Vocabulary Tools Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="window.openVocabModal()" class="bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:border-blue-500 hover:shadow-lg transition flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-900 text-lg">完整單字表 (Vocabulary)</h3>
                        <p class="text-sm text-gray-500">查看所有單字與例句</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400 group-hover:text-blue-500"></i>
            </button>

            <button onclick="window.openStudyModal()" class="bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:border-pink-500 hover:shadow-lg transition flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-pink-50 text-pink-600 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-900 text-lg">我的學習清單 (Favorites)</h3>
                        <p class="text-sm text-gray-500" id="study-list-count">目前收藏: 0 個單字</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-400 group-hover:text-pink-500"></i>
            </button>
        </div>

        <!-- Text Content Area -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-200 relative">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 pb-4 border-b border-gray-200">Is Atlantis Real? Searching for the Lost City</h2>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8 text-sm text-gray-700 rounded-r-lg">
                <i class="fas fa-mouse-pointer mr-1 text-blue-600"></i> <strong>Tip:</strong> 點擊單字聽發音，點擊 ❤️ 加入學習清單。
            </div>

            <!-- Hidden Message Overlay -->
            <div id="hidden-overlay" class="hidden absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center rounded-2xl backdrop-blur-sm transition-all">
                <div class="bg-white p-6 rounded-full mb-4 border border-gray-200 shadow-xl">
                    <i class="fas fa-ear-listen text-4xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Listen Carefully</h3>
                <p class="text-gray-500 mb-6 text-center max-w-sm">The text is hidden to challenge your listening skills. Try to answer the questions by listening only!</p>
                <button onclick="window.toggleText()" class="bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700 transition shadow-lg font-bold">
                    Show Text
                </button>
            </div>

            <!-- Article Container -->
            <div id="article-display" class="prose max-w-none text-gray-700 text-xl md:text-2xl leading-loose tracking-wide space-y-8 font-serif md:font-sans">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- Quiz Area -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-200 relative">
            
            <!-- Quiz Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 border-b border-gray-200 pb-4">
                <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                    <span class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center mr-3 text-base">
                        <i class="fas fa-pen"></i>
                    </span>
                    Reading Comprehension Quiz (15 Questions)
                </h3>
                
                <button onclick="window.resetQuiz()" class="action-btn px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                    <i class="fas fa-redo-alt"></i> 重新開始 (Restart)
                </button>
            </div>
            
            <form id="quizForm" class="space-y-10">
                <!-- Questions will be generated here -->
            </form>

            <div class="mt-10 pt-8 border-t border-gray-200 flex flex-col items-center gap-4">
                <button type="button" onclick="window.showFinalScore()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-3 px-12 rounded-full shadow-xl transition transform hover:-translate-y-1 active:scale-95">
                    Show Final Score
                </button>
                
                <div id="score-card" class="hidden mt-6 text-center w-full bg-slate-50 p-8 rounded-2xl border border-slate-200 animate-fade-in relative shadow-inner">
                    <p class="text-gray-500 text-sm uppercase font-bold tracking-wider">Your Result</p>
                    <div class="text-6xl font-extrabold text-blue-600 my-4" id="final-score">0</div>
                    <p id="feedback-msg" class="text-gray-700 font-medium mb-6 text-lg"></p>
                    
                    <button id="mistake-review-btn" onclick="window.openMistakeModal()" class="hidden w-full md:w-auto bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold shadow-md transition flex items-center justify-center gap-2 mx-auto">
                        <i class="fas fa-book-dead"></i> 查看錯題本 (Review Mistakes)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col items-center justify-center gap-6 shadow-2xl border-0">
            <div class="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mb-2 shadow-sm">
                <i class="fas fa-user-astronaut text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-900">歡迎來到英語閱讀挑戰</h2>
            <p class="text-gray-500 text-base mb-2">請輸入名字以儲存您的學習進度</p>
            
            <div class="w-full space-y-4 max-w-xs">
                <input type="text" id="username-input" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-3 text-gray-900 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-center text-lg transition" placeholder="輸入您的名字 (Enter Name)">
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    開始閱讀 (Start)
                </button>
            </div>

            <div class="w-full border-t border-gray-200 pt-6 mt-4">
                <p class="text-xs text-gray-400 uppercase font-bold mb-4 tracking-wider">快速登入 (Quick Login)</p>
                <div id="quick-login-area" class="flex flex-wrap gap-2 justify-center">
                    <span class="text-sm text-gray-400">載入挑戰者名單中...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Vocabulary Modal -->
    <div id="vocab-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h3 class="text-2xl font-bold text-gray-900"><i class="fas fa-book-open text-blue-600 mr-2"></i> 完整單字表</h3>
                <button onclick="window.closeModal('vocab-modal')" class="text-gray-400 hover:text-gray-600 transition p-2 rounded-full hover:bg-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-white" id="vocab-table-container"></div>
            <div class="p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('vocab')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold shadow-sm transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印單字表 (A4)
                </button>
                <button onclick="window.closeModal('vocab-modal')" class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Study List Modal -->
    <div id="study-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h3 class="text-2xl font-bold text-gray-900"><i class="fas fa-heart text-pink-500 mr-2"></i> 我的學習清單</h3>
                <button onclick="window.closeModal('study-modal')" class="text-gray-400 hover:text-gray-600 transition p-2 rounded-full hover:bg-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-white" id="study-table-container"></div>
            <div class="p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('study')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold shadow-sm transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印學習清單 (A4)
                </button>
                <button onclick="window.closeModal('study-modal')" class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Mistake Review Modal -->
    <div id="mistake-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-red-50 rounded-t-2xl">
                <h3 class="text-2xl font-bold text-red-700"><i class="fas fa-times-circle text-red-500 mr-2"></i> 錯題本 (Mistakes Review)</h3>
                <button onclick="window.closeModal('mistake-modal')" class="text-gray-400 hover:text-gray-600 transition p-2 rounded-full hover:bg-red-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-white" id="mistake-table-container"></div>
            <div class="p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('mistakes')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold shadow-sm transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印錯題本 (A4)
                </button>
                <button onclick="window.closeModal('mistake-modal')" class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <!-- Firebase & App Logic Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, deleteField } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- Configuration ---
        const COLLECTION_NAME = 'English-Reading-120';
        const DOC_GLOBAL = 'global';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCan2_Rc26HsLkOPr0i5QrgdjAYyqcigJ0",
            authDomain: "english-reading-6b506.firebaseapp.com",
            projectId: "english-reading-6b506",
            storageBucket: "english-reading-6b506.firebasestorage.app",
            messagingSenderId: "494747176273",
            appId: "1:494747176273:web:585487fadb29b2e5e2d770",
            measurementId: "G-4JD6R9MRPQ"
        };

        let app, db, auth;
        let isFirebaseReady = false;
        let currentUser = null; 
        let unsubscribeUser = null; 

        // --- Firebase Initialization ---
        async function initFirebase() {
            try {
                updateConnectionStatus('loading', '讀取資料中...');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                
                isFirebaseReady = true;
                console.log("Firebase Connected");
                
                // Listen to Global Users List for Quick Login
                onSnapshot(doc(db, COLLECTION_NAME, DOC_GLOBAL), (docSnap) => {
                    const data = docSnap.exists() ? docSnap.data() : { users: [] };
                    renderQuickLogin(data.users || []);
                }, (error) => {
                    console.error("Global listener error:", error);
                    updateConnectionStatus('error', '雲端同步失敗');
                });

            } catch (e) {
                console.error("Firebase init error:", e);
                updateConnectionStatus('error', '連線錯誤');
            }
        }

        // --- User Logic ---
        window.startLogin = async (name) => {
            if (!name || !isFirebaseReady) return;
            const cleanName = name.trim();
            if (cleanName.length === 0) return;

            currentUser = { name: cleanName };
            document.getElementById('login-modal').style.display = 'none';
            
            document.getElementById('header-username').innerHTML = `<i class="fas fa-user-circle"></i> <span>${cleanName}</span>`;

            try {
                const globalRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                await setDoc(globalRef, {
                    users: arrayUnion({ name: cleanName })
                }, { merge: true });

                subscribeToUserData(cleanName);
            } catch (e) {
                console.error("Login save error:", e);
            }
        };

        function subscribeToUserData(userName) {
            if (unsubscribeUser) unsubscribeUser();
            
            const userDocRef = doc(db, COLLECTION_NAME, `user_${userName}`);
            
            unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                updateConnectionStatus('success', '已同步');
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.favorites) {
                        favoriteWords = new Set(data.favorites);
                        document.getElementById('study-list-count').innerText = `目前收藏: ${favoriteWords.size} 個單字`;
                        if(document.getElementById('study-modal').style.display === 'flex') window.openStudyModal();
                        if(document.getElementById('vocab-modal').style.display === 'flex') window.openVocabModal();
                    }

                    if (data.progressIndex !== undefined && data.progressIndex > 0) {
                        if (!isPlaying && data.progressIndex > currentSentenceIndex) {
                            currentSentenceIndex = data.progressIndex;
                            window.updateProgressBar();
                            window.highlightSentence(currentSentenceIndex);
                        }
                    }

                    if (data.quizAnswers) {
                         const serverAnswers = data.quizAnswers;
                         
                         userScore = 0;
                         wrongAnswers = [];
                         userAnswers = serverAnswers;
                         
                         Object.keys(serverAnswers).forEach(qid => {
                             const ans = serverAnswers[qid];
                             const qObj = quizData.find(q => q.id === qid);
                             
                             if(qObj) {
                                 if(ans === qObj.ans) userScore += (100/15);
                                 else wrongAnswers.push({q: qObj, yourAns: ans});
                             }

                             const alreadyAnswered = document.querySelector(`#${qid}-options input:disabled`);
                             if (!alreadyAnswered) {
                                 window.checkAnswer(qid, ans, true); 
                             }
                         });
                    }
                }
            }, (error) => {
                console.error("User listener error:", error);
                updateConnectionStatus('error', '同步失敗');
            });
        }

        window.saveUserData = async () => {
            if (!currentUser || !isFirebaseReady) return;
            updateConnectionStatus('loading', '同步中...');
            
            try {
                const userDocRef = doc(db, COLLECTION_NAME, `user_${currentUser.name}`);
                await setDoc(userDocRef, {
                    favorites: Array.from(favoriteWords),
                    mistakes: wrongAnswers,
                    progressIndex: currentSentenceIndex,
                    quizAnswers: userAnswers, 
                    lastUpdated: new Date()
                }, { merge: true });
            } catch (e) {
                console.error("Save error:", e);
                updateConnectionStatus('error', '存檔失敗');
            }
        };

        window.resetQuiz = async () => {
            if(!confirm("確定要重新開始測驗嗎？這將會清除您的作答紀錄與分數。(Are you sure you want to restart the quiz?)")) return;
            
            userScore = 0;
            wrongAnswers = [];
            userAnswers = {};
            
            document.querySelectorAll('.quiz-option').forEach(el => {
                el.classList.remove('correct', 'wrong', 'disabled');
            });
            document.querySelectorAll('.quiz-option input').forEach(el => {
                el.disabled = false;
                el.checked = false;
            });
            document.querySelectorAll('.quiz-option div[id*="-icon-"]').forEach(el => {
                const key = el.id.split('-').pop(); 
                el.className = "w-12 h-12 text-2xl shrink-0 rounded-full border-2 border-gray-400 flex items-center justify-center mr-4 font-bold text-gray-500 transition-colors bg-white";
                el.innerHTML = key;
            });
            document.querySelectorAll('.explanation-box').forEach(el => el.style.display = 'none');
            document.getElementById('final-score').innerText = "0";
            document.getElementById('score-card').classList.add('hidden');

            if (currentUser && isFirebaseReady) {
                 const userDocRef = doc(db, COLLECTION_NAME, `user_${currentUser.name}`);
                 await updateDoc(userDocRef, {
                     quizAnswers: deleteField(),
                     mistakes: deleteField()
                 });
            }
            
            window.scrollTo({ top: document.getElementById('quizForm').offsetTop - 100, behavior: 'smooth' });
        }

        function renderQuickLogin(users) {
            const container = document.getElementById('quick-login-area');
            container.innerHTML = '';
            
            if (!users || users.length === 0) {
                container.innerHTML = '<span class="text-sm text-gray-400 py-2">尚無挑戰者紀錄，歡迎加入！</span>';
                return;
            }

            const recentUsers = users.slice().reverse().slice(0, 5); 
            
            recentUsers.forEach(u => {
                const btn = document.createElement('button');
                btn.className = "bg-white hover:bg-blue-50 text-blue-600 border border-blue-200 px-4 py-2 rounded-full text-sm transition shadow-sm";
                btn.innerText = u.name;
                btn.onclick = () => {
                    document.getElementById('username-input').value = u.name;
                    window.startLogin(u.name);
                };
                container.appendChild(btn);
            });
        }

        function updateConnectionStatus(status, text) {
            const container = document.getElementById('cloud-status');
            const dot = container.querySelector('.status-dot');
            const label = container.querySelector('.status-text');
            
            dot.className = 'status-dot'; 
            dot.classList.add(status); 
            label.innerText = text;

            container.className = 'status-container'; 
            container.classList.add(status);
        }

        document.getElementById('login-btn').onclick = () => {
            const name = document.getElementById('username-input').value;
            window.startLogin(name);
        };
        
        initFirebase();


        // ---------------------------------------------------------
        // --- Existing App Logic (Attached to Window) ---
        // ---------------------------------------------------------
        
        let synth = window.speechSynthesis;
        let sentences = [];
        let currentSentenceIndex = 0;
        let isPlaying = false;
        let textHidden = false;
        let showTranslation = false;
        let selectedVoice = null;
        let userScore = 0;
        let favoriteWords = new Set();
        let wrongAnswers = []; 
        let userAnswers = {}; 
        let audioCtx;

        // --- Smart Lookup Map ---
        const smartLookupMap = {
            "mysteries": "mystery",
            "resources": "resource",
            "gods": "god",
            "earthquakes": "earthquake",
            "floods": "flood",
            "historians": "historian",
            "argued": "argue",
            "experts": "expert",
            "created": "create",
            "stories": "story",
            "morals": "moral",
            "defeated": "defeat",
            "records": "record",
            "invented": "invent",
            "researchers": "researcher",
            "events": "event",
            "inspired": "inspire",
            "islands": "island",
            "erupted": "erupt",
            "explosions": "explosion",
            "destroyed": "destroy",
            "tsunamis": "tsunami",
            "waves": "wave",
            "ruined": "ruin",
            "cities": "city",
            "searches": "search",
            "claimed": "claim",
            "explorers": "explorer",
            "places": "place",
            "represents": "represent",
            "connects": "connect",
            "reminds": "remind",
            "disasters": "disaster",
            "civilizations": "civilization",
            "philosophers": "philosopher"
        };

        function getSmartLookupRoot(word) {
            return smartLookupMap[word] || word;
        }

        // --- Expanded Vocabulary Data ---
        const vocabulary = {
            "advanced": {
                pos: "adj.",
                trans: "先進的；高等的",
                example: "Japan has a very advanced railway system.",
                exampleZh: "日本擁有非常先進的鐵路系統。",
                family: "advance (v./n. 進步)<br>advancement (n. 進展)",
                collocation: "advanced technology (先進技術)<br>advanced learners (高階學習者)"
            },
            "argue": {
                pos: "v.",
                trans: "爭論；主張",
                example: "The two friends always argue about which movie is better.",
                exampleZh: "這兩個朋友總是為了哪部電影更好看而爭論。",
                family: "argument (n. 爭論/論點)<br>argumentative (adj. 愛爭論的)",
                collocation: "argue with someone (與某人爭論)<br>argue for/against (主張贊成/反對)"
            },
            "civilization": {
                pos: "n.",
                trans: "文明",
                example: "The ancient Egyptian civilization built the pyramids.",
                exampleZh: "古埃及文明建造了金字塔。",
                family: "civilize (v. 使文明)<br>civilized (adj. 文明的)",
                collocation: "ancient civilization (古代文明)<br>western civilization (西方文明)"
            },
            "clever": {
                pos: "adj.",
                trans: "聰明的；巧妙的",
                example: "She is a very clever student who learns quickly.",
                exampleZh: "她是一位非常聰明的學生，學得很快。",
                family: "cleverly (adv. 聰明地)<br>cleverness (n. 聰明)",
                collocation: "clever idea (巧妙的主意)<br>clever solution (聰明的解決方案)"
            },
            "continent": {
                pos: "n.",
                trans: "大陸；洲",
                example: "Asia is the largest continent in the world.",
                exampleZh: "亞洲是世界上最大的洲。",
                family: "continental (adj. 大陸的)",
                collocation: "the African continent (非洲大陸)<br>continental drift (大陸漂移)"
            },
            "curiosity": {
                pos: "n.",
                trans: "好奇心",
                example: "Children have a natural curiosity about the world.",
                exampleZh: "兒童對世界有種天生的好奇心。",
                family: "curious (adj. 好奇的)<br>curiously (adv. 好奇地)",
                collocation: "natural curiosity (天生的好奇心)<br>satisfy one's curiosity (滿足某人的好奇心)"
            },
            "defeat": {
                pos: "v.",
                trans: "擊敗；戰勝",
                example: "Our team hopes to defeat the champions tomorrow.",
                exampleZh: "我們球隊希望明天能擊敗冠軍隊。",
                family: "defeat (n. 失敗)",
                collocation: "admit defeat (承認失敗)<br>narrowly defeat (險勝)"
            },
            "desire": {
                pos: "n.",
                trans: "渴望；慾望",
                example: "He has a strong desire to travel the world.",
                exampleZh: "他有著周遊世界的強烈渴望。",
                family: "desire (v. 渴望)<br>desirable (adj. 值得擁有的)",
                collocation: "strong desire (強烈的慾望)<br>desire for success (對成功的渴望)"
            },
            "destroy": {
                pos: "v.",
                trans: "摧毀；破壞",
                example: "The strong wind could destroy the old wooden house.",
                exampleZh: "強風可能會摧毀這間老舊木屋。",
                family: "destruction (n. 破壞)<br>destructive (adj. 破壞性的)",
                collocation: "completely destroy (徹底摧毀)<br>destroy the environment (破壞環境)"
            },
            "disaster": {
                pos: "n.",
                trans: "災難",
                example: "The flood was a major natural disaster for the town.",
                exampleZh: "這次洪水對該鎮來說是一場重大的自然災害。",
                family: "disastrous (adj. 災難性的)",
                collocation: "natural disaster (自然災害)<br>recipe for disaster (導致災難的做法)"
            },
            "earthquake": {
                pos: "n.",
                trans: "地震",
                example: "The powerful earthquake shook the buildings in the city.",
                exampleZh: "強震震動了城市裡的建築。",
                family: "(無常見衍生字)",
                collocation: "massive earthquake (強烈地震)<br>earthquake warning (地震預警)"
            },
            "empire": {
                pos: "n.",
                trans: "帝國",
                example: "The Roman empire was once the most powerful in the world.",
                exampleZh: "羅馬帝國曾是世界上最強大的帝國。",
                family: "emperor (n. 皇帝)<br>imperial (adj. 帝國的)",
                collocation: "vast empire (遼闊的帝國)<br>fall of an empire (帝國的覆滅)"
            },
            "erupt": {
                pos: "v.",
                trans: "（火山）爆發",
                example: "The volcano may erupt at any time.",
                exampleZh: "火山可能隨時會爆發。",
                family: "eruption (n. 爆發)",
                collocation: "erupt violently (猛烈爆發)<br>anger erupts (怒火爆發)"
            },
            "expert": {
                pos: "n.",
                trans: "專家",
                example: "She is an expert in computer programming.",
                exampleZh: "她是電腦程式設計方面的專家。",
                family: "expertise (n. 專業知識)<br>expertly (adv. 專業地)",
                collocation: "medical expert (醫學專家)<br>leading expert (頂尖專家)"
            },
            "explorer": {
                pos: "n.",
                trans: "探險家",
                example: "Christopher Columbus was a famous explorer.",
                exampleZh: "哥倫布是一位著名的探險家。",
                family: "explore (v. 探索)<br>exploration (n. 探險/勘查)",
                collocation: "polar explorer (極地探險家)<br>famous explorer (著名的探險家)"
            },
            "explosion": {
                pos: "n.",
                trans: "爆炸",
                example: "We heard a loud explosion coming from the factory.",
                exampleZh: "我們聽到工廠傳來巨大的爆炸聲。",
                family: "explode (v. 爆炸)<br>explosive (adj. 爆炸性的/n. 炸藥)",
                collocation: "loud explosion (巨大的爆炸)<br>population explosion (人口爆炸)"
            },
            "fake": {
                pos: "adj.",
                trans: "假的；偽造的",
                example: "He was arrested for using a fake passport.",
                exampleZh: "他因使用偽造護照而被捕。",
                family: "fake (v./n. 偽造/贗品)",
                collocation: "fake news (假新聞)<br>fake IDs (假證件)"
            },
            "greedy": {
                pos: "adj.",
                trans: "貪婪的",
                example: "The greedy man wanted to keep all the money for himself.",
                exampleZh: "那個貪婪的人想把所有的錢都據為己有。",
                family: "greed (n. 貪婪)<br>greedily (adv. 貪婪地)",
                collocation: "greedy for power (貪戀權力)<br>greedy eater (貪吃的人)"
            },
            "harmony": {
                pos: "n.",
                trans: "和諧；協調",
                example: "The dogs and cats in her house live in perfect harmony.",
                exampleZh: "她家的狗和貓和諧地生活在一起。",
                family: "harmonious (adj. 和諧的)<br>harmonize (v. 使和諧)",
                collocation: "live in harmony (和諧共處)<br>social harmony (社會和諧)"
            },
            "inspire": {
                pos: "v.",
                trans: "啟發；激勵",
                example: "Her brave actions inspire everyone around her.",
                exampleZh: "她的勇敢行為激勵了她身邊的每一個人。",
                family: "inspiration (n. 靈感/啟發)<br>inspiring (adj. 激勵人心的)",
                collocation: "inspire confidence (激發信心)<br>draw inspiration from (從...汲取靈感)"
            },
            "invent": {
                pos: "v.",
                trans: "發明；虛構",
                example: "Did Thomas Edison invent the light bulb?",
                exampleZh: "湯瑪斯·愛迪生發明了電燈泡嗎？",
                family: "invention (n. 發明)<br>inventor (n. 發明家)<br>inventive (adj. 有創造力的)",
                collocation: "invent a story (編造故事)<br>newly invented (新發明的)"
            },
            "legend": {
                pos: "n.",
                trans: "傳說；傳奇",
                example: "The legend of King Arthur is famous all over the world.",
                exampleZh: "亞瑟王的傳說聞名全世界。",
                family: "legendary (adj. 傳奇般的)",
                collocation: "local legend (當地的傳奇人物)<br>urban legend (都市傳說)"
            },
            "moral": {
                pos: "n.",
                trans: "道德；教訓",
                example: "The story teaches a good moral about telling the truth.",
                exampleZh: "這個故事教導了關於說實話的良好道德教訓。",
                family: "morality (n. 道德觀)<br>morally (adv. 道德上)",
                collocation: "high moral standards (高道德標準)<br>moral support (精神支持)"
            },
            "mystery": {
                pos: "n.",
                trans: "謎團；神祕的事物",
                example: "The missing painting remains a great mystery to the police.",
                exampleZh: "失蹤的畫作對警方來說仍是一個大謎團。",
                family: "mysterious (adj. 神祕的)<br>mysteriously (adv. 神祕地)",
                collocation: "solve a mystery (解開謎團)<br>remain a mystery (依然是個謎)"
            },
            "myth": {
                pos: "n.",
                trans: "神話；迷思",
                example: "It is a myth that bats are blind.",
                exampleZh: "蝙蝠是瞎子是一種迷思（錯誤觀點）。",
                family: "mythical (adj. 神話中的)<br>mythology (n. 神話學)",
                collocation: "ancient myth (古代神話)<br>popular myth (流行的迷思)"
            },
            "navy": {
                pos: "n.",
                trans: "海軍",
                example: "The country used its navy to protect its coastline.",
                exampleZh: "該國利用海軍保衛其海岸線。",
                family: "naval (adj. 海軍的)",
                collocation: "join the navy (加入海軍)<br>navy blue (海軍藍/深藍色)"
            },
            "peaceful": {
                pos: "adj.",
                trans: "和平的；寧靜的",
                example: "They enjoyed a peaceful walk in the park.",
                exampleZh: "他們在公園裡享受了一段寧靜的散步。",
                family: "peace (n. 和平)<br>peacefully (adv. 和平地)",
                collocation: "peaceful solution (和平解決方案)<br>peaceful protest (和平抗議)"
            },
            "philosopher": {
                pos: "n.",
                trans: "哲學家",
                example: "Plato was a famous ancient Greek philosopher.",
                exampleZh: "柏拉圖是著名的古希臘哲學家。",
                family: "philosophy (n. 哲學)<br>philosophical (adj. 哲學的)",
                collocation: "modern philosopher (現代哲學家)<br>moral philosopher (倫理哲學家)"
            },
            "politics": {
                pos: "n.",
                trans: "政治",
                example: "Many people do not like talking about politics at dinner.",
                exampleZh: "許多人不喜歡在晚餐時談論政治。",
                family: "political (adj. 政治的)<br>politician (n. 政治家)",
                collocation: "global politics (全球政治)<br>enter politics (從政)"
            },
            "proof": {
                pos: "n.",
                trans: "證據；證明",
                example: "Do you have any proof that you own this car?",
                exampleZh: "你有任何證明這輛車是你所有的證據嗎？",
                family: "prove (v. 證明)",
                collocation: "scientific proof (科學證據)<br>waterproof (adj. 防水的)"
            },
            "psychology": {
                pos: "n.",
                trans: "心理學",
                example: "Studying psychology helps us understand human behavior.",
                exampleZh: "研究心理學有助於我們理解人類行為。",
                family: "psychologist (n. 心理學家)<br>psychological (adj. 心理的)",
                collocation: "clinical psychology (臨床心理學)<br>child psychology (兒童心理學)"
            },
            "punish": {
                pos: "v.",
                trans: "懲罰",
                example: "The teacher had to punish the student for cheating.",
                exampleZh: "老師不得不因為學生作弊而懲罰他。",
                family: "punishment (n. 懲罰)",
                collocation: "severely punish (嚴厲懲罰)<br>punish by law (依法懲處)"
            },
            "record": {
                pos: "n.",
                trans: "紀錄；記載",
                example: "Keep a written record of how much money you spend.",
                exampleZh: "把你花了多少錢做一份書面紀錄。",
                family: "record (v. 錄音/錄影/紀錄)",
                collocation: "world record (世界紀錄)<br>medical record (病歷紀錄)"
            },
            "represent": {
                pos: "v.",
                trans: "代表",
                example: "The red rose is often used to represent love.",
                exampleZh: "紅玫瑰常用來代表愛。",
                family: "representation (n. 代表/呈現)<br>representative (n. 代表人)",
                collocation: "represent a country (代表一個國家)<br>legal representation (法律代理)"
            },
            "resource": {
                pos: "n.",
                trans: "資源",
                example: "Water is a very important natural resource.",
                exampleZh: "水是非常重要的自然資源。",
                family: "resourceful (adj. 足智多謀的)",
                collocation: "natural resources (自然資源)<br>human resources (人力資源/HR)"
            },
            "ruin": {
                pos: "v.",
                trans: "毀壞；破壞",
                example: "The heavy rain will ruin our picnic plans.",
                exampleZh: "大雨會毀掉我們的野餐計畫。",
                family: "ruins (n. 廢墟/遺跡)",
                collocation: "financially ruin (經濟破產)<br>ruin one's reputation (毀壞名譽)"
            },
            "sunken": {
                pos: "adj.",
                trans: "沉沒的",
                example: "Divers explored the sunken ship at the bottom of the sea.",
                exampleZh: "潛水員探索了海底的沉船。",
                family: "sink (v. 下沉)<br>sinking (n. 沉沒)",
                collocation: "sunken treasure (沉沒的寶藏)<br>sunken cheeks (凹陷的雙頰)"
            },
            "terrible": {
                pos: "adj.",
                trans: "可怕的；糟糕的",
                example: "He had a terrible headache this morning.",
                exampleZh: "他今天早上頭痛得很厲害。",
                family: "terribly (adv. 非常/糟糕地)",
                collocation: "terrible accident (可怕的意外)<br>feel terrible (感覺很糟/深感抱歉)"
            },
            "tsunami": {
                pos: "n.",
                trans: "海嘯",
                example: "A warning was issued for a possible tsunami after the earthquake.",
                exampleZh: "地震後發布了可能發生海嘯的警告。",
                family: "(無常見衍生字)",
                collocation: "tsunami wave (海嘯波)<br>deadly tsunami (致命海嘯)"
            },
            "unpredictable": {
                pos: "adj.",
                trans: "不可預測的",
                example: "The weather in the mountains is very unpredictable.",
                exampleZh: "山區的天氣非常不可預測。",
                family: "predict (v. 預測)<br>predictability (n. 可預測性)",
                collocation: "highly unpredictable (高度不可預測的)<br>unpredictable behavior (難以捉摸的行為)"
            }
        };

        const articleData = [
            // Paragraph 1
            { en: "Many mysteries interest people, but the story of Atlantis is one of the most famous.", zh: "許多謎團讓人們感興趣，但亞特蘭提斯的故事是最著名的之一。" },
            { en: "This legend comes from the ancient Greek philosopher Plato.", zh: "這個傳說來自古希臘哲學家柏拉圖。" },
            { en: "He wrote about the lost city around 360 BCE.", zh: "大約在西元前 360 年，他寫下了這座失落之城。" },
            { en: "According to Plato, Atlantis was a perfect island located far away in the ocean.", zh: "根據柏拉圖的說法，亞特蘭提斯是一個位於遙遠海洋中的完美島嶼。" },
            { en: "It was a very advanced society with a strong navy, beautiful buildings, and plenty of natural resources.", zh: "這是一個非常先進的社會，擁有強大的海軍、美麗的建築和豐富的自然資源。" },
            { en: "However, the people of Atlantis became greedy and wanted to rule the world.", zh: "然而，亞特蘭提斯的人民變得貪婪，想要統治世界。" },
            { en: "Because they were so proud and bad, the gods decided to punish them.", zh: "因為他們太過驕傲和邪惡，眾神決定懲罰他們。" },
            { en: "The gods sent terrible earthquakes and floods.", zh: "眾神降下了可怕的地震和洪水。" },
            { en: "In just one day and night, the entire island sank to the bottom of the sea.", zh: "短短一天一夜之間，整座島嶼就沉入了海底。" },

            // Paragraph 2
            { en: "For hundreds of years, historians have argued about Atlantis.", zh: "數百年來，歷史學家們一直在爭論亞特蘭提斯。" },
            { en: "Was it a real place, or did Plato just invent it?", zh: "它是一個真實的地方，還是柏拉圖發明的？" },
            { en: "Today, most experts agree that Atlantis was never a real island.", zh: "今天，大多數專家都同意亞特蘭提斯從來不是一個真實的島嶼。" },
            { en: "Instead, Plato created it as a story with a hidden lesson.", zh: "相反地，柏拉圖將它創造成一個帶有隱藏教訓的故事。" },
            { en: "Plato often used made-up stories to explain his ideas about politics.", zh: "柏拉圖經常使用虛構的故事來解釋他的政治理念。" },
            { en: "He used Atlantis to show what happens when a powerful society becomes greedy and loses its morals.", zh: "他用亞特蘭提斯來展示當一個強大的社會變得貪婪並失去道德時會發生什麼事。" },
            { en: "In his story, Atlantis fought against the ancient city of Athens.", zh: "在他的故事中，亞特蘭提斯與古城雅典交戰。" },
            { en: "Plato wrote that Athens was good and pure, so it defeated the bad people of Atlantis.", zh: "柏拉圖寫道，雅典是善良純潔的，所以它擊敗了亞特蘭提斯的壞人。" },
            { en: "Because there are absolutely no records of Atlantis before Plato, experts believe he completely invented the city.", zh: "因為在柏拉圖之前絕對沒有任何關於亞特蘭提斯的紀錄，專家認為他完全是虛構了這座城市。" },

            // Paragraph 3
            { en: "Even though Atlantis was not real, many researchers think real historical events inspired Plato’s story.", zh: "儘管亞特蘭提斯不是真的，但許多研究人員認為，真實的歷史事件啟發了柏拉圖的故事。" },
            { en: "The most likely inspiration is the sudden end of the Minoan civilization.", zh: "最有可能的靈感是米諾斯文明的突然終結。" },
            { en: "The Minoans were a peaceful and rich society that lived on islands in the Aegean Sea, mainly Crete and Thera (now called Santorini).", zh: "米諾斯人是一個和平且富裕的社會，生活在愛琴海的島嶼上，主要是克里特島和錫拉島（現在的聖托里尼）。" },
            { en: "Around 1600 BCE, a huge volcano erupted on Thera.", zh: "大約在西元前 1600 年，錫拉島上的一座巨大火山爆發了。" },
            { en: "It was one of the biggest explosions in human history.", zh: "這是人類歷史上最大的爆炸之一。" },
            { en: "The volcano destroyed the center of the island and caused giant tsunamis (ocean waves).", zh: "火山摧毀了島嶼的中心，並引發了巨大的海嘯（海浪）。" },
            { en: "These waves ruined nearby cities.", zh: "這些海浪毀壞了附近的城市。" },
            { en: "The sudden destruction of this advanced empire probably shocked the ancient world.", zh: "這個先進帝國的突然毀滅可能震驚了古代世界。" },
            { en: "Over time, people remembered this terrible event, and it slowly turned into the legend of Atlantis.", zh: "隨著時間的推移，人們記住了這場可怕的事件，它慢慢變成了亞特蘭提斯的傳說。" },

            // Paragraph 4
            { en: "Even though experts agree that Atlantis is just a myth, people still keep searching for the lost city.", zh: "儘管專家們同意亞特蘭提斯只是一個神話，人們仍然繼續尋找這座失落之城。" },
            { en: "The modern interest in Atlantis started in 1882.", zh: "現代對亞特蘭提斯的興趣始於 1882 年。" },
            { en: "An American named Ignatius Donnelly wrote a very popular book about it.", zh: "一位名叫伊格內修斯·唐納利的美國人寫了一本關於它的暢銷書。" },
            { en: "He claimed that Atlantis was a real sunken continent and the mother of all human cultures.", zh: "他聲稱亞特蘭提斯是一塊真實沉沒的大陸，也是所有人類文化的母親。" },
            { en: "This book started a wave of \"fake science.\"", zh: "這本書引發了一股「偽科學」的浪潮。" },
            { en: "It made many explorers look for the ruined city in strange places.", zh: "它讓許多探險家在奇怪的地方尋找這座廢墟城市。" },
            { en: "Over the years, excited researchers have claimed to find Atlantis in the Bermuda Triangle, under the ice of Antarctica, and even in the Sahara Desert in Africa.", zh: "多年來，興奮的研究人員聲稱在百慕達三角洲、南極洲的冰層下，甚至在非洲的撒哈拉沙漠中找到了亞特蘭提斯。" },

            // Paragraph 5
            { en: "Why do people still love the legend of Atlantis today, even without any real proof?", zh: "即使沒有任何真實的證據，為什麼人們今天仍然喜歡亞特蘭提斯的傳說？" },
            { en: "The answer is about human psychology, not history.", zh: "答案在於人類心理學，而不是歷史。" },
            { en: "Atlantis represents our deep wish for a \"golden age\"—a time when humans were incredibly smart and lived in perfect harmony.", zh: "亞特蘭提斯代表了我們對「黃金時代」的深深渴望——一個人類無比聰明並生活在完美和諧中的時代。" },
            { en: "Also, the story connects to our fear of nature.", zh: "此外，這個故事也連結到我們對自然的恐懼。" },
            { en: "It reminds us that nature is powerful and unpredictable.", zh: "它提醒我們自然是強大且不可預測的。" },
            { en: "It shows that even the most advanced and powerful societies can be destroyed by natural disasters in a single moment.", zh: "它表明，即使是最先進、最強大的社會，也可能在瞬間被自然災害摧毀。" },
            { en: "Whether Atlantis is a hidden historical fact or just a clever ancient story, it remains a famous symbol of human curiosity and our desire to explore the unknown.", zh: "無論亞特蘭提斯是一個有待發現的隱藏歷史事實，還是只是一個聰明的古代故事，它仍然是人類好奇心和我們探索未知願望的著名象徵。" }
        ];

        const quizData = [
            {
                id: 'q1',
                q: "1. What is the main topic of the first paragraph in the text?",
                options: {
                    A: "How modern scientists finally found the lost city.", 
                    B: "Why the Greek gods loved the people of Atlantis.", 
                    C: "The origin of the legend from Plato's writings.", 
                    D: "The specific methods used to build ancient ships."
                },
                ans: 'C',
                expl: "<strong>Eng:</strong> Paragraph 1 introduces the legend of Atlantis and explains that it comes from Plato's writings.<br><br><strong>Chi:</strong> 第一段介紹了亞特蘭提斯的傳說，並解釋它來自柏拉圖的著作。"
            },
            {
                id: 'q2',
                q: "2. Why did the gods decide to destroy the island of Atlantis?",
                options: {
                    A: "Because the people forgot how to build strong ships.", 
                    B: "Because the people became greedy and very proud.", 
                    C: "Because the island did not have enough fresh water.", 
                    D: "Because the citizens refused to travel to Athens."
                },
                ans: 'B',
                expl: "<strong>Eng:</strong> Paragraph 1 states the gods punished them because they \"became greedy... proud and bad.\"<br><br><strong>Chi:</strong> 第一段指出眾神懲罰他們是因為他們「變得貪婪……驕傲和邪惡」。"
            },
            {
                id: 'q3',
                q: "3. What do most modern experts believe about the city of Atlantis?",
                options: {
                    A: "They believe it is hidden under the ice in Antarctica.", 
                    B: "They believe it was a real island destroyed by Athens.", 
                    C: "They believe Plato completely invented it as a story.", 
                    D: "They believe humans will easily find it in the future."
                },
                ans: 'C',
                expl: "<strong>Eng:</strong> Paragraph 2 clearly states that experts agree \"Plato completely invented the city\" as a story.<br><br><strong>Chi:</strong> 第二段明確指出，專家們同意「柏拉圖完全虛構了這座城市」作為一個故事。"
            },
            {
                id: 'q4',
                q: "4. Why did Plato write the story of Atlantis fighting against Athens?",
                options: {
                    A: "To prove that Athens was a good and pure society.", 
                    B: "To teach people how to survive a terrible earthquake.", 
                    C: "To explain the true history of the ancient Greek gods.", 
                    D: "To help explorers find the exact location of the ruins."
                },
                ans: 'A',
                expl: "<strong>Eng:</strong> Paragraph 2 says he used the story to show that \"Athens was good and pure, so it defeated the bad people.\"<br><br><strong>Chi:</strong> 第二段說他用這個故事來展示「雅典是善良純潔的，所以它擊敗了壞人」。"
            },
            {
                id: 'q5',
                q: "5. Which historical group likely inspired the story of Atlantis?",
                options: {
                    A: "The ancient Athenian warriors on the mainland.", 
                    B: "The peaceful Minoan civilization on Aegean islands.", 
                    C: "The American politicians searching for sunken land.", 
                    D: "The Egyptian builders living near the Sahara Desert."
                },
                ans: 'B',
                expl: "<strong>Eng:</strong> Paragraph 3 explains that the \"Minoan civilization\" on the Aegean islands is the most likely inspiration.<br><br><strong>Chi:</strong> 第三段解釋說，愛琴海島嶼上的「米諾斯文明」是最有可能的靈感來源。"
            },
            {
                id: 'q6',
                q: "6. What major disaster happened to the island of Thera around 1600 BCE?",
                options: {
                    A: "A terrible disease killed the island's entire population.", 
                    B: "A powerful enemy army attacked and burned the city.", 
                    C: "A huge volcano erupted and caused giant ocean waves.", 
                    D: "A long period of dry weather ruined all the local farms."
                },
                ans: 'C',
                expl: "<strong>Eng:</strong> Paragraph 3 states that a \"huge volcano erupted... and caused giant tsunamis (ocean waves).\"<br><br><strong>Chi:</strong> 第三段指出「一座巨大火山爆發……並引發了巨大的海嘯（海浪）」。"
            },
            {
                id: 'q7',
                q: "7. How did Ignatius Donnelly change the way people thought about Atlantis?",
                options: {
                    A: "He proved that Plato's stories were completely wrong.", 
                    B: "He made people think Atlantis was a real sunken continent.", 
                    C: "He discovered ancient Greek texts hidden under the sea.", 
                    D: "He stopped people from searching in the Bermuda Triangle."
                },
                ans: 'B',
                expl: "<strong>Eng:</strong> Paragraph 4 says he claimed \"Atlantis was a real sunken continent,\" which started modern searches.<br><br><strong>Chi:</strong> 第四段說他聲稱「亞特蘭提斯是一塊真實沉沒的大陸」，這引發了現代的探索。"
            },
            {
                id: 'q8',
                q: "8. Which location is NOT mentioned as a place where people searched for Atlantis?",
                options: {
                    A: "The deep waters of the Bermuda Triangle.", 
                    B: "The cold and icy region of Antarctica.", 
                    C: "The hot and dry Sahara Desert in Africa.", 
                    D: "The dense tropical forests of the Amazon."
                },
                ans: 'D',
                expl: "<strong>Eng:</strong> Paragraph 4 mentions the Bermuda Triangle, Antarctica, and the Sahara Desert. The Amazon is not mentioned.<br><br><strong>Chi:</strong> 第四段提到了百慕達三角洲、南極洲和撒哈拉沙漠。沒有提到亞馬遜。"
            },
            {
                id: 'q9',
                q: "9. Why does the legend of Atlantis still interest people today?",
                options: {
                    A: "Because we keep finding new gold coins from the city.", 
                    B: "Because it represents our deep wish for a \"golden age.\"", 
                    C: "Because scientists have proven the story is entirely true.", 
                    D: "Because modern governments teach the story in schools."
                },
                ans: 'B',
                expl: "<strong>Eng:</strong> Paragraph 5 explains that Atlantis represents our \"deep wish for a 'golden age'.\"<br><br><strong>Chi:</strong> 第五段解釋說，亞特蘭提斯代表了我們對「黃金時代」的「深深渴望」。"
            },
            {
                id: 'q10',
                q: "10. The word \"invent\" in Paragraph 2 is closest in meaning to:",
                options: {
                    A: "To make up something entirely new.", 
                    B: "To carefully find something hidden.", 
                    C: "To slowly destroy a large building.", 
                    D: "To secretly travel to another place."
                },
                ans: 'A',
                expl: "<strong>Eng:</strong> \"Invent\" means to create or design something that has not existed before.<br><br><strong>Chi:</strong> \"Invent\" 意指創造或設計以前不存在的東西（發明/虛構）。"
            },
            {
                id: 'q11',
                q: "11. What does the term \"pure\" imply when describing ancient Athens in Paragraph 2?",
                options: {
                    A: "That the city had the strongest weapons in the world.", 
                    B: "That the citizens were morally good and not corrupt.", 
                    C: "That the drinking water was completely clean and safe.", 
                    D: "That the government was the wealthiest in the region."
                },
                ans: 'B',
                expl: "<strong>Eng:</strong> In this context, \"pure\" describes the people's good morals compared to the bad people of Atlantis.<br><br><strong>Chi:</strong> 在此語境中，「純潔的」用來形容與亞特蘭提斯的壞人相比，人們擁有良好的道德。"
            },
            {
                id: 'q12',
                q: "12. What do tsunamis usually cause, according to Paragraph 3?",
                options: {
                    A: "They cause volcanoes to explode suddenly.", 
                    B: "They cause beautiful new islands to appear.", 
                    C: "They cause extreme damage to nearby cities.", 
                    D: "They cause the weather to become very dry."
                },
                ans: 'C',
                expl: "<strong>Eng:</strong> Paragraph 3 notes that the giant tsunamis \"ruined nearby cities.\"<br><br><strong>Chi:</strong> 第三段指出巨大的海嘯「毀壞了附近的城市」。"
            },
            {
                id: 'q13',
                q: "13. What does the author mean by the phrase \"fake science\" in Paragraph 4?",
                options: {
                    A: "Real historical facts that are difficult to accept.", 
                    B: "Ideas that sound scientific but lack real evidence.", 
                    C: "Science experiments performed by young children.", 
                    D: "Technology created by highly advanced civilizations."
                },
                ans: 'B',
                expl: "<strong>Eng:</strong> \"Fake science\" refers to theories (like Donnelly's) that are not supported by actual scientific proof.<br><br><strong>Chi:</strong> 「偽科學」指的是沒有實際科學證據支持的理論（如唐納利的理論）。"
            },
            {
                id: 'q14',
                q: "14. Which of the following best describes the author's tone in the article?",
                options: {
                    A: "Angry and upset about people believing the myth.", 
                    B: "Objective and informative about history and psychology.", 
                    C: "Completely convinced that the lost city will be found.", 
                    D: "Fearful that another natural disaster will happen soon."
                },
                ans: 'B',
                expl: "<strong>Eng:</strong> The author presents facts, history, and psychological reasons in a calm and educational manner.<br><br><strong>Chi:</strong> 作者以平靜且具教育意義的方式呈現事實、歷史和心理學原因。"
            },
            {
                id: 'q15',
                q: "15. According to the conclusion in Paragraph 5, Atlantis serves as a reminder that:",
                options: {
                    A: "Humans should never build cities close to the ocean.", 
                    B: "Greek philosophers were the smartest people in history.", 
                    C: "Advanced societies can be destroyed quickly by nature.", 
                    D: "People will eventually solve all the mysteries of the past."
                },
                ans: 'C',
                expl: "<strong>Eng:</strong> Paragraph 5 concludes that the story shows \"the most advanced and powerful societies can be destroyed by natural disasters in a single moment.\"<br><br><strong>Chi:</strong> 第五段總結，這個故事表明「最先進、最強大的社會，也可能在瞬間被自然災害摧毀」。"
            }
        ];

        window.initAudioContext = function() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        window.playCorrectSound = function() {
            window.initAudioContext();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        window.playFailSound = function() {
            window.initAudioContext();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime); 
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        function initVoice() {
            const loadVoices = () => {
                const voices = synth.getVoices();
                if (voices.length > 0) {
                    selectedVoice = voices.find(v => v.name === 'Google US English') || 
                                    voices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural') && v.lang.includes('en-US')) ||
                                    voices.find(v => (v.name.includes('Siri') || v.name.includes('Enhanced') || v.name.includes('Premium')) && v.lang.includes('en-US')) ||
                                    voices.find(v => v.name === 'Samantha') || 
                                    voices.find(v => v.lang === 'en-US');
                }
            };
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        function renderArticle() {
            const displayArea = document.getElementById('article-display');
            if (!displayArea) return;
            displayArea.innerHTML = '';
            
            let p;
            sentences = []; 
            
            articleData.forEach((item, index) => {
                // Image insertion logic - Insert BEFORE the paragraph starts
                // Indices correspond to the first sentence of each paragraph in the flattened array
                if (index === 0) insertImage(displayArea, 'p1.jpg', 'The Birth of a Legend');
                else if (index === 9) insertImage(displayArea, 'p2.jpg', 'A Story with a Lesson');
                else if (index === 18) insertImage(displayArea, 'p3.jpg', 'The Real History Behind the Myth');
                else if (index === 27) insertImage(displayArea, 'p4.jpg', 'Modern Searches and Fake Science');
                else if (index === 34) insertImage(displayArea, 'p5.jpg', 'Why We Still Love the Story');
                
                // Create a new paragraph container at the start of each section
                if (index === 0 || index === 9 || index === 18 || index === 27 || index === 34) {
                    p = document.createElement('p');
                    p.className = "mb-10 text-gray-800 leading-relaxed"; 
                    displayArea.appendChild(p);
                }
                
                const spanEn = document.createElement('span');
                spanEn.innerHTML = processWords(item.en);
                spanEn.id = `sent-${index}`;
                spanEn.className = 'cursor-pointer hover:bg-yellow-100 rounded transition duration-200 leading-loose mr-1';
                spanEn.onclick = (e) => {
                    if (e.target.classList.contains('vocab-word') || e.target.parentElement.classList.contains('vocab-word') || e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
                    window.playFromSentence(index);
                };
                
                p.appendChild(spanEn);
                sentences.push({ text: item.en, id: `sent-${index}` });

                // Use SPAN instead of DIV to allow valid nesting inside P, but style it as block
                const spanZh = document.createElement('span');
                spanZh.className = 'translation-text hidden';
                spanZh.innerText = item.zh;
                p.appendChild(spanZh);
            });
        }

        function insertImage(container, filename, altText) {
             const img = document.createElement('img');
             img.src = `English-Reading-120-images/${filename}`; 
             img.alt = altText;
             img.width = 1300;
             img.height = 576;
             img.className = "w-full md:w-5/6 h-auto object-cover rounded-xl mb-8 mx-auto shadow-lg hover:shadow-2xl transition duration-500 border border-gray-100";
             img.onerror = function() { this.style.display = 'none'; };
             container.appendChild(img);
        }

        function processWords(text) {
            const words = text.split(' ');
            return words.map(word => {
                // Keep the original punctuation for display
                const originalWord = word;
                // Remove punctuation for smart lookup (keeping hyphens if any)
                const cleanWord = word.replace(/^[^a-zA-Z0-9\-]+|[^a-zA-Z0-9\-]+$/g, '').toLowerCase();
                
                // Get the root word using smart lookup
                let rootWord = getSmartLookupRoot(cleanWord);

                // Additional fallback for simple plural/past forms if not mapped
                if (!vocabulary[rootWord]) {
                    if (rootWord.endsWith('s') && vocabulary[rootWord.slice(0, -1)]) {
                        rootWord = rootWord.slice(0, -1);
                    } else if (rootWord.endsWith('ed') && vocabulary[rootWord.slice(0, -2)]) {
                        rootWord = rootWord.slice(0, -2);
                    } else if (rootWord.endsWith('ing') && vocabulary[rootWord.slice(0, -3)]) {
                        rootWord = rootWord.slice(0, -3);
                    }
                }

                if (vocabulary[rootWord]) {
                    const data = vocabulary[rootWord];
                    const isFav = favoriteWords.has(rootWord);
                    const heartClass = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
                    
                    return `<span class="vocab-word" onclick="window.speakAndShowDef(event, '${cleanWord}')">${originalWord}<span class="vocab-tooltip">
                        <div class="flex justify-between items-start mb-2">
                            <span class="pos-tag text-sm">${data.pos}</span>
                            <button onclick="window.toggleFavorite(event, '${rootWord}')" class="text-xl hover:scale-110 transition p-1 text-gray-500 hover:text-pink-500" title="加入學習清單">
                                <i class="${heartClass}" id="heart-${rootWord}"></i>
                            </button>
                        </div>
                        <div class="font-bold text-blue-800 text-2xl mb-2">${rootWord}</div>
                        <div class="mb-3 text-lg font-medium text-gray-800">${data.trans}</div>
                        <div class="text-lg text-gray-600 italic border-t border-gray-200 pt-3 leading-relaxed">"${data.example}"<br><span class="text-sm text-gray-500">${data.exampleZh}</span></div>
                    </span></span>`;
                }
                return originalWord;
            }).join(' ');
        }
        
        window.speakAndShowDef = function(e, word) {
            if(e) e.stopPropagation(); 
            synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(word);
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 0.9; 
            synth.speak(utterance);
        }

        window.toggleFavorite = function(e, word) {
            if(e) e.stopPropagation();
            if (favoriteWords.has(word)) {
                favoriteWords.delete(word);
                updateHeartIcon(word, false);
            } else {
                favoriteWords.add(word);
                updateHeartIcon(word, true);
                confetti({
                    particleCount: 30,
                    spread: 40,
                    origin: { x: e ? e.clientX / window.innerWidth : 0.5, y: e ? e.clientY / window.innerHeight : 0.5 },
                    colors: ['#ec4899', '#f43f5e']
                });
            }
            document.getElementById('study-list-count').innerText = `目前收藏: ${favoriteWords.size} 個單字`;
            if(document.getElementById('study-modal').style.display === 'flex') window.openStudyModal();
            if(document.getElementById('vocab-modal').style.display === 'flex') window.openVocabModal();

            window.saveUserData();
        }

        function updateHeartIcon(word, isFav) {
            const icons = document.querySelectorAll(`#heart-${word}`);
            icons.forEach(icon => {
                icon.className = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
            });
            const tableIcons = document.querySelectorAll(`#heart-table-${word}`);
            tableIcons.forEach(icon => {
                icon.className = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
            });
        }

        window.openVocabModal = function() {
            const container = document.getElementById('vocab-table-container');
            container.innerHTML = generateTableHTML(Object.keys(vocabulary), 'vocab');
            document.getElementById('vocab-modal').style.display = 'flex';
        }

        window.openStudyModal = function() {
            const container = document.getElementById('study-table-container');
            if (favoriteWords.size === 0) {
                container.innerHTML = `<div class="text-center py-12 text-gray-500"><i class="far fa-heart text-4xl mb-4 text-gray-300"></i><p class="text-lg">您的學習清單是空的。</p><p class="text-sm text-gray-400 mt-2">在閱讀時點擊單字上的愛心圖示即可加入。</p></div>`;
            } else {
                container.innerHTML = generateTableHTML(Array.from(favoriteWords), 'study');
            }
            document.getElementById('study-modal').style.display = 'flex';
        }

        window.openMistakeModal = function() {
            const container = document.getElementById('mistake-table-container');
            if (wrongAnswers.length === 0) {
                 container.innerHTML = `<div class="text-center py-12 text-gray-500"><i class="fas fa-check-circle text-4xl mb-4 text-green-500"></i><p class="text-lg font-bold">太棒了！</p><p class="text-sm text-gray-400 mt-2">您沒有答錯任何題目。</p></div>`;
            } else {
                 let html = `
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-red-50 border-b border-red-100 text-red-800">
                                <th class="p-4 font-bold w-4/12 rounded-tl-lg">題目 (Question)</th>
                                <th class="p-4 font-bold w-2/12">您的答案</th>
                                <th class="p-4 font-bold w-2/12">正確答案</th>
                                <th class="p-4 font-bold w-4/12 rounded-tr-lg">詳解 (Explanation)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                `;
                wrongAnswers.forEach(item => {
                    html += `
                        <tr class="hover:bg-red-50/50 transition">
                            <td class="p-4 font-medium text-gray-800">${item.q.q}</td>
                            <td class="p-4 text-red-600 font-bold"><i class="fas fa-times mr-1"></i> ${item.yourAns}</td>
                            <td class="p-4 text-green-600 font-bold"><i class="fas fa-check mr-1"></i> ${item.q.ans}</td>
                            <td class="p-4 text-gray-600 text-sm leading-relaxed">${item.q.expl}</td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            }
            document.getElementById('mistake-modal').style.display = 'flex';
        }

        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        }

        function generateTableHTML(wordList, type) {
            if (!wordList || wordList.length === 0) return '';
            wordList.sort();
            let html = `
                <table class="w-full text-left border-collapse text-gray-800">
                    <thead>
                        <tr class="bg-gray-100 border-b border-gray-200 text-gray-700">
                            <th class="p-4 font-bold w-[5%] text-lg rounded-tl-lg">收藏</th>
                            <th class="p-4 font-bold w-[12%] text-lg">單字 (Word)</th>
                            <th class="p-4 font-bold w-[6%] text-lg">詞性</th>
                            <th class="p-4 font-bold w-[12%] text-lg">中文意思 (Meaning)</th>
                            <th class="p-4 font-bold w-[25%] text-lg">例句與翻譯 (Example)</th>
                            <th class="p-4 font-bold w-[15%] text-lg">衍生字/家族字</th>
                            <th class="p-4 font-bold w-[25%] text-lg rounded-tr-lg">常見搭配詞</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
            `;
            wordList.forEach(word => {
                const data = vocabulary[word];
                if(!data) return;
                const isFav = favoriteWords.has(word);
                const heartClass = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
                html += `
                    <tr class="hover:bg-blue-50/50 transition duration-150">
                        <td class="p-4 text-center">
                            <button onclick="window.toggleFavorite(null, '${word}')" class="text-2xl focus:outline-none hover:scale-110 transition text-gray-400 hover:text-pink-500">
                                <i class="${heartClass}" id="heart-table-${word}"></i>
                            </button>
                        </td>
                        
                        <td class="p-4 font-bold text-blue-700 text-xl md:text-2xl cursor-pointer hover:text-blue-900 transition group" onclick="window.speakAndShowDef(event, '${word}')" title="點擊發音 (Click to listen)">
                            ${word}
                            <button class="no-print focus:outline-none" aria-label="Listen">
                                <i class="fas fa-volume-up text-base ml-2 opacity-50 group-hover:opacity-100 transition text-blue-400"></i>
                            </button>
                        </td>

                        <td class="p-4 text-base md:text-lg"><span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded text-sm md:text-base font-bold">${data.pos}</span></td>
                        <td class="p-4 text-gray-700 text-lg md:text-xl font-medium">${data.trans}</td>
                        <td class="p-4 text-gray-600 text-base md:text-lg leading-relaxed italic">
                            "${data.example}"<br>
                            <span class="text-sm text-gray-500">${data.exampleZh}</span>
                        </td>
                        <td class="p-4 text-gray-700 text-sm md:text-base leading-relaxed">${data.family || ''}</td>
                        <td class="p-4 text-gray-700 text-sm md:text-base leading-relaxed">${data.collocation || ''}</td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        window.printList = function(type) {
            const printArea = document.getElementById('print-area');
            let content = '';
            // 設定文章主標題
            const articleTitle = "Is Atlantis Real? Searching for the Lost City"; 
            
            if (type === 'mistakes') {
                content = `
                    <div style="font-family: 'Times New Roman', serif; color: black;">
                        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 15px;">
                            <h1 style="font-size: 26px; margin: 0 0 10px 0;">錯題本 (Review Mistakes)</h1>
                            <h2 style="text-align: center; color: #6b7280; font-size: 18px; font-weight: normal; margin-top: -10px; margin-bottom: 25px;">${articleTitle}</h2>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 15px !important;">
                            <thead>
                                <tr style="background-color: #f3f4f6; -webkit-print-color-adjust: exact;">
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 40%;">Question</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: center; width: 10%;">Your Answer</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: center; width: 10%;">Correct</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 40%;">Explanation</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                if (wrongAnswers.length === 0) {
                     content += `<tr><td colspan="4" style="text-align: center; padding: 20px;">No mistakes found. Good job!</td></tr>`;
                } else {
                    wrongAnswers.forEach(item => {
                        content += `
                            <tr>
                                <td style="border: 1px solid black; padding: 8px !important;">${item.q.q}</td>
                                <td style="border: 1px solid black; padding: 8px !important; text-align: center; color: red;">${item.yourAns}</td>
                                <td style="border: 1px solid black; padding: 8px !important; text-align: center; font-weight: bold;">${item.q.ans}</td>
                                <td style="border: 1px solid black; padding: 8px !important;">${item.q.expl}</td>
                            </tr>
                        `;
                    });
                }
                content += `</tbody></table></div>`;
            } else {
                let title = type === 'vocab' ? "完整單字表 (Vocabulary List)" : "我的學習清單 (My Study List)";
                let wordList = type === 'vocab' ? Object.keys(vocabulary) : Array.from(favoriteWords);
                wordList.sort();

                content = `
                    <div style="font-family: 'Times New Roman', serif; color: black;">
                        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 15px;">
                            <h1 style="font-size: 26px; margin: 0 0 10px 0;">${title}</h1>
                            <h2 style="text-align: center; color: #6b7280; font-size: 18px; font-weight: normal; margin-top: -10px; margin-bottom: 25px;">${articleTitle}</h2>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 15px !important;">
                            <thead>
                                <tr style="background-color: #f3f4f6; -webkit-print-color-adjust: exact;">
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 12%;">Word</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: center; width: 6%;">POS</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 12%;">Meaning</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 35%;">Example Sentence & Translation</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 15%;">Word Family</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 20%;">Collocation</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                if (wordList.length === 0) {
                     content += `<tr><td colspan="6" style="text-align: center; padding: 20px;">No words in list.</td></tr>`;
                } else {
                    wordList.forEach(word => {
                        const data = vocabulary[word];
                        content += `
                            <tr>
                                <td style="border: 1px solid black; padding: 8px !important; font-weight: bold;">${word}</td>
                                <td style="border: 1px solid black; padding: 8px !important; text-align: center;">${data.pos}</td>
                                <td style="border: 1px solid black; padding: 8px !important;">${data.trans}</td>
                                <td style="border: 1px solid black; padding: 8px !important; font-style: italic;">
                                    "${data.example}"<br><span style="font-size: 13px; color: #4b5563;">${data.exampleZh}</span>
                                </td>
                                <td style="border: 1px solid black; padding: 8px !important;">${data.family || ''}</td>
                                <td style="border: 1px solid black; padding: 8px !important;">${data.collocation || ''}</td>
                            </tr>
                        `;
                    });
                }
                content += `</tbody></table></div>`;
            }
            
            content += `<div style="margin-top: 20px; text-align: center; font-size: 14px; color: #666;">Generated by Listening Quiz App</div>`;
            printArea.innerHTML = content;
            window.print();
        }

        window.toggleTranslation = function() {
            showTranslation = !showTranslation;
            const transElements = document.querySelectorAll('.translation-text');
            const btn = document.getElementById('toggle-trans-btn');
            
            transElements.forEach(el => {
                if(showTranslation) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });

            if(showTranslation) {
                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                btn.classList.remove('bg-slate-800', 'text-green-400', 'border-slate-600', 'hover:bg-slate-700');
                btn.innerHTML = '<i class="fas fa-check"></i> <span>隱藏翻譯</span>';
            } else {
                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
                btn.classList.add('bg-slate-800', 'text-green-400', 'border-slate-600', 'hover:bg-slate-700');
                btn.innerHTML = '<i class="fas fa-language"></i> <span>顯示翻譯</span>';
            }
        }

        window.togglePlay = function() {
            if (isPlaying) {
                window.pauseAudio();
            } else {
                window.playAudio();
            }
        }

        window.playAudio = function() {
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            if (currentSentenceIndex >= sentences.length) {
                currentSentenceIndex = 0;
            }
            window.speakSentence(currentSentenceIndex);
        }

        window.speakSentence = function(index) {
            if (!isPlaying || index >= sentences.length) {
                if (index >= sentences.length) {
                    isPlaying = false;
                    updatePlayBtn(false);
                    document.getElementById('visualizer').classList.remove('playing');
                    currentSentenceIndex = 0;
                    window.highlightSentence(-1);
                    currentSentenceIndex = 0;
                    window.saveUserData();
                }
                return;
            }

            currentSentenceIndex = index;
            window.highlightSentence(index);
            window.updateProgressBar();
            window.saveUserData();

            synth.cancel();

            const text = sentences[index].text;
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 1.0; 
            utterance.pitch = 1.0; 
            
            utterance.onend = function() {
                if (isPlaying) {
                    setTimeout(() => {
                        window.speakSentence(index + 1);
                    }, 400); 
                }
            };
            
            utterance.onerror = function(e) {
                console.error("Speech error", e);
                isPlaying = false;
                updatePlayBtn(false);
            };

            synth.speak(utterance);
        }

        window.pauseAudio = function() {
            isPlaying = false;
            synth.cancel();
            updatePlayBtn(false);
            document.getElementById('visualizer').classList.remove('playing');
        }

        window.restartAudio = function() {
            synth.cancel();
            currentSentenceIndex = 0;
            window.updateProgressBar();
            window.highlightSentence(-1);
            if (isPlaying) {
                setTimeout(() => window.speakSentence(0), 100);
            }
        }
        
        window.playFromSentence = function(index) {
            currentSentenceIndex = index;
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            window.speakSentence(index);
        }

        function updatePlayBtn(isPlay) {
            const icons = [document.getElementById('main-play-icon'), document.getElementById('mobile-play-icon')];
            icons.forEach(icon => {
                if (isPlay) {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                } else {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                }
            });
        }

        window.highlightSentence = function(index) {
            document.querySelectorAll('.highlight-text').forEach(el => el.classList.remove('highlight-text'));
            
            if (index >= 0 && index < sentences.length) {
                const el = document.getElementById(sentences[index].id);
                if (el) {
                    el.classList.add('highlight-text');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        window.updateProgressBar = function() {
             const progress = ((currentSentenceIndex + 1) / sentences.length) * 100;
             document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        window.toggleText = function() {
            textHidden = !textHidden;
            const overlay = document.getElementById('hidden-overlay');
            const btn = document.getElementById('toggle-text-btn');
            if (textHidden) {
                overlay.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-eye"></i> <span>Show Text</span>';
                btn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
                btn.classList.remove('bg-slate-800', 'text-amber-400', 'border-slate-600', 'hover:bg-slate-700');
            } else {
                overlay.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> <span>Hide Text</span>';
                btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300');
                btn.classList.add('bg-slate-800', 'text-amber-400', 'border-slate-600', 'hover:bg-slate-700');
            }
        }

        function renderQuiz() {
            const form = document.getElementById('quizForm');
            if (!form) return;
            form.innerHTML = '';
            
            quizData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white p-6 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md hover:border-blue-300';
                div.innerHTML = `
                    <p class="font-bold text-gray-800 mb-6 text-3xl leading-relaxed">${item.q}</p>
                    <div class="space-y-4" id="${item.id}-options">
                        ${Object.keys(item.options).map(key => `
                            <label class="quiz-option flex items-center p-5 rounded-lg cursor-pointer border border-gray-200 hover:bg-gray-50 transition" id="${item.id}-label-${key}">
                                <input type="radio" name="${item.id}" value="${key}" class="hidden" onclick="window.checkAnswer('${item.id}', '${key}')">
                                <div class="w-12 h-12 text-2xl shrink-0 rounded-full border-2 border-gray-400 flex items-center justify-center mr-4 font-bold text-gray-500 transition-colors bg-white" id="${item.id}-icon-${key}">
                                    ${key}
                                </div>
                                <span class="text-gray-700 font-medium text-2xl leading-normal">${item.options[key]}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div id="${item.id}-expl" class="explanation-box mt-6 bg-gray-50 p-6 rounded-lg border-l-4 border-blue-500 text-gray-700 hidden">
                        <p class="font-bold mb-2 text-2xl" id="${item.id}-status"></p>
                        <p class="leading-relaxed">${item.expl}</p>
                    </div>
                `;
                form.appendChild(div);
            });
        }

        window.checkAnswer = function(questionId, selectedKey, isRestoring = false) {
            const questionObj = quizData.find(q => q.id === questionId);
            if (!questionObj) return;

            userAnswers[questionId] = selectedKey;

            const isCorrect = selectedKey === questionObj.ans;
            
            const selectedLabel = document.getElementById(`${questionId}-label-${selectedKey}`);
            const selectedIcon = document.getElementById(`${questionId}-icon-${selectedKey}`);
            
            if (isCorrect) {
                if(!isRestoring) window.playCorrectSound(); 
                selectedLabel.classList.add('correct');
                selectedIcon.classList.add('border-green-500', 'text-green-600', 'bg-green-100');
                selectedIcon.innerHTML = '<i class="fas fa-check"></i>';
                if(!isRestoring) userScore += (100 / 15); 
            } else {
                if(!isRestoring) window.playFailSound(); 
                selectedLabel.classList.add('wrong');
                selectedIcon.classList.add('border-red-500', 'text-red-600', 'bg-red-100');
                selectedIcon.innerHTML = '<i class="fas fa-times"></i>';
                
                const correctLabel = document.getElementById(`${questionId}-label-${questionObj.ans}`);
                const correctIcon = document.getElementById(`${questionId}-icon-${questionObj.ans}`);
                correctLabel.classList.add('correct');
                correctIcon.classList.add('border-green-500', 'text-green-600', 'bg-green-100');
                correctIcon.innerHTML = '<i class="fas fa-check"></i>';

                if(!isRestoring) wrongAnswers.push({ q: questionObj, yourAns: selectedKey });
            }

            const optionsDiv = document.getElementById(`${questionId}-options`);
            const inputs = optionsDiv.querySelectorAll('input');
            const labels = optionsDiv.querySelectorAll('label');
            
            inputs.forEach(input => input.disabled = true);
            labels.forEach(label => label.classList.add('disabled'));

            const explBox = document.getElementById(`${questionId}-expl`);
            const statusText = document.getElementById(`${questionId}-status`);
            
            explBox.style.display = 'block';
            if (isCorrect) {
                explBox.style.borderLeftColor = '#16a34a';
                explBox.style.backgroundColor = '#f0fdf4';
                statusText.innerHTML = '<i class="fas fa-check-circle text-green-600"></i> Correct!';
                statusText.className = "font-bold mb-1 text-green-700 text-2xl";
            } else {
                explBox.style.borderLeftColor = '#dc2626';
                explBox.style.backgroundColor = '#fef2f2';
                statusText.innerHTML = `<i class="fas fa-times-circle text-red-600"></i> Incorrect. The correct answer is ${questionObj.ans}.`;
                statusText.className = "font-bold mb-1 text-red-700 text-2xl";
            }

            if(!isRestoring) window.saveUserData();
        }

        window.showFinalScore = function() {
            const scoreDisplay = document.getElementById('final-score');
            const feedback = document.getElementById('feedback-msg');
            const resultCard = document.getElementById('score-card');
            const mistakeBtn = document.getElementById('mistake-review-btn');
            
            resultCard.classList.remove('hidden');
            let finalScore = Math.round(userScore);
            scoreDisplay.innerText = `${finalScore} / 100`;
            
            if (wrongAnswers.length > 0) {
                mistakeBtn.classList.remove('hidden');
                mistakeBtn.classList.add('flex');
            }

            if (finalScore >= 80) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b']
                });
                
                if (finalScore >= 95) {
                    feedback.innerText = "Maverick level! You are a true ace pilot!";
                } else {
                    feedback.innerText = "Great job! You're ready for TOPGUN.";
                }
            } else if (finalScore >= 60) {
                feedback.innerText = "Good pass. Keep training, wingman.";
            } else {
                feedback.innerText = "You crashed and burned. Try listening again.";
            }
            
            resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', () => {
                renderArticle();
                renderQuiz();
                initVoice();
            });
        } else {
            renderArticle();
            renderQuiz();
            initVoice();
        }
    </script>
</body>
</html>
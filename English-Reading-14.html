<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>擬真語音互動測驗：Flying Cars: Are We There Yet? (Firebase Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Confetti Library for Celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* Darker background for horror theme */
            color: #e5e7eb;
        }
        
        /* Smooth Highlighting for Karaoke Mode */
        .highlight-text {
            background-color: #4c1d95; /* violet-900 */
            color: #c4b5fd; /* violet-300 */
            padding: 2px 4px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
            border: 1px solid transparent;
            background-color: #1f2937; /* Dark gray */
        }
        .quiz-option:hover:not(.disabled) {
            background-color: #374151;
            border-color: #6b7280;
        }
        .quiz-option.correct {
            background-color: #064e3b !important;
            border-color: #10b981 !important;
            color: #a7f3d0;
        }
        .quiz-option.wrong {
            background-color: #7f1d1d !important;
            border-color: #ef4444 !important;
            color: #fca5a5;
            opacity: 0.9;
        }
        .quiz-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .explanation-box {
            display: none; /* Hidden by default */
            margin-top: 15px;
            font-size: 1.75em; /* Updated font-size */
            color: #d1d5db;
            background: #1f2937;
            padding: 24px; /* Updated padding */
            border-radius: 12px; /* Updated border-radius */
            border-left: 6px solid #6366f1; /* Updated border */
            animation: slideDown 0.3s ease-out;
            line-height: 1.6;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Interactive Vocabulary Styles */
        .vocab-word {
            border-bottom: 2px dotted #a78bfa;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            color: #a78bfa;
            font-weight: 500;
        }
        .vocab-word:hover {
            background-color: #4c1d95;
            color: #fff;
        }
        .vocab-word:active {
            transform: scale(0.95);
        }

        /* Tooltip Style - Enhanced for interactivity */
        .vocab-tooltip {
            visibility: hidden;
            width: max-content;
            min-width: 240px; 
            max-width: 320px;
            background-color: #0f172a; /* Darker blue/black */
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 16px; 
            position: absolute;
            z-index: 100;
            bottom: 140%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            font-size: 1.1rem; 
            pointer-events: none; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 0 15px rgba(139, 92, 246, 0.3); /* Glowing shadow */
            line-height: 1.5;
            border: 1px solid #4c1d95;
        }
        
        .vocab-word:hover .vocab-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
            pointer-events: auto; 
        }

        .vocab-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
        }
        
        .pos-tag {
            font-size: 0.75em;
            text-transform: uppercase;
            background-color: #5b21b6;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            font-weight: bold;
            color: #ddd6fe;
            display: inline-block;
            margin-bottom: 4px;
        }

        /* Translation Text Style */
        .translation-text {
            display: block;
            font-size: 0.95em;
            color: #9ca3af;
            margin-top: 6px;
            margin-bottom: 16px;
            padding-left: 10px;
            border-left: 3px solid #6b7280;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .translation-text.hidden {
            display: none;
        }
        
        /* Audio Wave Animation */
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 20px;
            gap: 2px;
        }
        .bar {
            width: 4px;
            background: #a78bfa;
            animation: bounce 0ms infinite ease-in-out alternate;
        }
        .playing .bar {
            animation-duration: 400ms;
        }
        .playing .bar:nth-child(1) { animation-delay: -0.2s; }
        .playing .bar:nth-child(2) { animation-delay: -0.4s; }
        .playing .bar:nth-child(3) { animation-delay: -0.6s; }
        .playing .bar:nth-child(4) { animation-delay: -0.8s; }
        @keyframes bounce {
            0% { height: 3px; opacity: 0.5; }
            100% { height: 20px; opacity: 1; }
        }
        
        .hidden-content {
            filter: blur(12px);
            user-select: none;
            pointer-events: none;
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #1f2937;
            border-radius: 16px;
            width: 98%; /* Updated width */
            max-width: 1600px; /* Updated max-width */
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            position: relative;
            color: #f3f4f6;
            border: 1px solid #374151;
        }

        /* Login Modal Specific */
        #login-modal {
            display: flex; /* Initially visible */
            z-index: 2000;
        }
        #login-modal .modal-content {
            max-width: 500px;
            text-align: center;
            padding: 40px;
            width: 90%;
        }

        /* Status Dot Styles */
        .status-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            background: rgba(17, 24, 39, 0.8);
            border-radius: 20px;
            border: 1px solid #374151; /* Default border */
            margin-left: 0;
            transition: all 0.3s ease; /* Smooth transition for color changes */
        }
        /* Dynamic Border Colors for Container */
        .status-container.loading {
            border-color: #fbbf24;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
        }
        .status-container.success {
            border-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }
        .status-container.error {
            border-color: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.loading { background-color: #fbbf24; box-shadow: 0 0 8px #fbbf24; animation: pulse 1.5s infinite; }
        .status-dot.success { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-dot.error { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-text { font-size: 0.75rem; color: #d1d5db; font-weight: 500; }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* Neon Restart Button */
        .neon-btn {
            background-color: transparent;
            color: #00ff00; /* Neon Green Text */
            border: 2px solid #00ff00;
            box-shadow: 0 0 5px #00ff00, inset 0 0 5px #00ff00;
            text-shadow: 0 0 3px #00ff00;
            transition: all 0.3s ease-in-out;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .neon-btn:hover {
            background-color: #00ff00;
            color: #000;
            box-shadow: 0 0 15px #00ff00, inset 0 0 10px #00ff00;
            transform: scale(1.02);
        }
        .neon-btn:active {
            box-shadow: 0 0 5px #00ff00;
            transform: scale(0.98);
        }

        /* Print Styles - Fully Upgraded */
        @media print {
            body * {
                visibility: hidden;
                color: black;
                background: white;
            }
            #print-area, #print-area * {
                visibility: visible;
                color: black;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 0 !important; /* Maximized viewing area */
            }
            @page {
                size: A4 landscape; /* Landscape orientation */
                margin: 1cm; /* 1cm margin */
            }
            .no-print {
                display: none !important;
            }
            
            /* Enhanced Table Print Styles */
            #print-area table {
                font-size: 15px !important;
            }
            #print-area th, #print-area td {
                padding: 8px !important;
            }
            #print-area h1 {
                font-size: 26px !important;
            }
            #print-area h2 {
                font-size: 18px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen pb-12 text-gray-100">

    <!-- Navbar / Audio Player Sticky Header -->
    <div class="sticky top-0 z-50 bg-gray-800 text-white shadow-xl border-b border-gray-700 transition-all duration-300 no-print" id="audio-player-bar">
        <div class="w-[95%] max-w-[1800px] mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                
                <!-- Left: Title, User, Badges -->
                <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                    <!-- Icon (Purple Neon) -->
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 rounded-full bg-violet-900/50 flex items-center justify-center text-violet-300 border border-violet-500 shadow-[0_0_10px_rgba(139,92,246,0.6)] shrink-0">
                            <i class="fas fa-car-side text-lg"></i>
                        </div>
                        
                        <!-- Info Column -->
                        <div class="flex flex-col gap-1">
                            
                            <!-- Top Row: User Name & Status -->
                            <div class="flex items-center gap-3">
                                <!-- Neon User Name -->
                                <div id="header-username" class="text-sm font-bold text-pink-400 drop-shadow-[0_0_3px_rgba(244,114,182,0.8)] flex items-center gap-2">
                                    <i class="fas fa-user-circle"></i> <span>Guest</span>
                                </div>
                                <!-- Firebase Status Indicator (Dynamic Border) -->
                                <div class="status-container" id="cloud-status">
                                    <span class="status-dot loading"></span>
                                    <span class="status-text">連線中...</span>
                                </div>
                            </div>

                            <!-- Bottom Row: Neon Badges -->
                            <div class="flex items-center gap-2 flex-wrap">
                                <!-- Level Badge (Neon Yellow) -->
                                <div class="flex items-center gap-1 px-2 py-0.5 rounded border border-yellow-500 text-yellow-400 shadow-[0_0_8px_rgba(234,179,8,0.4)] text-[10px] md:text-xs font-bold bg-yellow-900/20 whitespace-nowrap">
                                    <i class="fas fa-layer-group"></i>
                                    <span>Level: CEFR B1-B2 (Intermediate / Upper-Intermediate)</span>
                                </div>
                                <!-- Word Count Badge (Neon Cyan) -->
                                <div class="flex items-center gap-1 px-2 py-0.5 rounded border border-cyan-500 text-cyan-400 shadow-[0_0_8px_rgba(6,182,212,0.4)] text-[10px] md:text-xs font-bold bg-cyan-900/20 whitespace-nowrap">
                                    <i class="fas fa-file-word"></i>
                                    <span>Word Count: Approx. 700 words</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Play Button -->
                    <button onclick="window.togglePlay()" class="md:hidden w-10 h-10 bg-violet-600 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition shrink-0 ml-auto border border-violet-400 shadow-[0_0_8px_rgba(167,139,250,0.6)]">
                        <i class="fas fa-play" id="mobile-play-icon"></i>
                    </button>
                </div>

                <!-- Center: Controls -->
                <div class="flex items-center gap-4 hidden md:flex">
                    <!-- Rewind -->
                    <button onclick="window.restartAudio()" class="w-10 h-10 rounded-full border border-sky-500 text-sky-400 shadow-[0_0_8px_rgba(14,165,233,0.5)] flex items-center justify-center hover:bg-sky-900/30 transition hover:scale-105" title="Restart">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    
                    <!-- Main Play Button -->
                    <button onclick="window.togglePlay()" class="w-12 h-12 bg-violet-600 text-white rounded-full shadow-[0_0_15px_rgba(217,70,239,0.6)] flex items-center justify-center hover:scale-105 transition border-2 border-fuchsia-500">
                        <i class="fas fa-play text-xl ml-1" id="main-play-icon"></i>
                    </button>

                    <!-- Visualizer -->
                    <div class="equalizer" id="visualizer">
                        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                    </div>
                </div>

                <!-- Right: Settings -->
                <div class="flex items-center gap-3 text-sm w-full md:w-auto justify-center md:justify-end border-t md:border-gray-700 border-t-0 md:pt-0 mt-2 md:mt-0">
                    
                    <!-- Translation Toggle -->
                    <button onclick="window.toggleTranslation()" id="toggle-trans-btn" class="flex items-center gap-2 bg-gray-900 hover:bg-green-900/20 text-green-400 px-3 py-1.5 rounded-lg font-bold transition shadow-[0_0_8px_rgba(74,222,128,0.4)] border border-green-500">
                        <i class="fas fa-language"></i> <span>翻譯</span>
                    </button>

                    <!-- Toggle Text -->
                    <button onclick="window.toggleText()" id="toggle-text-btn" class="flex items-center gap-2 bg-gray-900 hover:bg-amber-900/20 text-amber-400 px-3 py-1.5 rounded-lg font-bold transition shadow-[0_0_8px_rgba(251,191,36,0.4)] border border-amber-500">
                        <i class="fas fa-eye-slash"></i> <span>Hide Text</span>
                    </button>
                    
                    <!-- Logout -->
                    <button onclick="window.location.reload()" title="登出 / 切換使用者" class="w-10 h-10 rounded-lg border border-red-500 text-red-400 shadow-[0_0_8px_rgba(239,68,68,0.5)] flex items-center justify-center hover:bg-red-900/30 transition hover:scale-105 ml-1">
                        <i class="fas fa-sign-out-alt text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Progress Bar -->
        <div class="w-full bg-gray-900 h-1.5 no-print">
            <div id="progress-bar" class="h-full bg-violet-500 w-0 transition-all duration-300 shadow-[0_0_10px_#8b5cf6]"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="w-[95%] max-w-[1800px] mx-auto p-4 md:p-6 space-y-8 no-print">
        
        <!-- Image Card -->
        <div class="bg-gray-800 rounded-2xl shadow-lg overflow-hidden border border-gray-700">
             <div class="w-full h-64 md:h-80 bg-gray-900 relative overflow-hidden group">
                <img 
                    src="English-Reading-14-images/p0.jpg" 
                    alt="Flying Cars: Are We There Yet?" 
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 opacity-80"
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1559067096-49ebca3406aa?q=80&w=1200&auto=format&fit=crop';"
                >
                <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent pointer-events-none"></div>

                <div class="absolute bottom-4 left-4 right-4 text-white">
                    <div class="flex items-center gap-2 text-sm font-medium opacity-90 backdrop-blur-sm bg-black/60 w-fit px-3 py-1 rounded-full border border-gray-600">
                        <i class="fas fa-car-side"></i> Listening Focus: Technology, Future & Transportation
                    </div>
                </div>
            </div>
        </div>

        <!-- Vocabulary Tools Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="window.openVocabModal()" class="bg-gray-800 p-4 rounded-xl shadow-md border border-gray-700 hover:border-violet-500 transition flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-violet-900/30 text-violet-400 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-200">完整單字表 (Vocabulary)</h3>
                        <p class="text-sm text-gray-400">查看所有單字與例句</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-600 group-hover:text-violet-400"></i>
            </button>

            <button onclick="window.openStudyModal()" class="bg-gray-800 p-4 rounded-xl shadow-md border border-gray-700 hover:border-pink-500 transition flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-pink-900/30 text-pink-400 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-200">我的學習清單 (Favorites)</h3>
                        <p class="text-sm text-gray-400" id="study-list-count">目前收藏: 0 個單字</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-600 group-hover:text-pink-400"></i>
            </button>
        </div>

        <!-- Text Content Area -->
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 border border-gray-700 relative">
            <h2 class="text-2xl font-bold text-gray-100 mb-6 pb-4 border-b border-gray-700">Flying Cars: Are We There Yet?</h2>
            
            <div class="bg-gray-900/50 border-l-4 border-violet-500 p-4 mb-6 text-sm text-gray-300 rounded-r-lg">
                <i class="fas fa-mouse-pointer mr-1 text-violet-400"></i> <strong>Tip:</strong> 點擊單字聽發音，點擊 ❤️ 加入學習清單。
            </div>

            <div id="hidden-overlay" class="hidden absolute inset-0 bg-gray-900/95 z-10 flex flex-col items-center justify-center rounded-2xl backdrop-blur-sm transition-all">
                <div class="bg-gray-800 p-6 rounded-full mb-4 border border-gray-700 shadow-lg shadow-violet-900/20">
                    <i class="fas fa-ear-listen text-4xl text-violet-500"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-200 mb-2">Listen Carefully</h3>
                <p class="text-gray-400 mb-6 text-center max-w-sm">The text is hidden to challenge your listening skills. Try to answer the questions by listening only!</p>
                <button onclick="window.toggleText()" class="bg-violet-600 text-white px-6 py-2 rounded-full hover:bg-violet-700 transition shadow-lg border border-violet-500">
                    Show Text
                </button>
            </div>

            <!-- Article Container: Maintained text-xl md:text-2xl leading-loose tracking-wide -->
            <div id="article-display" class="prose max-w-none text-gray-300 text-xl md:text-2xl leading-loose tracking-wide space-y-8">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- Quiz Area -->
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 border border-gray-700 relative">
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 border-b border-gray-700 pb-4">
                <h3 class="text-2xl font-bold text-gray-100 flex items-center"> <!-- Updated to text-2xl -->
                    <span class="bg-violet-900 text-violet-300 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm border border-violet-700">
                        <i class="fas fa-pen"></i>
                    </span>
                    Reading Comprehension Quiz (15 Questions)
                </h3>
                
                <button onclick="window.resetQuiz()" class="neon-btn px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                    <i class="fas fa-redo-alt"></i> 重新開始 (Restart)
                </button>
            </div>
            
            <form id="quizForm" class="space-y-8">
                <!-- Questions will be generated here -->
            </form>

            <div class="mt-8 pt-6 border-t border-gray-700 flex flex-col items-center gap-4">
                <button type="button" onclick="window.showFinalScore()" class="w-full md:w-auto bg-violet-600 hover:bg-violet-700 text-white text-lg font-bold py-3 px-10 rounded-full shadow-lg transition transform hover:-translate-y-1 active:scale-95 border border-violet-500">
                    Show Final Score
                </button>
                
                <div id="score-card" class="hidden mt-6 text-center w-full bg-gray-900 p-6 rounded-xl border border-gray-700 animate-fade-in relative">
                    <p class="text-gray-400 text-sm uppercase font-bold tracking-wider">Your Result</p>
                    <div class="text-5xl font-extrabold text-violet-400 my-2" id="final-score">0</div>
                    <p id="feedback-msg" class="text-gray-300 font-medium mb-4"></p>
                    
                    <button id="mistake-review-btn" onclick="window.openMistakeModal()" class="hidden w-full md:w-auto bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold shadow transition flex items-center justify-center gap-2 mx-auto border border-red-500">
                        <i class="fas fa-book-dead"></i> 查看錯題本 (Review Mistakes)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col items-center justify-center gap-6">
            <div class="w-16 h-16 rounded-full bg-violet-900 flex items-center justify-center text-violet-300 mb-2 border border-violet-500 shadow-lg shadow-violet-500/30">
                <i class="fas fa-user-astronaut text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">歡迎來到英語閱讀挑戰</h2>
            <p class="text-gray-400 text-sm mb-4">請輸入名字以儲存您的學習進度</p>
            
            <div class="w-full space-y-3">
                <input type="text" id="username-input" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-violet-500 text-center text-lg" placeholder="輸入您的名字 (Enter Name)">
                <button id="login-btn" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 rounded-lg transition shadow-lg">
                    開始閱讀 (Start)
                </button>
            </div>

            <div class="w-full border-t border-gray-700 pt-4 mt-2">
                <p class="text-xs text-gray-500 uppercase font-bold mb-3 tracking-wider">快速登入 (Quick Login)</p>
                <div id="quick-login-area" class="flex flex-wrap gap-2 justify-center">
                    <span class="text-sm text-gray-600">載入挑戰者名單中...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Vocabulary Modal -->
    <div id="vocab-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-4 md:p-6 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-100"><i class="fas fa-book-open text-violet-400 mr-2"></i> 完整單字表</h3>
                <button onclick="window.closeModal('vocab-modal')" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-grow" id="vocab-table-container"></div>
            <div class="p-4 border-t border-gray-700 bg-gray-800 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('vocab')" class="bg-violet-600 hover:bg-violet-700 text-white px-5 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印單字表 (A4)
                </button>
                <button onclick="window.closeModal('vocab-modal')" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Study List Modal -->
    <div id="study-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-4 md:p-6 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-100"><i class="fas fa-heart text-pink-500 mr-2"></i> 我的學習清單</h3>
                <button onclick="window.closeModal('study-modal')" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-grow" id="study-table-container"></div>
            <div class="p-4 border-t border-gray-700 bg-gray-800 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('study')" class="bg-violet-600 hover:bg-violet-700 text-white px-5 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印學習清單 (A4)
                </button>
                <button onclick="window.closeModal('study-modal')" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Mistake Review Modal -->
    <div id="mistake-modal" class="modal-backdrop">
        <div class="modal-content flex flex-col max-h-[90vh]">
            <div class="p-4 md:p-6 border-b border-gray-700 flex justify-between items-center bg-red-900/30 rounded-t-2xl">
                <h3 class="text-xl font-bold text-red-400"><i class="fas fa-times-circle text-red-500 mr-2"></i> 錯題本 (Mistakes Review)</h3>
                <button onclick="window.closeModal('mistake-modal')" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-grow" id="mistake-table-container"></div>
            <div class="p-4 border-t border-gray-700 bg-gray-800 rounded-b-2xl flex justify-end gap-3">
                <button onclick="window.printList('mistakes')" class="bg-violet-600 hover:bg-violet-700 text-white px-5 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                    <i class="fas fa-print"></i> 列印錯題本 (A4)
                </button>
                <button onclick="window.closeModal('mistake-modal')" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-5 py-2 rounded-lg font-bold transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <!-- Firebase & App Logic Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, deleteField } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- Configuration ---
        const COLLECTION_NAME = 'English-Reading-14';
        const DOC_GLOBAL = 'global';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCan2_Rc26HsLkOPr0i5QrgdjAYyqcigJ0",
            authDomain: "english-reading-6b506.firebaseapp.com",
            projectId: "english-reading-6b506",
            storageBucket: "english-reading-6b506.firebasestorage.app",
            messagingSenderId: "494747176273",
            appId: "1:494747176273:web:585487fadb29b2e5e2d770",
            measurementId: "G-4JD6R9MRPQ"
        };

        let app, db, auth;
        let isFirebaseReady = false;
        let currentUser = null; 
        let unsubscribeUser = null; 

        // --- Firebase Initialization ---
        async function initFirebase() {
            try {
                updateConnectionStatus('loading', '讀取資料中...');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                
                isFirebaseReady = true;
                console.log("Firebase Connected");
                
                onSnapshot(doc(db, COLLECTION_NAME, DOC_GLOBAL), (docSnap) => {
                    const data = docSnap.exists() ? docSnap.data() : { users: [] };
                    renderQuickLogin(data.users || []);
                }, (error) => {
                    console.error("Global listener error:", error);
                    updateConnectionStatus('error', '雲端同步失敗');
                });

            } catch (e) {
                console.error("Firebase init error:", e);
                updateConnectionStatus('error', '連線錯誤');
            }
        }

        // --- User Logic ---
        window.startLogin = async (name) => {
            if (!name || !isFirebaseReady) return;
            const cleanName = name.trim();
            if (cleanName.length === 0) return;

            currentUser = { name: cleanName };
            document.getElementById('login-modal').style.display = 'none';
            
            document.getElementById('header-username').innerHTML = `<i class="fas fa-user-circle"></i> <span>${cleanName}</span>`;

            try {
                const globalRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                await setDoc(globalRef, {
                    users: arrayUnion({ name: cleanName })
                }, { merge: true });

                subscribeToUserData(cleanName);
            } catch (e) {
                console.error("Login save error:", e);
            }
        };

        function subscribeToUserData(userName) {
            if (unsubscribeUser) unsubscribeUser();
            
            const userDocRef = doc(db, COLLECTION_NAME, `user_${userName}`);
            
            unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                updateConnectionStatus('success', '已同步');
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.favorites) {
                        favoriteWords = new Set(data.favorites);
                        document.getElementById('study-list-count').innerText = `目前收藏: ${favoriteWords.size} 個單字`;
                        if(document.getElementById('study-modal').style.display === 'flex') window.openStudyModal();
                        if(document.getElementById('vocab-modal').style.display === 'flex') window.openVocabModal();
                    }

                    if (data.progressIndex !== undefined && data.progressIndex > 0) {
                        if (!isPlaying && data.progressIndex > currentSentenceIndex) {
                            currentSentenceIndex = data.progressIndex;
                            window.updateProgressBar();
                            window.highlightSentence(currentSentenceIndex);
                        }
                    }

                    if (data.quizAnswers) {
                         const serverAnswers = data.quizAnswers;
                         userScore = 0;
                         wrongAnswers = [];
                         userAnswers = serverAnswers;
                         
                         Object.keys(serverAnswers).forEach(qid => {
                             const ans = serverAnswers[qid];
                             const qObj = quizData.find(q => q.id === qid);
                             
                             if(qObj) {
                                 if(ans === qObj.ans) userScore += (100/15);
                                 else wrongAnswers.push({q: qObj, yourAns: ans});
                             }

                             const alreadyAnswered = document.querySelector(`#${qid}-options input:disabled`);
                             if (!alreadyAnswered) {
                                 window.checkAnswer(qid, ans, true); 
                             }
                         });
                    }
                }
            }, (error) => {
                console.error("User listener error:", error);
                updateConnectionStatus('error', '同步失敗');
            });
        }

        window.saveUserData = async () => {
            if (!currentUser || !isFirebaseReady) return;
            updateConnectionStatus('loading', '同步中...');
            
            try {
                const userDocRef = doc(db, COLLECTION_NAME, `user_${currentUser.name}`);
                await setDoc(userDocRef, {
                    favorites: Array.from(favoriteWords),
                    mistakes: wrongAnswers,
                    progressIndex: currentSentenceIndex,
                    quizAnswers: userAnswers,
                    lastUpdated: new Date()
                }, { merge: true });
            } catch (e) {
                console.error("Save error:", e);
                updateConnectionStatus('error', '存檔失敗');
            }
        };

        window.resetQuiz = async () => {
            if(!confirm("確定要重新開始測驗嗎？這將會清除您的作答紀錄與分數。(Are you sure you want to restart the quiz?)")) return;
            
            userScore = 0;
            wrongAnswers = [];
            userAnswers = {};
            
            document.querySelectorAll('.quiz-option').forEach(el => {
                el.classList.remove('correct', 'wrong', 'disabled');
            });
            document.querySelectorAll('.quiz-option input').forEach(el => {
                el.disabled = false;
                el.checked = false;
            });
            document.querySelectorAll('.quiz-option div').forEach(el => {
                const key = el.id.split('-').pop(); 
                el.className = "w-12 h-12 text-2xl rounded-full border-2 border-gray-600 flex items-center justify-center mr-3 font-bold text-gray-400 transition-colors";
                el.innerHTML = key;
            });
            document.querySelectorAll('.explanation-box').forEach(el => el.style.display = 'none');
            document.getElementById('final-score').innerText = "0";
            document.getElementById('score-card').classList.add('hidden');

            if (currentUser && isFirebaseReady) {
                 const userDocRef = doc(db, COLLECTION_NAME, `user_${currentUser.name}`);
                 await updateDoc(userDocRef, {
                     quizAnswers: deleteField(),
                     mistakes: deleteField()
                 });
            }
            
            window.scrollTo({ top: document.getElementById('quizForm').offsetTop - 100, behavior: 'smooth' });
        }

        function renderQuickLogin(users) {
            const container = document.getElementById('quick-login-area');
            container.innerHTML = '';
            
            if (!users || users.length === 0) {
                container.innerHTML = '<span class="text-sm text-gray-500 py-2">尚無挑戰者紀錄，歡迎加入！</span>';
                return;
            }

            const recentUsers = users.slice().reverse().slice(0, 5); 
            
            recentUsers.forEach(u => {
                const btn = document.createElement('button');
                btn.className = "bg-gray-800 hover:bg-gray-700 text-violet-300 border border-violet-900 px-4 py-2 rounded-full text-sm transition";
                btn.innerText = u.name;
                btn.onclick = () => {
                    document.getElementById('username-input').value = u.name;
                    window.startLogin(u.name);
                };
                container.appendChild(btn);
            });
        }

        function updateConnectionStatus(status, text) {
            const container = document.getElementById('cloud-status');
            const dot = container.querySelector('.status-dot');
            const label = container.querySelector('.status-text');
            
            dot.className = 'status-dot'; 
            dot.classList.add(status); 
            label.innerText = text;

            container.className = 'status-container'; 
            container.classList.add(status);
        }

        document.getElementById('login-btn').onclick = () => {
            const name = document.getElementById('username-input').value;
            window.startLogin(name);
        };
        
        initFirebase();


        // ---------------------------------------------------------
        // --- App Logic & Enhanced Vocabulary ---
        // ---------------------------------------------------------
        
        let synth = window.speechSynthesis;
        let sentences = [];
        let currentSentenceIndex = 0;
        let isPlaying = false;
        let textHidden = false;
        let showTranslation = false;
        let selectedVoice = null;
        let userScore = 0;
        let favoriteWords = new Set();
        let wrongAnswers = []; 
        let userAnswers = {}; 
        let audioCtx;

        // Expanded Vocabulary with Families & Collocations
        const vocabulary = {
            "advance": { pos: "v.", trans: "進步；前進", example: "Technology advances very quickly these days.", exampleZh: "現今科技進步得非常快。", family: "advancement (n. 晉升/進展)<br>advanced (adj. 先進的)", collocation: "advance rapidly (快速進步)<br>in advance (事先/提前)" },
            "aircraft": { pos: "n.", trans: "飛機；飛行器", example: "The pilot landed the aircraft safely.", exampleZh: "飛行員安全地降落了這架飛機。", family: "(無特別常見衍生字)", collocation: "military aircraft (軍用飛機)<br>board an aircraft (登機)" },
            "annoying": { pos: "adj.", trans: "煩人的", example: "The loud music from the neighbor is very annoying.", exampleZh: "鄰居傳來的嘈雜音樂非常煩人。", family: "annoy (v. 惹惱)<br>annoyance (n. 煩惱)<br>annoyed (adj. 感到煩躁的)", collocation: "highly annoying (非常煩人的)<br>find it annoying (覺得它很煩)" },
            "asphalt": { pos: "n.", trans: "瀝青；柏油", example: "The workers are laying fresh asphalt on the road.", exampleZh: "工人們正在路上鋪設新的柏油。", family: "(無特別常見衍生字)", collocation: "lay asphalt (鋪設柏油)<br>asphalt road (柏油路)" },
            "authority": { pos: "n.", trans: "當局；權威", example: "The police have the authority to arrest criminals.", exampleZh: "警察有逮捕罪犯的權力。", family: "authorize (v. 授權)<br>authoritative (adj. 權威的/官方的)", collocation: "local authority (地方當局)<br>have the authority to (有權力去...)" },
            "autonomous": { pos: "adj.", trans: "自動的；自主的", example: "Autonomous cars can drive without a human pilot.", exampleZh: "自動駕駛汽車可以在沒有人類駕駛的情況下行駛。", family: "autonomy (n. 自治/自主權)<br>autonomously (adv. 獨立自主地)", collocation: "autonomous vehicle (自動駕駛車輛)<br>fully autonomous (全自動的)" },
            "aviation": { pos: "n.", trans: "航空", example: "He is studying to work in the aviation industry.", exampleZh: "他正在學習以便未來在航空業工作。", family: "aviator (n. 飛行員)", collocation: "aviation industry (航空業)<br>civil aviation (民航)" },
            "capacity": { pos: "n.", trans: "容量；能力", example: "The stadium has a capacity of 50,000 people.", exampleZh: "這座體育場可容納五萬人。", family: "capacious (adj. 寬敞的)", collocation: "full capacity (滿載/全能)<br>storage capacity (儲存容量)" },
            "certify": { pos: "v.", trans: "認證；證明", example: "The inspector must certify that the building is safe.", exampleZh: "檢查員必須證明這棟建築是安全的。", family: "certificate (n. 證書)<br>certification (n. 認證)<br>certified (adj. 經過認證的)", collocation: "officially certify (官方認證)<br>board certified (獲得委員會認證的)" },
            "chaotic": { pos: "adj.", trans: "混亂的", example: "The scene after the earthquake was chaotic.", exampleZh: "地震後的現場一片混亂。", family: "chaos (n. 混亂)<br>chaotically (adv. 混亂地)", collocation: "chaotic situation (混亂的局勢)<br>completely chaotic (完全混亂的)" },
            "collision": { pos: "n.", trans: "碰撞", example: "The accident was a head-on collision between two cars.", exampleZh: "這起事故是兩輛車的迎面相撞。", family: "collide (v. 碰撞)", collocation: "avoid a collision (避免碰撞)<br>head-on collision (迎面相撞)" },
            "commute": { pos: "n./v.", trans: "通勤", example: "My daily commute to work takes 45 minutes.", exampleZh: "我每天上班的通勤時間需要45分鐘。", family: "commuter (n. 通勤者)", collocation: "daily commute (每日通勤)<br>long commute (漫長的通勤)" },
            "complex": { pos: "adj.", trans: "複雜的", example: "The math problem was too complex for me to solve.", exampleZh: "這道數學題太複雜了，我解不出來。", family: "complexity (n. 複雜性)", collocation: "complex problem (複雜的問題)<br>highly complex (高度複雜的)" },
            "concept": { pos: "n.", trans: "概念", example: "The concept of flying cars is exciting.", exampleZh: "飛行汽車的概念令人興奮。", family: "conceptual (adj. 概念上的)<br>conceptualize (v. 構想出)", collocation: "basic concept (基本概念)<br>grasp the concept (掌握概念)" },
            "consequence": { pos: "n.", trans: "後果", example: "Every action has a consequence.", exampleZh: "每一個行動都會產生後果。", family: "consequent (adj. 隨之發生的)<br>consequently (adv. 因此)", collocation: "serious consequence (嚴重的後果)<br>suffer the consequences (承擔後果)" },
            "deadly": { pos: "adj.", trans: "致命的", example: "Snake venom can be deadly if not treated.", exampleZh: "如果不治療，蛇毒可能是致命的。", family: "dead (adj. 死的)<br>death (n. 死亡)", collocation: "deadly weapon (致命武器)<br>deadly disease (致命疾病)" },
            "decade": { pos: "n.", trans: "十年", example: "He has worked at the company for over a decade.", exampleZh: "他在這家公司工作了十多年。", family: "decadal (adj. 十年的)", collocation: "for a decade (十年來)<br>over the past decade (在過去十年裡)" },
            "efficient": { pos: "adj.", trans: "有效率的", example: "LED lights are more efficient than old light bulbs.", exampleZh: "LED燈比舊燈泡更有效率。", family: "efficiency (n. 效率)<br>efficiently (adv. 有效率地)", collocation: "highly efficient (高效率的)<br>energy-efficient (節能的)" },
            "function": { pos: "v.", trans: "運作；功能", example: "This machine does not function properly.", exampleZh: "這台機器無法正常運作。", family: "functional (adj. 實用的/起作用的)<br>malfunction (n./v. 故障)", collocation: "function properly (正常運作)<br>vital function (重要的功能)" },
            "imagine": { v: "v.", trans: "想像", example: "Can you imagine a world without the internet?", exampleZh: "你能想像一個沒有網路的世界嗎？", family: "imagination (n. 想像力)<br>imaginative (adj. 富有想像力的)<br>imaginary (adj. 虛構的)", collocation: "hard to imagine (很難想像)<br>try to imagine (試著想像)" },
            "infrastructure": { pos: "n.", trans: "基礎設施", example: "The country needs to improve its infrastructure, like roads and bridges.", exampleZh: "這個國家需要改善其基礎設施，如道路和橋樑。", family: "structural (adj. 結構的)", collocation: "critical infrastructure (關鍵基礎設施)<br>build infrastructure (建設基礎設施)" },
            "limitation": { pos: "n.", trans: "限制", example: "Every technology has its limitation.", exampleZh: "每種科技都有其限制。", family: "limit (v./n. 限制)<br>limited (adj. 有限的)", collocation: "severe limitation (嚴重的限制)<br>overcome limitations (克服限制)" },
            "manufacture": { pos: "v.", trans: "製造", example: "This factory can manufacture thousands of cars a year.", exampleZh: "這家工廠每年可以製造數千輛汽車。", family: "manufacturer (n. 製造商)<br>manufacturing (n. 製造業)", collocation: "manufacture goods (製造商品)<br>locally manufactured (本地製造的)" },
            "mobility": { pos: "n.", trans: "流動性；移動能力", example: "The injury affected his mobility.", exampleZh: "受傷影響了他的移動能力。", family: "mobile (adj. 可移動的)<br>mobilize (v. 動員)", collocation: "upward mobility (向上流動)<br>limited mobility (行動不便)" },
            "obstacle": { pos: "n.", trans: "障礙", example: "Fear is often the biggest obstacle to success.", exampleZh: "恐懼通常是成功最大的障礙。", family: "(無特別常見衍生字)", collocation: "overcome an obstacle (克服障礙)<br>major obstacle (主要障礙)" },
            "predict": { pos: "v.", trans: "預測", example: "Experts predict that the economy will grow next year.", exampleZh: "專家預測明年經濟將會成長。", family: "prediction (n. 預測)<br>predictable (adj. 可預測的)", collocation: "accurately predict (準確預測)<br>predict the future (預測未來)" },
            "reality": { pos: "n.", trans: "現實", example: "Virtual reality is becoming more popular.", exampleZh: "虛擬實境變得越來越受歡迎。", family: "real (adj. 真實的)<br>realize (v. 了解/實現)<br>realistic (adj. 寫實的)", collocation: "face reality (面對現實)<br>virtual reality (VR/虛擬實境)" },
            "recharge": { pos: "v.", trans: "充電", example: "I need to recharge my phone battery.", exampleZh: "我需要給手機電池充電。", family: "charge (v./n. 充電/收費)<br>rechargeable (adj. 可充電的)", collocation: "recharge fully (充滿電)<br>rechargeable battery (充電電池)" },
            "regulation": { pos: "n.", trans: "法規；規則", example: "We must follow the safety regulations.", exampleZh: "我們必須遵守安全法規。", family: "regulate (v. 管制/調節)<br>regulatory (adj. 監管的)", collocation: "safety regulation (安全法規)<br>strict regulation (嚴格的法規)" },
            "resident": { pos: "n.", trans: "居民", example: "The residents of the building complained about the noise.", exampleZh: "這棟建築的居民抱怨噪音。", family: "reside (v. 居住)<br>residential (adj. 住宅的)<br>residence (n. 住所)", collocation: "local resident (當地居民)<br>long-term resident (長期居民)" },
            "revolution": { pos: "n.", trans: "革命", example: "The internet caused a revolution in communication.", exampleZh: "網際網路引發了通訊領域的革命。", family: "revolutionary (adj. 革命性的)<br>revolutionize (v. 使發生革命性劇變)", collocation: "industrial revolution (工業革命)<br>technological revolution (科技革命)" },
            "rotor": { pos: "n.", trans: "旋翼", example: "The helicopter's rotor spun faster and faster.", exampleZh: "直升機的旋翼轉得越來越快。", family: "rotate (v. 旋轉)<br>rotation (n. 旋轉)", collocation: "helicopter rotor (直升機旋翼)<br>tail rotor (尾旋翼)" },
            "runway": { pos: "n.", trans: "跑道", example: "The plane taxied down the runway before taking off.", exampleZh: "飛機起飛前在跑道上滑行。", family: "run (v. 跑)<br>way (n. 道路)", collocation: "airport runway (機場跑道)<br>fashion runway (時尚伸展台)" },
            "soar": { pos: "v.", trans: "翱翔；高飛", example: "The eagle soared high above the mountains.", exampleZh: "老鷹在群山之上高高翱翔。", family: "soaring (adj. 猛增的/高聳的)", collocation: "prices soar (物價飛漲)<br>soar into the sky (沖向雲霄)" },
            "theoretically": { pos: "adv.", trans: "理論上地", example: "Theoretically, we could live on the moon, but it's difficult.", exampleZh: "理論上，我們可以在月球上生活，但這很困難。", family: "theory (n. 理論)<br>theoretical (adj. 理論上的)", collocation: "theoretically possible (理論上可行)<br>theoretically speaking (理論上來說)" },
            "transportation": { pos: "n.", trans: "交通運輸", example: "Public transportation includes buses and trains.", exampleZh: "大眾運輸包括公車和火車。", family: "transport (v./n. 運輸/交通工具)", collocation: "public transportation (大眾運輸)<br>mode of transportation (交通方式)" },
            "ultimate": { pos: "adj.", trans: "終極的；最終的", example: "Climbing Mount Everest was his ultimate goal.", exampleZh: "攀登聖母峰是他的終極目標。", family: "ultimately (adv. 最終)<br>ultimatum (n. 最後通牒)", collocation: "ultimate goal (終極目標)<br>ultimate choice (最終選擇)" },
            "urban": { pos: "adj.", trans: "城市的", example: "Pollution is a major problem in urban areas.", exampleZh: "污染是都會區的一大問題。", family: "urbanize (v. 使都市化)<br>urbanization (n. 都市化)<br>suburb (n. 郊區)", collocation: "urban area (市區/都會區)<br>urban development (都市發展)" },
            "vehicle": { pos: "n.", trans: "車輛；載具", example: "A bicycle is a type of vehicle.", exampleZh: "腳踏車是一種交通工具。", family: "vehicular (adj. 車輛的)", collocation: "motor vehicle (機動車輛)<br>autonomous vehicle (自動駕駛車輛)" },
            "vertical": { pos: "adj.", trans: "垂直的", example: "The rocket took off in a vertical direction.", exampleZh: "火箭沿垂直方向起飛。", family: "vertically (adv. 垂直地)", collocation: "vertical drop (垂直落差)<br>vertical line (垂直線)" }
        };

        // Smart Lookup Feature
        const smartLookupMap = {
            "decades": "decade",
            "predicted": "predict",
            "vehicles": "vehicle",
            "rotors": "rotor",
            "advancing": "advance",
            "advances": "advance",
            "consequences": "consequence",
            "authorities": "authority",
            "regulations": "regulation",
            "certifying": "certify",
            "collisions": "collision",
            "residents": "resident",
            "imagined": "imagine",
            "soaring": "soar",
            "batteries": "battery", // Example extension if needed
            "promised": "promise"
        };

        function getSmartLookupRoot(word) {
            return smartLookupMap[word] || word;
        }

        const articleData = [
            { en: "For decades, science fiction movies and books have promised us a future where cars fly.", zh: "幾十年來，科幻電影和書籍一直向我們承諾一個汽車會飛的未來。" },
            { en: "From the classic cartoon The Jetsons to the futuristic cities of Blade Runner, we have grown up expecting that one day we would travel through the sky instead of sitting in traffic on the ground.", zh: "從經典卡通《傑森一家》到《銀翼殺手》中的未來城市，我們在成長過程中一直期待著有一天能在天空中旅行，而不是坐在地面的車流中。" },
            { en: "People in the 1950s predicted that by the year 2000, everyone would have a flying car in their garage.", zh: "1950 年代的人們預測，到了 2000 年，每個人的車庫裡都會有一輛飛天車。" },
            { en: "The concept represented the ultimate freedom: the ability to go anywhere, anytime, without limits.", zh: "這個概念代表了終極的自由：能夠隨時隨地去任何地方，不受限制。" },
            { en: "However, the year 2000 came and went, and we are still driving on asphalt roads with four rubber tires.", zh: "然而，2000 年來了又去，我們仍然駕駛著四個橡膠輪胎的車行駛在柏油路上。" },
            { en: "This leads to a common question: Why don't we have flying cars yet?", zh: "這引出了一個常見的問題：為什麼我們還沒有飛天車？" },
            { en: "The answer is complex, involving not just technology, but also safety, laws, and the design of our cities.", zh: "答案很複雜，不僅涉及技術，還涉及安全、法律以及我們城市的設計。" },

            { en: "Technically, we are getting very close to making this dream a reality, but the vehicles do not look like the cars we drive today.", zh: "從技術上講，我們非常接近實現這個夢想，但這些交通工具看起來並不像我們今天駕駛的汽車。" },
            { en: "Engineers and companies around the world are developing a new type of aircraft called \"eVTOLs,\" which stands for Electric Vertical Take-off and Landing vehicles.", zh: "世界各地的工程師和公司正在開發一種稱為「eVTOL」的新型飛機，即「電動垂直起降」載具。" },
            { en: "Unlike traditional airplanes that need a long runway, these vehicles can go straight up into the air, much like a helicopter.", zh: "與需要長跑道的傳統飛機不同，這些載具可以像直升機一樣直接升空。" },
            { en: "However, they are quieter, cleaner, more efficient, and safer than helicopters because they use electric batteries and multiple small rotors.", zh: "然而，它們比直升機更安靜、更乾淨、更有效率且更安全，因為它們使用電池和多個小型旋翼。" },
            { en: "Companies like Joby Aviation and Archer are already testing these air taxis.", zh: "像 Joby Aviation 和 Archer 這樣的公司已經在測試這些空中計程車。" },
            { en: "They look more like giant drones than flying cars.", zh: "它們看起來更像是巨大的無人機，而不是飛天車。" },
            { en: "The goal is to create a vehicle that is easy to manufacture and cheap enough for regular people to use for their daily commute.", zh: "目標是創造一種易於製造且便宜到足以讓普通人用於日常通勤的交通工具。" },

            { en: "While the technology is advancing rapidly, safety remains the biggest obstacle.", zh: "雖然技術進步迅速，但安全仍然是最大的障礙。" },
            { en: "If a car engine fails on the road, you can simply pull over to the side.", zh: "如果汽車引擎在路上故障，你可以簡單地停在路邊。" },
            { en: "However, if a flying car fails thousands of feet in the air, the consequences could be deadly.", zh: "然而，如果飛天車在數千英尺的高空故障，後果可能是致命的。" },
            { en: "Because of this, aviation authorities like the FAA (Federal Aviation Administration) are extremely strict about regulations and certifying new aircraft.", zh: "因此，像 FAA（聯邦航空總署）這樣的航空當局對法規和認證新飛機非常嚴格。" },
            { en: "Furthermore, managing air traffic is much harder than managing road traffic.", zh: "此外，管理空中交通比管理道路交通要困難得多。" },
            { en: "Imagine thousands of flying cars zipping around a city; without a perfect system to prevent collisions, it would be chaotic.", zh: "想像一下成千上萬的飛天車在城市周圍呼嘯而過；如果沒有一個完美的系統來防止碰撞，那將會是一片混亂。" },
            { en: "This is why experts believe that flying cars will likely be \"autonomous,\" meaning they will be flown by computers and Artificial Intelligence (AI) rather than human pilots.", zh: "這就是為什麼專家認為飛天車很可能是「自動駕駛的」，意味著它們將由電腦和人工智慧 (AI) 而不是人類飛行員駕駛。" },
            { en: "Humans make mistakes, but a computer network could theoretically communicate with every other vehicle to ensure safety.", zh: "人類會犯錯，但電腦網路理論上可以與其他每一輛車通訊以確保安全。" },

            { en: "Even if the vehicles are safe, our cities are not ready for them.", zh: "即使車輛是安全的，我們的城市還沒有準備好。" },
            { en: "We need new infrastructure.", zh: "我們需要新的基礎設施。" },
            { en: "Flying cars cannot just park on the street; they need \"vertiports\"—special landing pads located on top of buildings or in open spaces.", zh: "飛天車不能隨便停在街上；它們需要「垂直起降場」——位於建築物頂部或空地上的特殊降落墊。" },
            { en: "Building these will require time, money, and careful city planning.", zh: "建造這些需要時間、金錢和仔細的城市規劃。" },
            { en: "Another major issue is noise.", zh: "另一個主要問題是噪音。" },
            { en: "Although electric motors are quieter than jet engines, the sound of thousands of rotors buzzing over a city could be very annoying for residents.", zh: "雖然電動馬達比噴氣引擎安靜，但成千上萬個旋翼在城市上空嗡嗡作響的聲音可能會讓居民感到非常煩惱。" },
            { en: "Additionally, current battery technology is a limitation.", zh: "此外，目前的電池技術也是一個限制。" },
            { en: "Batteries are heavy and do not have the capacity to hold enough energy for long trips.", zh: "電池很重，且沒有足夠的容量來儲存足夠的能量進行長途旅行。" },
            { en: "Engineers are working hard to make batteries lighter and more powerful so that these vehicles can fly longer distances without needing to recharge constantly.", zh: "工程師們正在努力使電池更輕、更強大，以便這些車輛可以飛行更長的距離而無需不斷充電。" },

            { en: "So, are we there yet?", zh: "那麼，我們到了嗎？" },
            { en: "The answer is \"almost,\" but the future will look different than what we imagined.", zh: "答案是「快了」，但未來會與我們想像的不同。" },
            { en: "We probably won't own personal flying cars parked in our driveways anytime soon.", zh: "我們可能不會很快在車道上擁有停著的個人飛天車。" },
            { en: "Instead, the future of urban air mobility will likely function like a ride-sharing service, similar to Uber or Lyft, but in the sky.", zh: "相反，城市空中交通的未來可能會像共乘服務一樣運作，類似於 Uber 或 Lyft，但在天空中。" },
            { en: "You will use an app to book a seat on an air taxi, walk to the nearest vertiport, and fly across the city in minutes, avoiding all the traffic below.", zh: "你將使用應用程式預訂空中計程車的座位，走到最近的垂直起降場，並在幾分鐘內飛越城市，避開下面所有的交通擁堵。" },
            { en: "While we might not be piloting our own vehicles through the clouds, the dream of soaring over traffic jams is becoming a reality.", zh: "雖然我們可能不會親自駕駛自己的車輛穿越雲層，但在交通擁堵上空翱翔的夢想正在成為現實。" },
            { en: "It is no longer just science fiction; it is the next revolution in human transportation.", zh: "這不再只是科幻小說；這是人類交通的下一次革命。" }
        ];

        const quizData = [
            { 
                id: 'q1', 
                q: "1. What is the main topic of the article?", 
                options: {A: "The history of science fiction movies.", B: "Why electric cars are better than gas cars.", C: "The current status and challenges of flying cars.", D: "How to become a pilot."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> The article discusses the technology, challenges, and future of flying cars.<br><br><strong>Chi:</strong> 本文討論了飛天車的技術、挑戰和未來。" 
            },
            { 
                id: 'q2', 
                q: "2. According to Paragraph 1, what did people in the 1950s predict?", 
                options: {A: "That we would live on Mars.", B: "That everyone would have a flying car by the year 2000.", C: "That cars would drive underwater.", D: "That bicycles would replace cars."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> The text says people predicted \"by the year 2000, everyone would have a flying car.\"<br><br><strong>Chi:</strong> 文中說人們預測「到了 2000 年，每個人都會有一輛飛天車」。" 
            },
            { 
                id: 'q3', 
                q: "3. What does \"eVTOL\" stand for?", 
                options: {A: "Electric Vehicle for Total Over Land travel.", B: "Extra Vertical Take-off Landing.", C: "Electric Vertical Take-off and Landing.", D: "Engine Vehicle Take-off Low."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 2 defines it as \"Electric Vertical Take-off and Landing vehicles.\"<br><br><strong>Chi:</strong> 第二段將其定義為「電動垂直起降載具」。" 
            },
            { 
                id: 'q4', 
                q: "4. How are eVTOLs different from traditional airplanes?", 
                options: {A: "They are much slower.", B: "They need a very long runway.", C: "They can go straight up into the air.", D: "They use gas instead of batteries."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 2 states they \"can go straight up into the air, much like a helicopter.\"<br><br><strong>Chi:</strong> 第二段指出它們「可以像直升機一樣直接升空」。" 
            },
            { 
                id: 'q5', 
                q: "5. Why is safety a bigger concern for flying cars than regular cars?", 
                options: {A: "Flying cars are faster.", B: "You cannot just pull over to the side if the engine fails in the air.", C: "Pilots are not as smart as drivers.", D: "The sky is too dark."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Paragraph 3 explains: \"if a flying car fails... the consequences could be deadly\" because you can't pull over.<br><br><strong>Chi:</strong> 第三段解釋：「如果飛天車故障……後果可能是致命的」，因為你無法停在路邊。" 
            },
            { 
                id: 'q6', 
                q: "6. What solution is suggested to manage the chaotic air traffic?", 
                options: {A: "Using more traffic lights in the sky.", B: "Banning all flying cars.", C: "Making vehicles autonomous (flown by AI).", D: "Only flying during the day."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 3 suggests vehicles will be \"autonomous... flown by computers and AI.\"<br><br><strong>Chi:</strong> 第三段建議車輛將是「自動駕駛的……由電腦和 AI 駕駛」。" 
            },
            { 
                id: 'q7', 
                q: "7. What infrastructure is needed for flying cars?", 
                options: {A: "Wider highways.", B: "Vertiports (landing pads).", C: "Underwater tunnels.", D: "Larger gas stations."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Paragraph 4 mentions the need for \"vertiports—special landing pads.\"<br><br><strong>Chi:</strong> 第四段提到需要「垂直起降場——特殊的降落墊」。" 
            },
            { 
                id: 'q8', 
                q: "8. What environmental issue is mentioned in Paragraph 4?", 
                options: {A: "Air pollution from smoke.", B: "Water pollution.", C: "Noise from thousands of rotors.", D: "Destruction of forests."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> The text mentions \"the sound of thousands of rotors... could be very annoying.\"<br><br><strong>Chi:</strong> 文中提到「成千上萬個旋翼的聲音……可能會讓人非常煩惱」。" 
            },
            { 
                id: 'q9', 
                q: "9. What is a limitation of current battery technology?", 
                options: {A: "They are too light.", B: "They are too expensive to recycle.", C: "They are heavy and do not hold enough energy for long trips.", D: "They explode easily."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 4 states batteries are \"heavy and do not hold enough energy.\"<br><br><strong>Chi:</strong> 第四段指出電池「很重且儲存的能量不足」。" 
            },
            { 
                id: 'q10', 
                q: "10. How does the author describe the likely future of flying cars in Paragraph 5?", 
                options: {A: "Everyone will own one.", B: "They will be used for racing only.", C: "It will be a ride-sharing service like an air taxi.", D: "They will never happen."}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 5 predicts it will \"function like a ride-sharing service... similar to Uber.\"<br><br><strong>Chi:</strong> 第五段預測它將「像共乘服務一樣運作……類似於 Uber」。" 
            },
            { 
                id: 'q11', 
                q: "11. The word \"obstacle\" in Paragraph 3 is closest in meaning to:", 
                options: {A: "Barrier or problem", B: "Helper", C: "Goal", D: "Engine"}, 
                ans: 'A', 
                expl: "<strong>Eng:</strong> An obstacle is something that blocks progress. Safety is a problem.<br><br><strong>Chi:</strong> Obstacle 是阻礙進步的事物。安全是一個問題。" 
            },
            { 
                id: 'q12', 
                q: "12. What does \"commute\" mean in Paragraph 2?", 
                options: {A: "To talk to someone.", B: "To travel between home and work.", C: "To fly an airplane.", D: "To compute numbers."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Commute refers to the daily travel to work.<br><br><strong>Chi:</strong> Commute 指的是每天上班的通勤。" 
            },
            { 
                id: 'q13', 
                q: "13. Why are experts considering autonomous flight?", 
                options: {A: "Because computers are cheaper.", B: "Because humans make mistakes.", C: "Because AI wants to fly.", D: "Because it is slower."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> Paragraph 3 says \"Humans make mistakes, but a computer network could... communicate.\"<br><br><strong>Chi:</strong> 第三段說「人類會犯錯，但電腦網路可以……通訊」。" 
            },
            { 
                id: 'q14', 
                q: "14. Which movie is mentioned as an example of futuristic expectations?", 
                options: {A: "Star Wars", B: "The Avengers", C: "Blade Runner", D: "Jurassic Park"}, 
                ans: 'C', 
                expl: "<strong>Eng:</strong> Paragraph 1 mentions \"the futuristic cities of Blade Runner.\"<br><br><strong>Chi:</strong> 第一段提到「《銀翼殺手》中的未來城市」。" 
            },
            { 
                id: 'q15', 
                q: "15. What is the overall tone of the article?", 
                options: {A: "Completely negative.", B: "Realistic and cautiously optimistic.", C: "Fantasy and dreamlike.", D: "Angry at scientists."}, 
                ans: 'B', 
                expl: "<strong>Eng:</strong> The author acknowledges challenges but believes the \"dream... is becoming a reality.\"<br><br><strong>Chi:</strong> 作者承認挑戰，但相信「夢想……正在成為現實」。" 
            }
        ];

        window.initAudioContext = function() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        window.playCorrectSound = function() {
            window.initAudioContext();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        window.playFailSound = function() {
            window.initAudioContext();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime); 
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        function initVoice() {
            const loadVoices = () => {
                const voices = synth.getVoices();
                if (voices.length > 0) {
                    selectedVoice = voices.find(v => v.name === 'Google US English') || 
                                    voices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural') && v.lang.includes('en-US')) ||
                                    voices.find(v => (v.name.includes('Siri') || v.name.includes('Enhanced') || v.name.includes('Premium')) && v.lang.includes('en-US')) ||
                                    voices.find(v => v.name === 'Samantha') || 
                                    voices.find(v => v.lang === 'en-US');
                }
            };
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        function renderArticle() {
            const displayArea = document.getElementById('article-display');
            if (!displayArea) return;
            displayArea.innerHTML = '';
            
            let p;
            sentences = []; 
            
            articleData.forEach((item, index) => {
                // Image insertion logic
                if (index === 0) insertImage(displayArea, 'p1.jpg', 'The Promise of the Future');
                else if (index === 7) insertImage(displayArea, 'p2.jpg', 'The Rise of eVTOLs');
                else if (index === 14) insertImage(displayArea, 'p3.jpg', 'Safety and Regulations');
                else if (index === 22) insertImage(displayArea, 'p4.jpg', 'Infrastructure and Environment');
                else if (index === 31) insertImage(displayArea, 'p5.jpg', 'A Different Kind of Future');
                
                if (index === 0 || index === 7 || index === 14 || index === 22 || index === 31) {
                    p = document.createElement('p');
                    p.className = "mb-10"; 
                    displayArea.appendChild(p);
                }
                
                const spanEn = document.createElement('span');
                spanEn.innerHTML = processWords(item.en);
                spanEn.id = `sent-${index}`;
                spanEn.className = 'cursor-pointer hover:bg-gray-700 rounded transition leading-loose mr-1';
                spanEn.onclick = (e) => {
                    if (e.target.classList.contains('vocab-word') || e.target.parentElement.classList.contains('vocab-word') || e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
                    window.playFromSentence(index);
                };
                
                p.appendChild(spanEn);
                sentences.push({ text: item.en, id: `sent-${index}` });

                const divZh = document.createElement('div');
                divZh.className = 'translation-text hidden';
                divZh.innerText = item.zh;
                p.appendChild(divZh);
            });
        }

        function insertImage(container, filename, altText) {
             const img = document.createElement('img');
             img.src = `English-Reading-14-images/${filename}`; 
             img.alt = altText;
             img.width = 1300;
             img.height = 576;
             img.className = "w-full md:w-5/6 h-auto object-cover rounded-xl mb-8 mx-auto shadow-md hover:opacity-95 transition border border-gray-700";
             img.onerror = function() { this.style.display = 'none'; };
             container.appendChild(img);
        }

        function processWords(text) {
            const words = text.split(' ');
            return words.map(word => {
                // Smart Lookup Regex Logic
                const cleanWord = word.replace(/^[^a-zA-Z0-9\-]+|[^a-zA-Z0-9\-]+$/g, '').toLowerCase();
                const originalWord = word;
                const rootWord = getSmartLookupRoot(cleanWord);

                if (vocabulary[rootWord]) {
                    const data = vocabulary[rootWord];
                    const isFav = favoriteWords.has(rootWord);
                    const heartClass = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
                    
                    return `<span class="vocab-word" onclick="window.speakAndShowDef(event, '${cleanWord}')">${originalWord}<span class="vocab-tooltip">
                        <div class="flex justify-between items-start mb-2">
                            <span class="pos-tag text-sm">${data.pos}</span>
                            <button onclick="window.toggleFavorite(event, '${rootWord}')" class="text-xl hover:scale-110 transition p-1" title="加入學習清單">
                                <i class="${heartClass}" id="heart-${rootWord}"></i>
                            </button>
                        </div>
                        <div class="font-bold text-violet-300 text-2xl mb-2">${rootWord}</div>
                        <div class="mb-3 text-lg font-medium">${data.trans}</div>
                        <div class="text-lg text-gray-400 italic border-t border-gray-600 pt-3 leading-relaxed">"${data.example}"<br><span class="text-sm text-gray-500 not-italic">${data.exampleZh}</span></div>
                    </span></span>`;
                }
                return originalWord;
            }).join(' ');
        }
        
        window.speakAndShowDef = function(e, wordToSpeak) {
            if(e) e.stopPropagation(); 
            synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(wordToSpeak);
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 0.9; 
            synth.speak(utterance);
        }

        window.toggleFavorite = function(e, word) {
            if(e) e.stopPropagation();
            if (favoriteWords.has(word)) {
                favoriteWords.delete(word);
                updateHeartIcon(word, false);
            } else {
                favoriteWords.add(word);
                updateHeartIcon(word, true);
                confetti({
                    particleCount: 30,
                    spread: 40,
                    origin: { x: e ? e.clientX / window.innerWidth : 0.5, y: e ? e.clientY / window.innerHeight : 0.5 },
                    colors: ['#f472b6']
                });
            }
            document.getElementById('study-list-count').innerText = `目前收藏: ${favoriteWords.size} 個單字`;
            if(document.getElementById('study-modal').style.display === 'flex') window.openStudyModal();
            if(document.getElementById('vocab-modal').style.display === 'flex') window.openVocabModal();

            window.saveUserData();
        }

        function updateHeartIcon(word, isFav) {
            const icons = document.querySelectorAll(`#heart-${word}`);
            icons.forEach(icon => {
                icon.className = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-400";
            });
            const tableIcons = document.querySelectorAll(`#heart-table-${word}`);
            tableIcons.forEach(icon => {
                icon.className = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-500";
            });
        }

        window.openVocabModal = function() {
            const container = document.getElementById('vocab-table-container');
            container.innerHTML = generateTableHTML(Object.keys(vocabulary), 'vocab');
            document.getElementById('vocab-modal').style.display = 'flex';
        }

        window.openStudyModal = function() {
            const container = document.getElementById('study-table-container');
            if (favoriteWords.size === 0) {
                container.innerHTML = `<div class="text-center py-12 text-gray-500"><i class="far fa-heart text-4xl mb-4 text-gray-600"></i><p>您的學習清單是空的。</p><p class="text-sm">在閱讀時點擊單字上的愛心圖示即可加入。</p></div>`;
            } else {
                container.innerHTML = generateTableHTML(Array.from(favoriteWords), 'study');
            }
            document.getElementById('study-modal').style.display = 'flex';
        }

        window.openMistakeModal = function() {
            const container = document.getElementById('mistake-table-container');
            if (wrongAnswers.length === 0) {
                 container.innerHTML = `<div class="text-center py-12 text-gray-500"><i class="fas fa-check-circle text-4xl mb-4 text-green-700"></i><p>太棒了！您沒有答錯任何題目。</p></div>`;
            } else {
                 let html = `
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-red-900/40 border-b border-red-800">
                                <th class="p-3 font-bold text-gray-300 w-[40%] text-xl">題目 (Question)</th>
                                <th class="p-3 font-bold text-gray-300 w-[10%] text-xl text-center">您的答案</th>
                                <th class="p-3 font-bold text-gray-300 w-[10%] text-xl text-center">正確答案</th>
                                <th class="p-3 font-bold text-gray-300 w-[40%] text-xl">詳解 (Explanation)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                `;
                wrongAnswers.forEach(item => {
                    html += `
                        <tr class="hover:bg-gray-700/50">
                            <td class="p-3 font-medium text-gray-300 text-lg">${item.q.q}</td>
                            <td class="p-3 text-red-400 font-bold text-center text-lg"><i class="fas fa-times mr-1"></i> ${item.yourAns}</td>
                            <td class="p-3 text-green-400 font-bold text-center text-lg"><i class="fas fa-check mr-1"></i> ${item.q.ans}</td>
                            <td class="p-3 text-gray-400 text-base">${item.q.expl}</td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            }
            document.getElementById('mistake-modal').style.display = 'flex';
        }

        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        }

        function generateTableHTML(wordList, type) {
            if (!wordList || wordList.length === 0) return '';
            wordList.sort();
            let html = `
                <table class="w-full text-left border-collapse text-gray-200">
                    <thead>
                        <tr class="bg-gray-700 border-b border-gray-600">
                            <th class="p-3 font-bold w-[5%] text-lg text-center">收藏</th>
                            <th class="p-3 font-bold w-[12%] text-lg">單字 (Word)</th>
                            <th class="p-3 font-bold w-[6%] text-lg">詞性</th>
                            <th class="p-3 font-bold w-[12%] text-lg">中文意思</th>
                            <th class="p-3 font-bold w-[25%] text-lg">例句與翻譯 (Example)</th>
                            <th class="p-3 font-bold w-[15%] text-lg">衍生字/家族字</th>
                            <th class="p-3 font-bold w-[25%] text-lg">常見搭配詞</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
            `;
            wordList.forEach(word => {
                const data = vocabulary[word];
                if(!data) return;
                const isFav = favoriteWords.has(word);
                const heartClass = isFav ? "fas fa-heart text-pink-500" : "far fa-heart text-gray-500";
                html += `
                    <tr class="hover:bg-gray-700/50 transition duration-150">
                        <td class="p-3 text-center"><button onclick="window.toggleFavorite(null, '${word}')" class="text-2xl focus:outline-none hover:scale-110 transition"><i class="${heartClass}" id="heart-table-${word}"></i></button></td>
                        
                        <td class="p-3 font-bold text-violet-400 text-xl md:text-2xl group">
                            ${word} <button onclick="window.speakAndShowDef(event, '${word}')" class="focus:outline-none no-print" title="點擊發音"><i class="fas fa-volume-up text-base ml-2 opacity-50 hover:opacity-100 transition text-violet-300"></i></button>
                        </td>

                        <td class="p-3 text-base md:text-lg"><span class="bg-violet-900 text-violet-200 px-3 py-1 rounded text-sm md:text-base font-bold">${data.pos}</span></td>
                        <td class="p-3 text-gray-300 text-lg md:text-xl">${data.trans}</td>
                        <td class="p-3 text-gray-400 text-lg md:text-xl italic">"${data.example}"<br><span class="text-sm text-gray-500 not-italic">${data.exampleZh}</span></td>
                        <td class="p-3 text-gray-400 text-base md:text-lg leading-relaxed">${data.family}</td>
                        <td class="p-3 text-gray-400 text-base md:text-lg leading-relaxed">${data.collocation}</td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        window.printList = function(type) {
            const printArea = document.getElementById('print-area');
            const articleTitle = "Flying Cars: Are We There Yet?";
            const dynamicSubtitle = `<h2 style="text-align: center; color: #6b7280; font-size: 18px !important; font-weight: normal; margin-top: -10px; margin-bottom: 25px;">${articleTitle}</h2>`;
            let content = '';
            
            if (type === 'mistakes') {
                content = `
                    <div style="font-family: 'Times New Roman', serif; color: black;">
                        <h1 style="text-align: center; font-size: 26px !important; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px;">
                            錯題本 (Review Mistakes)
                        </h1>
                        ${dynamicSubtitle}
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f3f4f6; -webkit-print-color-adjust: exact;">
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 40%;">Question</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: center; width: 10%;">Your Answer</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: center; width: 10%;">Correct</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 40%;">Explanation</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                if (wrongAnswers.length === 0) {
                     content += `<tr><td colspan="4" style="text-align: center; padding: 20px;">No mistakes found. Good job!</td></tr>`;
                } else {
                    wrongAnswers.forEach(item => {
                        content += `
                            <tr>
                                <td style="border: 1px solid black; padding: 8px !important;">${item.q.q}</td>
                                <td style="border: 1px solid black; padding: 8px !important; text-align: center; color: red;">${item.yourAns}</td>
                                <td style="border: 1px solid black; padding: 8px !important; text-align: center; font-weight: bold;">${item.q.ans}</td>
                                <td style="border: 1px solid black; padding: 8px !important;">${item.q.expl}</td>
                            </tr>
                        `;
                    });
                }
                content += `</tbody></table></div>`;
            } else {
                let title = type === 'vocab' ? "完整單字表 (Vocabulary List)" : "我的學習清單 (My Study List)";
                let wordList = type === 'vocab' ? Object.keys(vocabulary) : Array.from(favoriteWords);
                wordList.sort();

                content = `
                    <div style="font-family: 'Times New Roman', serif; color: black;">
                        <h1 style="text-align: center; font-size: 26px !important; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px;">
                            ${title}
                        </h1>
                        ${dynamicSubtitle}
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f3f4f6; -webkit-print-color-adjust: exact;">
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 12%;">Word</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: center; width: 6%;">POS</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 12%;">Meaning</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 35%;">Example Sentence & Translation</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 15%;">Word Family</th>
                                    <th style="border: 1px solid black; padding: 8px !important; text-align: left; width: 20%;">Collocation</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                if (wordList.length === 0) {
                     content += `<tr><td colspan="6" style="text-align: center; padding: 20px;">No words in list.</td></tr>`;
                } else {
                    wordList.forEach(word => {
                        const data = vocabulary[word];
                        content += `
                            <tr>
                                <td style="border: 1px solid black; padding: 8px !important; font-weight: bold;">${word}</td>
                                <td style="border: 1px solid black; padding: 8px !important; text-align: center;">${data.pos}</td>
                                <td style="border: 1px solid black; padding: 8px !important;">${data.trans}</td>
                                <td style="border: 1px solid black; padding: 8px !important;"><span style="font-style: italic;">${data.example}</span><br><span style="color: #4b5563; font-size: 0.9em;">${data.exampleZh}</span></td>
                                <td style="border: 1px solid black; padding: 8px !important;">${data.family}</td>
                                <td style="border: 1px solid black; padding: 8px !important;">${data.collocation}</td>
                            </tr>
                        `;
                    });
                }
                content += `</tbody></table></div>`;
            }
            
            content += `<div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">Generated by Listening Quiz: Flying Cars</div>`;
            printArea.innerHTML = content;
            window.print();
        }

        window.toggleTranslation = function() {
            showTranslation = !showTranslation;
            const transElements = document.querySelectorAll('.translation-text');
            const btn = document.getElementById('toggle-trans-btn');
            
            transElements.forEach(el => {
                if(showTranslation) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });

            if(showTranslation) {
                btn.classList.add('bg-violet-600', 'border-violet-500');
                btn.innerHTML = '<i class="fas fa-check"></i> <span>隱藏翻譯</span>';
            } else {
                btn.classList.remove('bg-violet-600', 'border-violet-500');
                btn.innerHTML = '<i class="fas fa-language"></i> <span>顯示翻譯</span>';
            }
        }

        window.togglePlay = function() {
            if (isPlaying) {
                window.pauseAudio();
            } else {
                window.playAudio();
            }
        }

        window.playAudio = function() {
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            if (currentSentenceIndex >= sentences.length) {
                currentSentenceIndex = 0;
            }
            window.speakSentence(currentSentenceIndex);
        }

        window.speakSentence = function(index) {
            if (!isPlaying || index >= sentences.length) {
                if (index >= sentences.length) {
                    isPlaying = false;
                    updatePlayBtn(false);
                    document.getElementById('visualizer').classList.remove('playing');
                    currentSentenceIndex = 0;
                    window.highlightSentence(-1);
                    currentSentenceIndex = 0;
                    window.saveUserData();
                }
                return;
            }

            currentSentenceIndex = index;
            window.highlightSentence(index);
            window.updateProgressBar();
            window.saveUserData();

            synth.cancel();

            const text = sentences[index].text;
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 1.0; 
            utterance.pitch = 1.0; 
            
            utterance.onend = function() {
                if (isPlaying) {
                    setTimeout(() => {
                        window.speakSentence(index + 1);
                    }, 400); 
                }
            };
            
            utterance.onerror = function(e) {
                console.error("Speech error", e);
                isPlaying = false;
                updatePlayBtn(false);
            };

            synth.speak(utterance);
        }

        window.pauseAudio = function() {
            isPlaying = false;
            synth.cancel();
            updatePlayBtn(false);
            document.getElementById('visualizer').classList.remove('playing');
        }

        window.restartAudio = function() {
            synth.cancel();
            currentSentenceIndex = 0;
            window.updateProgressBar();
            window.highlightSentence(-1);
            if (isPlaying) {
                setTimeout(() => window.speakSentence(0), 100);
            }
        }
        
        window.playFromSentence = function(index) {
            currentSentenceIndex = index;
            isPlaying = true;
            updatePlayBtn(true);
            document.getElementById('visualizer').classList.add('playing');
            window.speakSentence(index);
        }

        function updatePlayBtn(isPlay) {
            const icons = [document.getElementById('main-play-icon'), document.getElementById('mobile-play-icon')];
            icons.forEach(icon => {
                if (isPlay) {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                } else {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                }
            });
        }

        window.highlightSentence = function(index) {
            document.querySelectorAll('.highlight-text').forEach(el => el.classList.remove('highlight-text'));
            
            if (index >= 0 && index < sentences.length) {
                const el = document.getElementById(sentences[index].id);
                if (el) {
                    el.classList.add('highlight-text');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        window.updateProgressBar = function() {
             const progress = ((currentSentenceIndex + 1) / sentences.length) * 100;
             document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        window.toggleText = function() {
            textHidden = !textHidden;
            const overlay = document.getElementById('hidden-overlay');
            const btn = document.getElementById('toggle-text-btn');
            if (textHidden) {
                overlay.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-eye"></i> <span>Show Text</span>';
                btn.classList.replace('bg-amber-600', 'bg-violet-600');
                btn.classList.replace('hover:bg-amber-500', 'hover:bg-violet-700');
            } else {
                overlay.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> <span>Hide Text</span>';
                btn.classList.replace('bg-violet-600', 'bg-amber-600');
                btn.classList.replace('hover:bg-violet-700', 'hover:bg-amber-500');
            }
        }

        function renderQuiz() {
            const form = document.getElementById('quizForm');
            if (!form) return;
            form.innerHTML = '';
            
            quizData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-900 p-5 rounded-xl border border-gray-700 shadow-sm transition hover:border-gray-600';
                div.innerHTML = `
                    <p class="font-bold text-gray-200 mb-4 text-3xl">${item.q}</p> <!-- Updated text-3xl -->
                    <div class="space-y-3" id="${item.id}-options">
                        ${Object.keys(item.options).map(key => `
                            <label class="quiz-option flex items-center p-5 rounded-lg cursor-pointer border border-gray-700" id="${item.id}-label-${key}"> <!-- Updated p-5 -->
                                <input type="radio" name="${item.id}" value="${key}" class="hidden" onclick="window.checkAnswer('${item.id}', '${key}')">
                                <div class="w-12 h-12 text-2xl rounded-full border-2 border-gray-600 flex items-center justify-center mr-3 font-bold text-gray-400 transition-colors" id="${item.id}-icon-${key}"> <!-- Updated w-12 h-12 text-2xl -->
                                    ${key}
                                </div>
                                <span class="text-gray-300 font-medium text-2xl">${item.options[key]}</span> <!-- Updated text-2xl -->
                            </label>
                        `).join('')}
                    </div>
                    <div id="${item.id}-expl" class="explanation-box">
                        <p class="font-bold mb-1" id="${item.id}-status"></p>
                        <p>${item.expl}</p>
                    </div>
                `;
                form.appendChild(div);
            });
        }

        window.checkAnswer = function(questionId, selectedKey, isRestoring = false) {
            const questionObj = quizData.find(q => q.id === questionId);
            if (!questionObj) return;

            userAnswers[questionId] = selectedKey;

            const isCorrect = selectedKey === questionObj.ans;
            
            const selectedLabel = document.getElementById(`${questionId}-label-${selectedKey}`);
            const selectedIcon = document.getElementById(`${questionId}-icon-${selectedKey}`);
            
            if (isCorrect) {
                if(!isRestoring) window.playCorrectSound(); 
                selectedLabel.classList.add('correct');
                selectedIcon.classList.add('border-green-500', 'text-green-300', 'bg-green-900');
                selectedIcon.innerHTML = '<i class="fas fa-check"></i>';
                if(!isRestoring) userScore += (100 / 15); 
            } else {
                if(!isRestoring) window.playFailSound(); 
                selectedLabel.classList.add('wrong');
                selectedIcon.classList.add('border-red-500', 'text-red-300', 'bg-red-900');
                selectedIcon.innerHTML = '<i class="fas fa-times"></i>';
                
                const correctLabel = document.getElementById(`${questionId}-label-${questionObj.ans}`);
                const correctIcon = document.getElementById(`${questionId}-icon-${questionObj.ans}`);
                correctLabel.classList.add('correct');
                correctIcon.classList.add('border-green-500', 'text-green-300', 'bg-green-900');
                correctIcon.innerHTML = '<i class="fas fa-check"></i>';

                if(!isRestoring) wrongAnswers.push({ q: questionObj, yourAns: selectedKey });
            }

            const optionsDiv = document.getElementById(`${questionId}-options`);
            const inputs = optionsDiv.querySelectorAll('input');
            const labels = optionsDiv.querySelectorAll('label');
            
            inputs.forEach(input => input.disabled = true);
            labels.forEach(label => label.classList.add('disabled'));

            const explBox = document.getElementById(`${questionId}-expl`);
            const statusText = document.getElementById(`${questionId}-status`);
            
            explBox.style.display = 'block';
            if (isCorrect) {
                explBox.style.borderLeftColor = '#10b981';
                statusText.innerHTML = '<i class="fas fa-check-circle text-green-400"></i> Correct!';
                statusText.className = "font-bold mb-1 text-green-400 text-2xl"; // Added text-2xl
            } else {
                explBox.style.borderLeftColor = '#ef4444';
                statusText.innerHTML = `<i class="fas fa-times-circle text-red-400"></i> Incorrect. The correct answer is ${questionObj.ans}.`;
                statusText.className = "font-bold mb-1 text-red-400 text-2xl"; // Added text-2xl
            }

            if(!isRestoring) window.saveUserData();
        }

        window.showFinalScore = function() {
            const scoreDisplay = document.getElementById('final-score');
            const feedback = document.getElementById('feedback-msg');
            const resultCard = document.getElementById('score-card');
            const mistakeBtn = document.getElementById('mistake-review-btn');
            
            resultCard.classList.remove('hidden');
            let finalScore = Math.round(userScore);
            scoreDisplay.innerText = `${finalScore} / 100`;
            
            if (wrongAnswers.length > 0) {
                mistakeBtn.classList.remove('hidden');
                mistakeBtn.classList.add('flex');
            }

            if (finalScore >= 80) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#8b5cf6', '#ec4899', '#10b981', '#f59e0b']
                });
                
                if (finalScore >= 95) {
                    feedback.innerText = "Perfect! You survived the legends!";
                } else {
                    feedback.innerText = "Great job! You know your horror stories.";
                }
            } else if (finalScore >= 60) {
                feedback.innerText = "Good pass. Be careful in the dark...";
            } else {
                feedback.innerText = "Don't look behind you! Try listening again.";
            }
            
            resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', () => {
                renderArticle();
                renderQuiz();
                initVoice();
            });
        } else {
            renderArticle();
            renderQuiz();
            initVoice();
        }
    </script>
</body>
</html>